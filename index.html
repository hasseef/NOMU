<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ููุตุฉ ููู NOMU โ v3.7 (ูุฑููุงุช + ุชุณุนูุฑ ุฑุนุงูุฉ + ุฅุญุงูุงุช SLA)</title>
<style>
  :root{
    --bg:#f7fbff; --paper:#ffffff; --brand:#16a34a; --accent:#f59e0b; --ink:#0f172a; --sub:#475569;
    --muted:#f1f5f9; --border:#e2e8f0; --radius:18px; --pad:18px; --gap:14px; --gap-lg:22px;
    --shadow:0 10px 30px rgba(2,12,27,.06); --font:"Tajawal","Noto Kufi Arabic",system-ui,-apple-system,"Segoe UI",Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.7 var(--font)}
  a{color:#0ea5e9;text-decoration:none}
  header{position:sticky;top:0;z-index:40;background:#ffffffd9;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .topbar{max-width:1240px;margin:auto;padding:10px var(--pad);display:flex;align-items:center;gap:12px}
  .nomu-logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 180deg, #22c55e, #86efac, #34d399, #22c55e); box-shadow:0 6px 16px rgba(16,185,129,.25)}
  .nomu-badge b{font-size:18px}
  .left-logos{margin-inline-start:auto;display:flex;align-items:center;gap:8px}
  .pill-logo{display:flex;align-items:center;gap:8px;background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  .pill-logo img{height:28px;display:block}
  .main{max-width:1240px;margin:22px auto;display:grid;grid-template-columns:280px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
  nav .side{position:sticky;top:70px;background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
  .group h4{margin:10px 8px;color:var(--sub);font-size:13px}
  .link{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:var(--ink);border:1px solid transparent}
  .link:hover{background:var(--muted);border-color:var(--border)}
  .link.active{background:linear-gradient(180deg,#ecfdf5,#e7f9f0);border-color:#befae0}
  .content{display:grid;gap:var(--gap-lg)}
  .card{background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
  .toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#f0fdf4;color:#14532d;padding:6px 10px;border-radius:999px;font-size:12px}
  button,.btn{background:var(--brand);color:#052e1d;border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(34,197,94,.25)}
  .ghost{background:transparent;color:#0f172a;border:1px solid var(--border)}
  .grid{display:grid;gap:var(--gap)} .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:repeat(3,1fr)} .four{grid-template-columns:repeat(4,1fr)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px} th,td{text-align:right;padding:10px;background:#fcfdff} th{color:#64748b;font-size:12px}
  .pill{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;font-size:12px;margin:2px}
  .note{font-size:12px;color:#64748b}
  .form label{display:block;margin:6px 0 4px}
  .form input,.form select,.form textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:8px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer}
  .tab.active{background:#fff;border-color:#22c55e}
  .tabpanel{border:1px solid var(--border);border-radius:0 12px 12px 12px;padding:12px;background:#fff}
  .kpi{border:1px solid var(--border);border-radius:14px;padding:14px;background:#f8fffb}
  .kpi b{display:block;font-size:22px;margin-top:6px}
  .callout{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:10px}
  .danger{background:#fff1f2;border:1px solid #fecdd3}
  .files{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .filepill{display:flex;align-items:center;gap:6px;border:1px dashed #cbd5e1;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
  .warn{color:#b91c1c}
  footer{max-width:1240px;margin:24px auto 40px;color:#64748b;text-align:center;padding:0 var(--pad)}
  @media (max-width:980px){ .main{grid-template-columns:1fr} .four{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="nomu-badge">
      <div class="nomu-logo" aria-hidden="true"></div>
      <div><b>NOMU โ ููุตุฉ ููู</b><div style="font-size:12px;color:#0f766e">ููุตุฉ ูุทููุฉ ููุทูููุฉ ุงููุจูุฑุฉ</div></div>
    </div>
    <div class="left-logos">
      <!-- ุดุนุงุฑุงุช Base64 (SVG) ุชุนูู ูุจุงุดุฑุฉ -->
      <span class="pill-logo" title="Vision 2030">
        <img alt="Vision 2030" src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="140" height="36"><rect x="1" y="5" rx="12" width="138" height="26" fill="%23f1f5f9" stroke="%23cbd5e1"/><text x="70" y="24" text-anchor="middle" font-size="14" font-family="Tajawal,Arial" fill="%230f172a">Vision 2030</text></svg>'/>
      </span>
      <span class="pill-logo" title="ูุจุงุฏุฑุฉ ุชูุจูุฉ">
        <img alt="Talbiya" src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="140" height="36"><rect x="1" y="5" rx="12" width="138" height="26" fill="%23f1f5f9" stroke="%23cbd5e1"/><text x="70" y="24" text-anchor="middle" font-size="14" font-family="Tajawal,Arial" fill="%230f172a">%D9%85%D8%A8%D8%A7%D8%AF%D8%B1%D8%A9%20%D8%AA%D9%84%D8%A8%D9%8A%D8%A9</text></svg>'/>
      </span>
    </div>
  </div>
</header>

<main class="main">
  <nav>
    <div class="side">
      <div class="group">
        <h4>ุงูุชุนุงุฑูู</h4>
        <a class="link" href="#/intro">ุนู ุงูููุตุฉ</a>
        <a class="link" href="#/kpi-registry">ุณุฌู ุชุนุฑููุงุช KPI</a>
      </div>
      <div class="group">
        <h4>ุงูุญุณุงุจุงุช</h4>
        <a class="link" href="#/acc/health">ูุฒุงุฑุฉ ุงูุตุญุฉ</a>
        <a class="link" href="#/acc/clinic">ุงููุฑุงูุฒ ุงูุตุญูุฉ</a>
        <a class="link" href="#/acc/education">ูุฒุงุฑุฉ ุงูุชุนููู</a>
        <a class="link" href="#/acc/neighborhood">ูุฑุงูุฒ ุงูุฃุญูุงุก</a>
        <a class="link" href="#/acc/nonprofit">ุงูุฌูุนูุงุช</a>
        <a class="link" href="#/acc/hr">ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</a>
        <a class="link" href="#/acc/csr">ุงููุทุงุน ุงูุฎุงุต</a>
        <a class="link" href="#/acc/family">ุงูุฃุณุฑุฉ</a>
        <a class="link" href="#/acc/admin">ุงููุฌูุฉ ุงููุทููุฉ</a>
      </div>
      <div class="group">
        <h4>ุชุดุบูู</h4>
        <a class="link" href="#/dispatch">ููุฒูุน ุงูููุงุนูุฏ ุงูุฐูู</a>
        <a class="link" href="#/ops">ููุญุฉ ุชุดุบูู ุงููุฑุงูุฒ</a>
      </div>
      <div class="group">
        <h4>ุงูุงุณุชุฏุงูุฉ</h4>
        <a class="link" href="#/sponsors">ุจูุงุจุฉ ุงูุฑุนุงุฉ</a>
        <a class="link" href="#/pricing">ููุงุฆุญ ุงูุฃุณุนุงุฑ</a>
      </div>
      <div class="group">
        <h4>ุงูุฃูู ูุงูุฑุจุท</h4>
        <a class="link" href="#/sso">SSO ููุงุฐ</a>
        <a class="link" href="#/rbac">RBAC</a>
        <a class="link" href="#/config">ูุฑูุฒ ุงูุฅุนุฏุงุฏุงุช</a>
      </div>
      <div class="group">
        <h4>ุณูุงุณุงุช ููุณุงุนุฏุฉ</h4>
        <a class="link" href="#/privacy">ุณูุงุณุฉ ุงูุฎุตูุตูุฉ</a>
        <a class="link" href="#/child-protect">ุญูุงูุฉ ุงูุทูู</a>
        <a class="link" href="#/help">ูุฑูุฒ ุงููุณุงุนุฏุฉ</a>
        <a class="link" href="#/terms">ุงูุดุฑูุท ูุงูุฃุญูุงู</a>
      </div>
      <div class="group">
        <h4>ุฃุฏูุงุช</h4>
        <a class="link" href="#/export">ุชุตุฏูุฑ</a>
        <a class="link" href="#/apidocs">API Docs</a>
      </div>
    </div>
  </nav>

  <section class="content" id="view"></section>
</main>

<footer>ููู NOMU โ v3.7 (Attachments + Sponsorship Pricing & Agreement + Referrals SLA + ูู ุงูุญุณุงุจุงุช ูุงูุชุจููุจุงุช)</footer>

<script>
/* ===== Helpers ===== */
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
function route(){ const p=location.hash.slice(1)||'/intro'; $$('a.link').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===`#${p}`)); (routes[p]||intro)(); }
window.addEventListener('hashchange',route);
const downloadJSON=(name,obj)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'})); a.download=name; a.click(); };
const downloadCSV=(name,rows)=>{ const csv=rows.map(r=>r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=name; a.click(); };

/* ===== Config ===== */
const DEFAULT_CONFIG={
  sso:{ issuer:'https://nafath.example.gov.sa', authorize_url:'https://nafath.example.gov.sa/authorize', token_url:'https://nafath.example.gov.sa/token', client_id:'NOMU-CLIENT-ID', redirect_uri:'https://nomu.gov.sa/callback' },
  apis:{ nphies_base:'https://api.nphies.sa/v1', noor_base:'https://api.noor.moe.sa/v1', csr_base:'https://api.csr.sa/v1',
    internal:{ health:'/api/health', clinic:'/api/clinic', education:'/api/education', neighborhood:'/api/neighborhood', nonprofit:'/api/nonprofit', hr:'/api/hr', csr:'/api/csr', family:'/api/family', admin:'/api/admin', dispatch:'/api/dispatch' } },
  field_maps:{}
};
const loadConfig=()=>{ try{ return JSON.parse(localStorage.getItem('nomu_config')||'null') || DEFAULT_CONFIG }catch(e){ return DEFAULT_CONFIG } };
const saveConfig=(cfg)=>{ localStorage.setItem('nomu_config', JSON.stringify(cfg)); alert('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช'); };

/* ===== RBAC ===== */
let RBAC={ roles:{
  'health.practitioner':['child.read','health.write','referral.send','referral.accept','appointment.manage','kpi.view'],
  'clinic.staff':['child.read','appointment.manage','referral.accept','kpi.view'],
  'education.specialist':['child.read','education.write','referral.accept','kpi.view'],
  'neighborhood.coordinator':['program.manage','booking.manage','referral.accept','kpi.view'],
  'nonprofit.worker':['child.read','service.write','referral.accept','kpi.view'],
  'admin.national':['kpi.view','kpi.define','policy.write','audit.read'],
  'family.guardian':['child.own','consent.grant','appointment.book']
}};
const checkPerm=(role,perm,consent=true)=> (RBAC.roles[role]||[]).includes(perm) && (perm!=='child.read' || consent || role==='admin.national');

/* ===== Intro ===== */
function intro(){
  const v=$('#view');
  v.innerHTML = `
  <div class="card">
    <div class="toolbar"><h2>ุนู ููุตุฉ ููู (NOMU)</h2><span class="tag">ููุตุฉ ูุทููุฉ ููุทูููุฉ ุงููุจูุฑุฉ</span></div>
    <p>ููุตุฉ ูุทููุฉ ููุญุฏุฉ ูุฑุญูุฉ ุงูุทูู ูุงูุฃุณุฑุฉ (ุงูุญููโ6 ุณููุงุช)ุ ููุชูุงูู ุจูู ุงูุตุญุฉ ูุงูุชุนููู ูุงูุฏุนู ุงูุงุฌุชูุงุนู ุนุจุฑ ูุธุงู ุฅุญุงูุงุชุ ููุงุนูุฏุ ูุคุดุฑุงุช KPIุ ูุฑุนุงูุงุช CSR.</p>
    <div class="grid four">
      <div class="kpi"><div>ุชุบุทูุฉ ุงููุญุต ุงูููุงุฆู</div><b id="k1">โ%</b><span class="note">ูุฏู 2025: 80%</span></div>
      <div class="kpi"><div>ุงูุฌุงูุฒูุฉ ุงููุฏุฑุณูุฉ</div><b id="k2">โ%</b><span class="note">ูุฏู 2025: 75%</span></div>
      <div class="kpi"><div>ูุชูุณุท ุฒูู ุงูุฅุญุงูุฉ</div><b id="k3">โ ููู</b><span class="note">โค 7</span></div>
      <div class="kpi"><div>ุชูููู CSR</div><b id="k4">โ ุฑ.ุณ</b><span class="note">ุณููู</span></div>
    </div>
  </div>`;
}

/* ===== KPI Registry ===== */
const KPI_REGISTRY=[
  { id:'DEV_SCREEN', name:'ูุณุจุฉ ุชุบุทูุฉ ุงููุญุต ุงูููุงุฆู', owner:'ูุฒุงุฑุฉ ุงูุตุญุฉ', formula:'ุงูููุญูุตูู รท ุงููุณุชูุฏููู ร100', period:'ุดูุฑู', source:'HealthAssessment' },
  { id:'SCHOOL_READY', name:'ูุณุจุฉ ุงูุฌุงูุฒูุฉ ุงููุฏุฑุณูุฉ', owner:'ูุฒุงุฑุฉ ุงูุชุนููู', formula:'ุฌุงูุฒูู รท ุฅุฌูุงูู 5โ6 ร100', period:'ูุตูู', source:'EducationPlan' },
  { id:'REF_TTR', name:'ุฒูู ุงูุฅุญุงูุฉ (ููู)', owner:'ุงููุฌูุฉ ุงููุทููุฉ', formula:'ูุชูุณุท (ูุจูู โ ูุชุญ)', period:'ุดูุฑู', source:'Referral' },
  { id:'WAIT', name:'ูุชูุณุท ุงูุชุธุงุฑ ุงูุฎุฏูุฉ', owner:'ุงูุฌูุฉ ุงูููุฏูููุฉ', formula:'ูุชูุณุท (ุฃูู ุฌูุณุฉ โ ุงููุจูู)', period:'ุดูุฑู', source:'ServiceSession' },
  { id:'CSR_FUNDS', name:'ุชูููู CSR', owner:'ุงููุทุงุน ุงูุฎุงุต + ุงูููุตุฉ', formula:'ุงูุชุนูุฏุงุช ุงููุคูุฏุฉ + ุงููุญููู', period:'ุฑุจุน ุณููู', source:'CSRCommitment' },
  { id:'ACTIVE_REF', name:'ุงูุฅุญุงูุงุช ุงููุดุทุฉ', owner:'ุงููุฌูุฉ ุงููุทููุฉ', formula:'ุงูููุชูุญุฉ โ ุงููุบููุฉ', period:'ูููู', source:'Referral' }
];
function kpiRegistryPage(){
  const v=$('#view');
  v.innerHTML=`
  <div class="card">
    <div class="toolbar"><h2>ุณุฌู ุชุนุฑููุงุช ุงููุคุดุฑุงุช ุงููุทููุฉ (KPI)</h2><button class="ghost" id="dl">ุชูุฒูู JSON</button></div>
    <table><thead><tr><th>ุงููุคุดุฑ</th><th>ุงููุงูู</th><th>ุงูุตูุบุฉ</th><th>ุงููุชุฑุฉ</th><th>ุงููุตุฏุฑ</th></tr></thead>
      <tbody>${KPI_REGISTRY.map(k=>`<tr><td><b>${k.name}</b><div class='note'>${k.id}</div></td><td>${k.owner}</td><td>${k.formula}</td><td>${k.period}</td><td>${k.source}</td></tr>`).join('')}</tbody>
    </table>
  </div>`;
  $('#dl').onclick=()=>downloadJSON('kpi_registry.json', KPI_REGISTRY);
}

/* ===== ุจูุงูุงุช ุงููุฑุงูุฒ + ุฎูุงุฑุฒููุฉ ุชูุฒูุน ===== */
const CENTERS=[
  { id:'CLN-001', name:'ูุฑูุฒ ุตุญู ุญู ุงูุงุฒุฏูุงุฑ', type:'clinic', region:'ุงูุฑูุงุถ', specialty:['ููุงุฆู','ุชุฎุงุทุจ'], capacityDay:24, bookedToday:8, avgVisitMin:30, slaDays:7 },
  { id:'CLN-002', name:'ูุฑูุฒ ุตุญู ุญู ุงูุดุงุทุฆ', type:'clinic', region:'ุงูุดุฑููุฉ', specialty:['ููุงุฆู','ูุธููู'], capacityDay:18, bookedToday:15, avgVisitMin:40, slaDays:5 },
  { id:'NHB-101', name:'ูุฑูุฒ ุญู ุงูุชุนุงูู', type:'neighborhood', region:'ุงูุฑูุงุถ', specialty:['ุชูุนูุฉ','ูุฑุฒ ุฃููู'], capacityDay:40, bookedToday:10, avgVisitMin:20, slaDays:3 },
  { id:'NHB-102', name:'ูุฑูุฒ ุญู ุงูุนููุง', type:'neighborhood', region:'ุงูุฑูุงุถ', specialty:['ุชูุนูุฉ','ูุฑุฒ ุฃููู'], capacityDay:35, bookedToday:34, avgVisitMin:20, slaDays:3 },
  { id:'NGO-501', name:'ุฌูุนูุฉ ููุงุก ุงูุทูููุฉ', type:'nonprofit', region:'ุงูุฑูุงุถ', specialty:['ุชุฏุฎู ูุจูุฑ','ุชุฎุงุทุจ'], capacityDay:22, bookedToday:6, avgVisitMin:45, slaDays:10 }
];
const QUEUE=[]; // ุงูุชุธุงุฑ ุงูููุงุนูุฏ

const occPct=c=>Math.round((c.bookedToday / Math.max(1,c.capacityDay))*100);
const estWaitDays=c=>{ const overflow=Math.max(0, c.bookedToday - c.capacityDay); return overflow>0 ? Math.ceil(overflow / Math.max(1,c.capacityDay)) : 0; };
function pickCenter({region, need, maxSlaDays=14}){
  const candidates = CENTERS.filter(c=> (c.region===region) && (need==='ูุฑุฒ ุฃููู' ? true : c.specialty.includes(need)));
  if(!candidates.length) return null;
  const scored = candidates.map(c=>{
    const occ = c.bookedToday / Math.max(1,c.capacityDay);
    const occScore = 1 - Math.min(1,occ);
    const slaScore = Math.max(0, (maxSlaDays - c.slaDays)/maxSlaDays);
    return {c, score: occScore*0.6 + slaScore*0.4};
  }).sort((a,b)=>b.score-a.score);
  return scored[0]?.c || null;
}

/* ===== ููููู ุงููุฑููุงุช (ูุดุชุฑู) ===== */
function attachmentWidget(targetSelector){
  const host=$(targetSelector);
  host.innerHTML = `
    <div class="form">
      <label>ุฅุฑูุงู ูููุงุช<input type="file" id="fup" multiple/></label>
    </div>
    <div class="files" id="flist"></div>
  `;
  const list=$('#flist',host);
  $('#fup',host).addEventListener('change', (e)=>{
    const files=[...e.target.files];
    files.forEach(f=>{
      const pill=document.createElement('span');
      pill.className='filepill';
      pill.innerHTML=`๐ ${f.name} โข ${(f.size/1024).toFixed(1)} KB <a href="#" data-dl>ุชูุฒูู</a>`;
      pill.querySelector('[data-dl]').onclick=(ev)=>{ ev.preventDefault(); const a=document.createElement('a'); a.href=URL.createObjectURL(f); a.download=f.name; a.click(); };
      list.appendChild(pill);
    });
  });
}

/* ===== ููุฒูุน ุงูููุงุนูุฏ ุงูุฐูู ===== */
function dispatchPage(){
  const v=$('#view');
  v.innerHTML = `
  <div class="card">
    <div class="toolbar"><h2>ุงูููุฒูุน ุงูุฐูู ููููุงุนูุฏ</h2><span class="tag">ุชูุฒูุน ุญุณุจ ุงูููุทูุฉ/ุงูุชุฎุตุต/ุงูุฅุดุบุงู/SLA</span></div>
    <div class="grid two form">
      <label>ูููุฉ ุงูุทูู<input id="childId" placeholder="Child-XXXX"/></label>
      <label>ุงูููุทูุฉ
        <select id="region"><option>ุงูุฑูุงุถ</option><option>ุงูุดุฑููุฉ</option></select>
      </label>
      <label>ุงูุญุงุฌุฉ
        <select id="need"><option>ููุงุฆู</option><option>ุชุฎุงุทุจ</option><option>ูุธููู</option><option>ูุฑุฒ ุฃููู</option></select>
      </label>
      <label>ุงูุฃููููุฉ
        <select id="priority"><option>ุนุงุฏูุฉ</option><option>ุนุงุฌูุฉ</option></select>
      </label>
      <label>SLA ุงูุฃูุตู (ููู)<input id="sla" type="number" value="14"/></label>
      <label>ุงูุฏูุฑ (RBAC)
        <select id="role"><option>clinic.staff</option><option>health.practitioner</option><option>neighborhood.coordinator</option><option>admin.national</option></select>
      </label>
    </div>
    <div style="margin-top:8px">
      <button class="btn" id="allocate">ุชูุฒูุน ุฐูู</button>
      <button class="ghost" id="exportQueue">ุชุตุฏูุฑ CSV</button>
    </div>
    <pre id="out" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre>
  </div>
  <div class="card">
    <div class="toolbar"><h3>ุงูุทูุจุงุช/ุงูุงูุชุธุงุฑ</h3><span class="tag">ูุงุฆูุฉ ุฏููุงููููุฉ</span></div>
    <div id="queueList"></div>
  </div>`;
  const renderQueue=()=>{
    if(!QUEUE.length){ $('#queueList').innerHTML = '<div class="note">ูุง ุชูุฌุฏ ุทูุจุงุช ุจุนุฏ.</div>'; return; }
    $('#queueList').innerHTML = `
      <table><thead><tr><th>Request</th><th>ุงูููุทูุฉ</th><th>ุงูุญุงุฌุฉ</th><th>ุงูุฃููููุฉ</th><th>ุงููุฑูุฒ</th><th>ุงูุญุงูุฉ</th></tr></thead>
      <tbody>${QUEUE.map(q=>`<tr>
        <td>${q.reqId}</td><td>${q.region}</td><td>${q.need}</td><td>${q.priority}</td>
        <td>${q.assignedTo? q.assignedTo.name+' ('+q.assignedTo.id+')':'โ'}</td><td>${q.status}</td>
      </tr>`).join('')}</tbody></table>`;
  };
  renderQueue();

  $('#allocate').onclick=()=>{
    const role=$('#role').value;
    if(!checkPerm(role,'appointment.manage')){ $('#out').textContent='โ ูุง ุชููู ุตูุงุญูุฉ ุญุฌุฒ/ุชูุฒูุน (appointment.manage).'; return; }
    const req={
      reqId:'REQ-'+Math.random().toString(36).slice(2,8).toUpperCase(),
      childId:$('#childId').value || 'Child-โ',
      region:$('#region').value, need:$('#need').value, priority:$('#priority').value,
      slaDays: parseInt($('#sla').value,10)||14, status:'ุฌุฏูุฏ'
    };
    const target = pickCenter(req);
    if(target){
      if(occPct(target)<100){
        target.bookedToday += 1;
        req.assignedTo = target; req.status = 'ูุญุฌูุฒ ุงูููู';
        $('#out').textContent = `โ ุชู ุงูุญุฌุฒ ูุฏู: ${target.name} โ ุฅุดุบุงู ุงูุขู: ${occPct(target)}% โข ุงูุชุธุงุฑ ุชูุฏูุฑู: ${estWaitDays(target)} ููู`;
      }else{
        req.assignedTo = target; req.status = 'ุงูุชุธุงุฑ ุจุงููุฑูุฒ';
        $('#out').textContent = `โ ุงููุฑูุฒ ููุชูุฆ ุงูููู โ ุงูุชุธุงุฑ ูุฏู: ${target.name} โข ุชูุฏูุฑ: ${estWaitDays(target)} ููู`;
      }
    }else{
      req.status = 'ุงูุชุธุงุฑ ุนุงู (ูุง ููุฌุฏ ูุฑูุฒ ูุทุงุจู)';
      $('#out').textContent = 'โ๏ธ ูุง ููุฌุฏ ูุฑูุฒ ููุงุณุจ โ ุชูุช ุฅุถุงูุฉ ุงูุทูุจ ููุงูุชุธุงุฑ ุงูุนุงู.';
    }
    QUEUE.unshift(req);
    renderQueue();
  };

  $('#exportQueue').onclick=()=>{
    const rows=[['reqId','childId','region','need','priority','assignedCenterId','assignedCenterName','status']];
    QUEUE.forEach(q=>rows.push([q.reqId,q.childId,q.region,q.need,q.priority,q.assignedTo?.id||'',q.assignedTo?.name||'',q.status]));
    downloadCSV('dispatch_queue.csv',rows);
  };
}

/* ===== ููุญุฉ ุชุดุบูู ุงููุฑุงูุฒ ===== */
function opsPage(){
  const v=$('#view');
  const cards = CENTERS.map(c=>`
    <div class="card">
      <div class="toolbar"><h3>${c.name}</h3><span class="tag">${c.type}</span></div>
      <div class="grid two">
        <div class="kpi"><div>ุงูุฅุดุบุงู</div><b>${occPct(c)}%</b><span class="note">ุงูููู โข ุณุนุฉ ${c.capacityDay}</span></div>
        <div class="kpi"><div>ุงูุชุธุงุฑ ุชูุฏูุฑู</div><b>${estWaitDays(c)} ููู</b><span class="note">SLA: ${c.slaDays} ุฃูุงู</span></div>
      </div>
      <div class="note">ุงูุชุฎุตุตุงุช: ${c.specialty.join('ุ ')} โข ุงูููุทูุฉ: ${c.region}</div>
    </div>
  `).join('');
  v.innerHTML = `
    <div class="card">
      <div class="toolbar"><h2>ููุญุฉ ุชุดุบูู ุงููุฑุงูุฒ</h2><span class="tag">ุงูุทุงูุฉ ุงูุงุณุชูุนุงุจูุฉ ูุงููSLA</span></div>
      <div class="grid two">${cards}</div>
    </div>
    <div class="card danger">
      <b>ุชูุตูุฉ ุชุดุบูููุฉ:</b>
      <p>ูููุฐุฌ <u>ูุฌูู</u>: ุงููุฑุงูุฒ ุงูุตุญูุฉ ููุญุฌุฒ ุงูุณุฑูุฑู ูุงูุชุฏุฎู ุงููุชุฎุตูุตุ ูุฑุงูุฒ ุงูุฃุญูุงุก ูููุฑุฒ ุงูุฃููู ูุงูุจุฑุงูุฌ ุงููุฌุชูุนูุฉ ุจุฅุดุฑุงู ููู. ูููู ุถุบุท ุงูุชูุธูู ุงูุญูููู ุนุจุฑ ุงูุชุนุงูุฏ ูุน ุงูุฌูุนูุงุช ูุงูุงุณุชุดุงุฑุงุช ุนู ุจูุนุฏ.</p>
    </div>`;
}

/* ===== ุงูุญุณุงุจุงุช: ุชุจููุจุงุช ูุฑูุน ูุฑููุงุช ูุฅุญุงูุงุช SLA ===== */
const ACCOUNTS={
  health:{ title:'ูุฒุงุฑุฉ ุงูุตุญุฉ', menus:['ุณุฌู ุงููุญูุต','ุงูุชุฏุฎู ุงููุจูุฑ','ุงูุฅุญุงูุงุช','ุงูููุงุนูุฏ','ูุทุงูุจุงุช NPHIES','ุชูุงุฑูุฑ','ูุฑููุงุช'], fieldsByTab:{
      'ุณุฌู ุงููุญูุต':[
        {label:'MRN',key:'mrn'},{label:'ูุชูุฌุฉ ุงููุญุต ุงูููุงุฆู',key:'dev_result'},{label:'PHQ-2/9',key:'phq_score'},{label:'ICD-10',key:'icd10'}
      ],
      'ุงูุชุฏุฎู ุงููุจูุฑ':[
        {label:'ููุน ุงูุชุฏุฎู',key:'intervention_type'},{label:'ุนุฏุฏ ุงูุฌูุณุงุช',key:'sessions'},{label:'ููุนุฏ ุงููุชุงุจุนุฉ',key:'followup_date'}
      ],
      'ุงูุฅุญุงูุงุช':[
        {label:'ุชุงุฑูุฎ ูุชุญ ุงูุญุงูุฉ',key:'opened_at',type:'date'},{label:'ุฌูุฉ ุงูุฅุญุงูุฉ',key:'ref_to'},{label:'ุฃููููุฉ',key:'priority'},{label:'SLA (ููู)',key:'sla',type:'number',value:7}
      ],
      'ุงูููุงุนูุฏ':[
        {label:'ูููุฉ ุงูุทูู',key:'childId'},{label:'ุงูููุทูุฉ',key:'region'},{label:'ุงูุญุงุฌุฉ',key:'need'},{label:'ุฃููููุฉ',key:'prio'}
      ],
      'ูุทุงูุจุงุช NPHIES':[
        {label:'ุฑูู ุงููุทุงูุจุฉ',key:'claim_id'},{label:'ุงูุญุงูุฉ',key:'claim_status'}
      ],
      'ุชูุงุฑูุฑ':[],
      'ูุฑููุงุช':[] }, adapter:'/api/health' },
  clinic:{ title:'ุงููุฑุงูุฒ ุงูุตุญูุฉ', menus:['ุงูููุงุนูุฏ','ุงูุฅุญุงูุงุช','ุงูุฎุฏูุงุช','ุงููุฎุฒูู','ุงูุชูุงุฑูุฑ','ูุฑููุงุช'], fieldsByTab:{
      'ุงูููุงุนูุฏ':[ {label:'ุณุฌู ุงูุทูู',key:'mrn'},{label:'ุงูุชุฎุตุต',key:'specialty'},{label:'ููุนุฏ (ุชุงุฑูุฎ/ุณุงุนุฉ)',key:'appt_datetime'} ],
      'ุงูุฅุญุงูุงุช':[ {label:'ูู ุฌูุฉ',key:'ref_from'},{label:'ุญุงูุฉ ุงูุฅุญุงูุฉ',key:'ref_status'},{label:'ุชุงุฑูุฎ ุงููุจูู',key:'accepted_at',type:'date'} ],
      'ุงูุฎุฏูุงุช':[ {label:'ุงุณู ุงูุฎุฏูุฉ',key:'service'},{label:'SLA ุฃูุงู',key:'sla_days'} ],
      'ุงููุฎุฒูู':[ {label:'ูุนุฏุงุช/ุฃุฏูุงุช',key:'inventory_item'},{label:'ุงููููุฉ',key:'qty'} ],
      'ุงูุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[] }, adapter:'/api/clinic' },
  education:{ title:'ูุฒุงุฑุฉ ุงูุชุนููู', menus:['ุฌุงูุฒูุฉ ุงููุฏุฑุณุฉ','IEP/ุฏูุฌ','ุงูุฅุญุงูุงุช','ุชูุงุตู ุงูุฃุณุฑุฉ','ุชูุงุฑูุฑ ููุฑ','ูุฑููุงุช'], fieldsByTab:{
      'ุฌุงูุฒูุฉ ุงููุฏุฑุณุฉ':[ {label:'ุฏุฑุฌุฉ ุงูุฌุงูุฒูุฉ',key:'readiness_score'},{label:'ุงููุฏุฑุณุฉ',key:'school_name'} ],
      'IEP/ุฏูุฌ':[ {label:'IEP JSON',key:'iep_json'},{label:'ููุน ุงูุฏูุฌ',key:'inclusion_type'} ],
      'ุงูุฅุญุงูุงุช':[ {label:'ุชุงุฑูุฎ ูุชุญ',key:'opened_at',type:'date'},{label:'ุฅูู ุฌูุฉ',key:'ref_to'},{label:'SLA (ููู)',key:'sla',type:'number',value:10} ],
      'ุชูุงุตู ุงูุฃุณุฑุฉ':[ {label:'ูููุฉ ููู ุงูุฃูุฑ',key:'guardian_id'},{label:'ุงูููุงุฉ',key:'channel'} ],
      'ุชูุงุฑูุฑ ููุฑ':[], 'ูุฑููุงุช':[] }, adapter:'/api/education' },
  neighborhood:{ title:'ูุฑุงูุฒ ุงูุฃุญูุงุก', menus:['ุงูุจุฑุงูุฌ','ุงููุชุทูุนูู','ุงูุญุฌูุฒุงุช','ุงูุฅุญุงูุงุช','ุงูุชูุงุฑูุฑ','ูุฑููุงุช'], fieldsByTab:{
      'ุงูุจุฑุงูุฌ':[ {label:'ุงุณู ุงูุจุฑูุงูุฌ',key:'program'},{label:'ุงููุฆุฉ ุงูุนูุฑูุฉ',key:'age_band'},{label:'ุงูุทุงูุฉ ุงูุงุณุชูุนุงุจูุฉ',key:'capacity'} ],
      'ุงููุชุทูุนูู':[ {label:'ุงุณู ุงููุชุทูุน',key:'vol_name'},{label:'ุณุงุนุงุช ุงูุชุทูุน',key:'vol_hours'} ],
      'ุงูุญุฌูุฒุงุช':[ {label:'ุชุงุฑูุฎ',key:'date'},{label:'ุนุฏุฏ ุงูููุงุนุฏ',key:'seats'} ],
      'ุงูุฅุญุงูุงุช':[ {label:'ูู/ุฅูู',key:'ref_direction'},{label:'ุงูุญุงูุฉ',key:'status'} ],
      'ุงูุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[] }, adapter:'/api/neighborhood' },
  nonprofit:{ title:'ุงูุฌูุนูุงุช', menus:['ุงูุจุฑุงูุฌ','ุงููุณุชููุฏูู','ุงููุชุทูุนูู','ุงูุฅุญุงูุงุช','ููุงุณ ุงูุฃุซุฑ','ุงูุชูุงุฑูุฑ','ูุฑููุงุช'], fieldsByTab:{
      'ุงูุจุฑุงูุฌ':[ {label:'ุงุณู ุงูุจุฑูุงูุฌ',key:'program'},{label:'ุนุฏุฏ ุงูุฌูุณุงุช',key:'sessions'} ],
      'ุงููุณุชููุฏูู':[ {label:'ูููุฉ ููู ุงูุฃูุฑ',key:'guardian_id'},{label:'ุงูููุทูุฉ',key:'region'} ],
      'ุงููุชุทูุนูู':[ {label:'ุงุณู ุงููุชุทูุน',key:'vol_name'},{label:'ุณุงุนุงุช ุงูุชุทูุน',key:'hours'} ],
      'ุงูุฅุญุงูุงุช':[ {label:'ุฅูู ุฌูุฉ',key:'ref_to'},{label:'ุงูุญุงูุฉ',key:'status'} ],
      'ููุงุณ ุงูุฃุซุฑ':[ {label:'ุชุญุณู ุงูุทูู (%)',key:'improve_pct'} ],
      'ุงูุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[] }, adapter:'/api/nonprofit' },
  hr:{ title:'ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ', menus:['ูุญูุธุฉ ุงูุฏุนู','ุงูุชุทูุน ุงููุทูู','ุงูุชูุงุฑูุฑ','ูุฑููุงุช'], fieldsByTab:{
      'ูุญูุธุฉ ุงูุฏุนู':[ {label:'ููุน ุงูุฏุนู',key:'support_type'},{label:'ุงููุจูุบ/ุงูุดูุฑ',key:'amount'},{label:'ุฃูููุฉ ุงูุฃุณุฑุฉ',key:'eligibility'} ],
      'ุงูุชุทูุน ุงููุทูู':[ {label:'ุงููุจุงุฏุฑุฉ',key:'initiative'},{label:'ุงูุณุงุนุงุช',key:'hours'} ],
      'ุงูุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[] }, adapter:'/api/hr' },
  csr:{ title:'ุงููุทุงุน ุงูุฎุงุต (CSR)', menus:['ุณูู ุงูุฑุนุงูุฉ','ุชุนูุฏุงุช ุงูุดุฑูุฉ','ุชูุงุฑูุฑ ุงูุฃุซุฑ','ุญูููุฉ CSR','ูุฑููุงุช'], fieldsByTab:{
      'ุณูู ุงูุฑุนุงูุฉ':[ {label:'ุงุณู ุงูุดุฑูุฉ',key:'company'},{label:'ุงููุฆุฉ',key:'tier'},{label:'ุงูููุทูุฉ',key:'region'} ],
      'ุชุนูุฏุงุช ุงูุดุฑูุฉ':[ {label:'ูููุฉ ุงูุชุนูุฏ',key:'amount'},{label:'ุงูุบุฑุถ',key:'purpose'} ],
      'ุชูุงุฑูุฑ ุงูุฃุซุฑ':[], 'ุญูููุฉ CSR':[], 'ูุฑููุงุช':[] }, adapter:'/api/csr' },
  family:{ title:'ุญุณุงุจ ุงูุฃุณุฑุฉ', menus:['ููู ุงูุญูู ูุงูุทูู','ุงูููุงุนูุฏ','ุงูุชูุตูุงุช','ุงูุฎุฏูุงุช ุงููุณุงูุฏุฉ','ูุฑููุงุช'], fieldsByTab:{
      'ููู ุงูุญูู ูุงูุทูู':[ {label:'ูููุฉ ููู ุงูุฃูุฑ',key:'guardian_id'},{label:'ุงูููุทูุฉ',key:'region'},{label:'ููุงููุฉ ูุดุงุฑูุฉ ุงูุจูุงูุงุช',key:'consent'} ],
      'ุงูููุงุนูุฏ':[ {label:'ุงูุฎุฏูุฉ',key:'service'},{label:'ููุนุฏ',key:'date'} ],
      'ุงูุชูุตูุงุช':[], 'ุงูุฎุฏูุงุช ุงููุณุงูุฏุฉ':[], 'ูุฑููุงุช':[] }, adapter:'/api/family' },
  admin:{ title:'ุงููุฌูุฉ ุงููุทููุฉ', menus:['ููุญุฉ ูุทููุฉ','ุญูููุฉ ุงูุจูุงูุงุช','ุงูุชูุงููุงุช','ุงูุฅุดุฑุงู ุนูู ุงูุฅุญุงูุงุช','ุงูุชูุงุฑูุฑ ุงููุทููุฉ','ูุฑููุงุช'], fieldsByTab:{
      'ููุญุฉ ูุทููุฉ':[],
      'ุญูููุฉ ุงูุจูุงูุงุช':[ {label:'ูุฑุงุฑ ุณูุงุณุฉ',key:'policy_decision'} ],
      'ุงูุชูุงููุงุช':[ {label:'ุชุนุฑูู KPI',key:'kpi_def'} ],
      'ุงูุฅุดุฑุงู ุนูู ุงูุฅุญุงูุงุช':[ {label:'SLA ุงูุชุฑุงุถู (ููู)',key:'sla_default',type:'number',value:7} ],
      'ุงูุชูุงุฑูุฑ ุงููุทููุฉ':[], 'ูุฑููุงุช':[] }, adapter:'/api/admin' }
};

function accountPage(key){
  const A=ACCOUNTS[key]; const v=$('#view');
  const tabs = A.menus;
  const tabButtons = tabs.map((t,i)=>`<button class="tab ${i===0?'active':''}" data-tab="${t}">${t}</button>`).join('');
  v.innerHTML = `
    <div class="card">
      <div class="toolbar"><h2>${A.title}</h2><span class="tag">ููุงุฆู ุชุจููุจูุฉ ุชูุงุนููุฉ + ูุฑููุงุช</span></div>
      <div class="tabs">${tabButtons}</div>
      <div id="tabpanel" class="tabpanel"></div>
      <div style="margin-top:10px">
        <button class="btn" id="save">ุญูุธ (ุชูุถูุญู)</button>
        <button class="ghost" id="push">ุฅุฑุณุงู ูููุงุฌูุฉ ุงูุจุฑูุฌูุฉ</button>
      </div>
      <div class="note" style="margin-top:8px">ูุณุงุฑ ุงูุฑุจุท: <code>${loadConfig().apis.internal[key]||A.adapter}</code></div>
    </div>`;
  const renderTab=(name)=>{
    const fields = A.fieldsByTab[name]||[];
    const fieldsHtml = fields.length ? `<div class="form grid two">
      ${fields.map(f=>{
        const type=f.type||'text'; const val=f.value!=null?`value="${f.value}"`:'';
        return `<label>${f.label}<input ${val} type="${type}" data-key="${f.key}" placeholder="${f.key}"/></label>`;
      }).join('')}
    </div>` : `<div class="note">ูุง ุชูุฌุฏ ุญููู ููุฐุง ุงููุณู ุญุงูููุง.</div>`;

    const extras = [];
    if(name==='ุงูููุงุนูุฏ'){
      extras.push(`<div style="margin-top:8px"><button class="btn" id="smartAssign">ุชูุฒูุน ุฐูู (RBAC)</button></div>
      <pre id="smartOut" class="callout" style="white-space:pre-wrap;margin-top:8px"></pre>`);
    }
    if(name==='ุงูุฅุญุงูุงุช'){
      extras.push(`<div class="callout" style="margin-top:8px">
        <b>ุณูุฑ ุฅุฌุฑุงุกุงุช ุงูุฅุญุงูุฉ:</b>
        <div class="grid two form" style="margin-top:6px">
          <label>ุชุงุฑูุฎ ูุชุญ<input id="rf_open" type="date"/></label>
          <label>ุชุงุฑูุฎ ุงููุจูู<input id="rf_accept" type="date"/></label>
        </div>
        <div style="margin-top:8px">
          <button class="btn" id="rf_send">ุฅุฑุณุงู ุฅุญุงูุฉ</button>
          <button class="ghost" id="rf_accept_btn">ูุจูู</button>
          <button class="ghost" id="rf_reject_btn">ุฑูุถ</button>
        </div>
        <div id="rf_sla_note" class="note" style="margin-top:8px"></div>
      </div>`);
    }
    if(name==='ูุฑููุงุช'){
      extras.push(`<div id="attachHost"></div>`);
    }

    $('#tabpanel').innerHTML = fieldsHtml + extras.join('');

    // ุชูุนูู ุงููุฑููุงุช
    if(name==='ูุฑููุงุช'){ attachmentWidget('#attachHost'); }

    // ุชูุนูู ุชูุฒูุน ุฐูู
    if(name==='ุงูููุงุนูุฏ' && $('#smartAssign')){
      $('#smartAssign').onclick=()=>{
        const region=$('#tabpanel [data-key="region"]')?.value||'ุงูุฑูุงุถ';
        const need=$('#tabpanel [data-key="need"]')?.value||$('#tabpanel [data-key="service"]')?.value||'ููุงุฆู';
        const role='clinic.staff';
        if(!checkPerm(role,'appointment.manage')){ $('#smartOut').textContent='โ ูุง ุชููู ุตูุงุญูุฉ ุงูุญุฌุฒ.'; return; }
        const target = pickCenter({region, need, maxSlaDays:14});
        if(target){
          if(occPct(target)<100){ target.bookedToday += 1; $('#smartOut').textContent = `โ ุญูุฌูุฒ ูู ${target.name} โ ุฅุดุบุงู: ${occPct(target)}%`; }
          else { $('#smartOut').textContent = `โ ุงูุชูุงุก ุงูููู โ ุงูุชุธุงุฑ ูู ${target.name} (ุชูุฏูุฑ ${estWaitDays(target)} ููู)`; }
        }else{ $('#smartOut').textContent = 'โ๏ธ ูุง ููุฌุฏ ูุฑูุฒ ููุงุณุจ.'; }
      };
    }

    // ุชูุนูู ุงูุฅุญุงูุงุช ูุน SLA
    if(name==='ุงูุฅุญุงูุงุช'){
      const slaInput = $('#tabpanel [data-key="sla"]');
      const openedInput = $('#rf_open'); const acceptedInput=$('#rf_accept');

      const calcSLA=()=>{
        const opened = new Date(openedInput.value);
        const accepted = new Date(acceptedInput.value||new Date().toISOString().slice(0,10));
        if(!openedInput.value) return '';
        const ms=accepted - opened; const days = Math.ceil(ms/86400000);
        const sla = parseInt(slaInput?.value || 7,10);
        const status = days>sla ? `โ ุชุฌุงูุฒ SLA (${days} ููู > ${sla})` : `โ ุถูู SLA (${days}/${sla} ููู)`;
        return `<b>ูุชุงุจุนุฉ SLA:</b> ${status}`;
      };
      const renderNote=()=>{ $('#rf_sla_note').innerHTML = calcSLA(); };
      openedInput.onchange=renderNote; acceptedInput.onchange=renderNote; if(slaInput) slaInput.oninput=renderNote;

      $('#rf_send').onclick=()=>{ if(!checkPerm('health.practitioner','referral.send')){ alert('โ ูุง ุชููู ุตูุงุญูุฉ ุฅุฑุณุงู ุงูุฅุญุงูุฉ'); return; } alert('โ ุชู ุฅุฑุณุงู ุงูุฅุญุงูุฉ (ุชูุถูุญู).'); };
      $('#rf_accept_btn').onclick=()=>{ if(!checkPerm('clinic.staff','referral.accept')){ alert('โ ูุง ุชููู ุตูุงุญูุฉ ูุจูู ุงูุฅุญุงูุฉ'); return; } if(!acceptedInput.value){ acceptedInput.value=new Date().toISOString().slice(0,10); } renderNote(); alert('โ ุชู ูุจูู ุงูุฅุญุงูุฉ (ุชูุถูุญู).'); };
      $('#rf_reject_btn').onclick=()=>{ alert('ุชู ุฑูุถ ุงูุฅุญุงูุฉ (ุชูุถูุญู).'); };
    }
  };

  renderTab(tabs[0]);
  $$('.tab',v).forEach(btn=>btn.onclick=(e)=>{ $$('.tab',v).forEach(b=>b.classList.remove('active')); e.currentTarget.classList.add('active'); renderTab(e.currentTarget.dataset.tab); });
  $('#save').onclick=()=>alert('ุชู ุงูุญูุธ ูุญูููุง (ุชูุถูุญู)');
  $('#push').onclick=()=>{ const inputs = $$('#tabpanel [data-key]'); const data=Object.fromEntries(inputs.map(i=>[i.dataset.key,i.value])); const payload={entity:key, section:$('.tab.active').dataset.tab, data}; alert('POST '+(loadConfig().apis.internal[key]||A.adapter)+'\n'+JSON.stringify(payload,null,2)); };
}

/* ===== ุจูุงุจุฉ ุงูุฑุนุงุฉ ===== */
function sponsorsPage(){
  const v=$('#view');
  v.innerHTML=`
  <div class="card">
    <div class="toolbar"><h2>ุจูุงุจุฉ ุงูุฑุนุงุฉ</h2><span class="tag">ุงูุชุณุนูุฑ ูุญููู ุงููููุฉ + ุงุชูุงููุฉ</span></div>
    <div class="three grid">
      <div class='card'><h3>ูุงุณู (Diamond)</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>1,500,000 ุฑ.ุณ / ุณูุฉ</div><ul>
        <li>ุงูุดุนุงุฑ ูู ูู ุงูุตูุญุงุช ูุงูุชูุงุฑูุฑ</li><li>ุชูุฑูุฑ ุฃุซุฑ ุฑุจุน ุณููู ููุตู</li><li>ุฃููููุฉ ุชุณููุฉ ุงููุจุงุฏุฑุงุช</li><li>ููุนุฏ ูุฌูุณ ุงูุฑุนุงุฉ</li></ul></div>
      <div class='card'><h3>ุฐูุจู (Gold)</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>700,000 ุฑ.ุณ / ุณูุฉ</div><ul>
        <li>ุงูุดุนุงุฑ ูู ุงูุตูุญุงุช ุงูุฑุฆูุณูุฉ</li><li>ุชูุงุฑูุฑ ูุตู ุณูููุฉ</li><li>ุฏุนูุงุช ุงููุนุงููุงุช</li></ul></div>
      <div class='card'><h3>ูุถู (Silver)</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>300,000 ุฑ.ุณ / ุณูุฉ</div><ul>
        <li>ุงูุดุนุงุฑ ูู ุตูุญุฉ ุงูุฑุนุงุฉ</li><li>ุดุงุฑุฉ ุชูุฏูุฑ ูู ุงูุชูุงุฑูุฑ</li></ul></div>
    </div>

    <h3>ุทูุจ ุฑุนุงูุฉ</h3>
    <div class="grid two form">
      <label>ุงุณู ุงูุฌูุฉ<input id="sp_org"/></label>
      <label>ุงูุณุฌู ุงูุชุฌุงุฑู/ุงูุฑูู ุงูุถุฑูุจู<input id="sp_cr"/></label>
      <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู<input id="sp_mail"/></label>
      <label>ูุฆุฉ ุงูุฑุนุงูุฉ<select id="sp_tier"><option>Diamond</option><option>Gold</option><option>Silver</option></select></label>
      <label>ุงูููุทูุฉ<select id="sp_region"><option>ุนูู ูุณุชูู ุงูููููุฉ</option><option>ุงูุฑูุงุถ</option><option>ุงูุดุฑููุฉ</option></select></label>
      <label>ูุฏุฉ ุงูุฑุนุงูุฉ (ุฃุดูุฑ)<input id="sp_months" type="number" value="12"/></label>
    </div>
    <label>ููุงุญุธุงุช<textarea id="sp_msg" class="form" style="width:100%;min-height:100px"></textarea></label>
    <div style="margin-top:10px"><button class="btn" id="gen">ุฅูุดุงุก ุงุชูุงููุฉ ุฑุนุงูุฉ ูุงุจูุฉ ููุทุจุงุนุฉ</button></div>
    <div class="card" id="agreement" style="display:none;margin-top:12px"></div>
  </div>`;
  $('#gen').onclick=()=>{
    const org=$('#sp_org').value||'____'; const tier=$('#sp_tier').value; const region=$('#sp_region').value;
    const cr=$('#sp_cr').value||'โ'; const months=parseInt($('#sp_months').value||'12',10);
    const today=new Date().toLocaleDateString('ar-SA');
    const rights= tier==='Diamond' ? 'ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ูู ุฌููุน ุตูุญุงุช ุงูููุตุฉ ูุงูุชูุงุฑูุฑ ูุงูููุงุฏ ุงูุฅุนูุงููุฉ' :
                 tier==='Gold' ? 'ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ูู ุงูุตูุญุงุช ุงูุฑุฆูุณูุฉ ูุงูุชูุงุฑูุฑ' :
                 'ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ูู ุตูุญุฉ ุงูุฑุนุงุฉ ูุจุนุถ ุงูุชูุงุฑูุฑ';
    $('#agreement').style.display='block';
    $('#agreement').innerHTML=`
      <div class="printable">
        <h3 style='margin-top:0'>ุงุชูุงููุฉ ุฑุนุงูุฉ ููุตุฉ ููู</h3>
        <p>ูู ููู <b>${today}</b> ุชู ุงูุงุชูุงู ุจูู <b>ููุตุฉ ููู NOMU</b> ูุงูุฌูุฉ <b>${org}</b> (ุณ.ุช/ุฑูู ุถุฑูุจู: ${cr}) ุจุตูุชูุง ุฑุงุนู <b>${tier}</b> ุนูู ูุณุชูู <b>${region}</b> ููุฏุฉ <b>${months}</b> ุดูุฑูุง.</p>
        <h4>ุงููุงุฏุฉ 1: ูุทุงู ุงูุฑุนุงูุฉ</h4>
        <ul><li>${rights}</li><li>ุฐูุฑ ุงูุฑุงุนู ูู ุงููุนุงููุงุช ุฐุงุช ุงูุตูุฉ ุญุณุจ ุงููุฆุฉ.</li><li>ููุญ ุชูุงุฑูุฑ ุฃุซุฑ ุฏูุฑูุฉ ุญุณุจ ุงููุฆุฉ.</li></ul>
        <h4>ุงููุงุฏุฉ 2: ุงูุงูุชุฒุงูุงุช</h4>
        <ul><li>ุงูุชุฒุงู ุงูุฑุงุนู ุจุณูุงุณุงุช ุงููููุฉ ุงูุจุตุฑูุฉ.</li><li>ุงูุชุฒุงู ุงูููุตุฉ ุจุฅุจุฑุงุฒ ุงูุดุนุงุฑ ููู ุงููุฆุฉ ูุงููุฏุฉ.</li><li>ุนุฏู ุชุฃุซูุฑ ุงูุฑุนุงูุฉ ุนูู ุงููุฑุงุฑุงุช ุงูููููุฉ.</li></ul>
        <h4>ุงููุงุฏุฉ 3: ุงูููุงุจู ุงููุงูู</h4>
        <p>ููู ูุฆุฉ ุงูุฑุนุงูุฉ ุงููุญุฏุฏุฉ ูุฌุฏุงูู ุงูุฏูุน ุงููุชูู ุนูููุง ุจูู ุงูุทุฑููู.</p>
        <h4>ุงููุงุฏุฉ 4: ุงูุจูุงูุงุช ูุงูุฎุตูุตูุฉ</h4>
        <p>ูุง ุชููุญ ูุฐู ุงูุงุชูุงููุฉ ุฃู ุญู ูุตูู ุฅูู ุจูุงูุงุช ุดุฎุตูุฉ. ุฃู ุชุนุงูู ุจูุงูุงุช ูุฎุถุน ูู PDPL ูุงุชูุงููุงุช ูุนุงูุฌุฉ ูุณุชููุฉ.</p>
        <h4>ุงููุงุฏุฉ 5: ุงูุฅููุงุก</h4>
        <p>ูุฌูุฒ ูุฃู ุทุฑู ุฅููุงุก ุงูุงุชูุงููุฉ ูู ุญุงูุงุช ุงูุฅุฎูุงู ุงูุฌููุฑู ุจุนุฏ ุฅุฎุทุงุฑ ุฎุทู ููุนุงูุฌุฉ ุฎูุงู ูุฏุฉ ูุชูู ุนูููุง.</p>
        <p>ุชูููุน ููุซู ุงูููุตุฉ: ____________ โข ุชูููุน ููุซู ุงูุฑุงุนู: ____________</p>
        <div style='margin-top:10px'><button class='ghost' onclick='window.print()'>ุทุจุงุนุฉ / ุญูุธ PDF</button></div>
      </div>`;
  };
}

/* ===== ุตูุญุฉ ููุงุฆุญ ุงูุฃุณุนุงุฑ (ุชูุตูู ุงูุฃุฑูุงู) ===== */
function pricingPage(){
  const v=$('#view');
  v.innerHTML = `
  <div class="card">
    <div class="toolbar"><h2>ููุงุฆุญ ุฃุณุนุงุฑ ุงูุฑุนุงูุฉ</h2><span class="tag">ูุงุจูุฉ ููุชุนุฏูู ูุงุญููุง</span></div>
    <table>
      <thead><tr><th>ุงููุฆุฉ</th><th>ุงูุณุนุฑ ุงูุณููู (ุฑ.ุณ)</th><th>ุงููุฒุงูุง</th></tr></thead>
      <tbody>
        <tr><td><b>ูุงุณู (Diamond)</b></td><td>1,500,000</td><td>ุดุนุงุฑ ุดุงูู + ุชูุฑูุฑ ุฑุจุน ุณููู ููุตู + ุฃููููุฉ ุชุณููุฉ + ููุนุฏ ูุฌูุณ ุงูุฑุนุงุฉ</td></tr>
        <tr><td><b>ุฐูุจู (Gold)</b></td><td>700,000</td><td>ุดุนุงุฑ ุจุงูุตูุญุงุช ุงูุฑุฆูุณูุฉ + ุชูุงุฑูุฑ ูุตู ุณูููุฉ + ุฏุนูุงุช ูุนุงููุงุช</td></tr>
        <tr><td><b>ูุถู (Silver)</b></td><td>300,000</td><td>ุดุนุงุฑ ุจุตูุญุฉ ุงูุฑุนุงุฉ + ุดุงุฑุฉ ุชูุฏูุฑ ูู ุงูุชูุงุฑูุฑ</td></tr>
      </tbody>
    </table>
    <div class="note" style="margin-top:8px">ูููู ุถุจุท ุงูุฃุณุนุงุฑ ูู ุฎูุงู ุงุชูุงููุงุช ุฎุงุตุฉ ููููุงุทู/ุงููุทุงุนุงุช.</div>
  </div>`;
}

/* ===== ุฃูู ูุฑุจุท ===== */
function ssoPage(){ const v=$('#view'); const cfg=loadConfig(); v.innerHTML=`
  <div class="card"><div class="toolbar"><h2>ุงูููุงุฐ ุงูููุญูุฏ (SSO ููุงุฐ)</h2><span class="tag">OIDC โ ูุญุงูุงุฉ</span></div>
  <p>ISSUER: <code>${cfg.sso.issuer}</code> โข AUTHZ: <code>${cfg.sso.authorize_url}</code> โข TOKEN: <code>${cfg.sso.token_url}</code></p>
  <button class="btn" id="nafath">ุงูุฏุฎูู ุนุจุฑ ููุงุฐ</button>
  <pre id="ssoLog" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>`;
  $('#nafath').onclick=()=>{ const mockId='USR-'+Math.random().toString(36).slice(2,8).toUpperCase(); $('#ssoLog').textContent='โ ุชุจุงุฏู ุงูููุฏ โ id_token\nUserID: '+mockId+'\nRoles: ["clinic.staff","referral.accept"]'; };
}
function rbacPage(){ const v=$('#view'); const allPerms=Array.from(new Set(Object.values(RBAC.roles).flat()));
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>ุตูุงุญูุงุช RBAC</h2><span class="tag">ุชุนุฑูู ูุชูููู</span></div>
  <div class="grid two">
    <div><h3>ุงูุฃุฏูุงุฑ</h3>${Object.entries(RBAC.roles).map(([r,ps])=>`<div class='pill'><b>${r}</b>: ${ps.join(', ')}</div>`).join('')}
      <div class="form" style="margin-top:10px"><label>ุฏูุฑ<input id="newRole" placeholder="entity.role"/></label>
      <label>ุงูุชูุงุฒุงุช (ุจููุงุตู)<input id="newPerms" placeholder="appointment.manage, referral.accept"/></label>
      <button class="btn" id="addRole">ุญูุธ</button><button class="ghost" id="exportRBAC">ุชุตุฏูุฑ</button></div>
    </div>
    <div><h3>ุชูููู</h3><div class="form">
      <label>ุงูุฏูุฑ<select id="roleSel">${Object.keys(RBAC.roles).map(r=>`<option>${r}</option>`).join('')}</select></label>
      <label>ุงูุงูุชูุงุฒ<select id="permSel">${allPerms.map(p=>`<option>${p}</option>`).join('')}</select></label>
      <label>ููุงููุฉ PDPLุ <select id="consSel"><option value="true">ูุนู</option><option value="false">ูุง</option></select></label></div>
      <button class="btn" id="eval" style="margin-top:10px">ุชูููู</button>
      <pre id="rbacOut" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>
  </div></div>`;
  $('#addRole').onclick=()=>{ const r=$('#newRole').value.trim(); if(!r) return; const perms=$('#newPerms').value.split(',').map(s=>s.trim()).filter(Boolean); RBAC.roles[r]=perms; alert('ุชู'); location.hash='#/rbac'; };
  $('#exportRBAC').onclick=()=>downloadJSON('rbac_policy.json', RBAC);
  $('#eval').onclick=()=>{ const role=$('#roleSel').value; const perm=$('#permSel').value; const consent=$('#consSel').value==='true';
    const allowed=checkPerm(role,perm,consent); $('#rbacOut').textContent=(allowed?'โ ูุณููุญ':'โ ูุฑููุถ')+'\nุงูุฏูุฑ: '+role+'\nุงูุงูุชูุงุฒ: '+perm+'\nุงูููุงููุฉ: '+consent;
  };
}
function configPage(){ const v=$('#view'); const cfg=loadConfig();
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>ูุฑูุฒ ุงูุฅุนุฏุงุฏุงุช</h2><span class="tag">Endpoints & Field Maps</span></div>
  <div class="grid two form">
    <label>SSO Issuer<input id="issuer" value="${cfg.sso.issuer}"/></label>
    <label>Authorize URL<input id="authz" value="${cfg.sso.authorize_url}"/></label>
    <label>Token URL<input id="token" value="${cfg.sso.token_url}"/></label>
    <label>Client ID<input id="cid" value="${cfg.sso.client_id}"/></label>
    <label>Redirect URI<input id="redir" value="${cfg.sso.redirect_uri}"/></label>
  </div>
  <h3>ูุณุงุฑุงุช ุฏุงุฎููุฉ</h3>
  <div class="grid two form">
    ${Object.entries(cfg.apis.internal).map(([k,v2])=>`<label>${k}<input data-int="${k}" value="${v2}"/></label>`).join('')}
  </div>
  <div style="margin-top:10px"><button class="btn" id="saveCfg">ุญูุธ</button><button class="ghost" id="dlCfg">ุชูุฒูู config.json</button></div></div>`;
  $('#saveCfg').onclick=()=>{ const next={ sso:{ issuer:$('#issuer').value, authorize_url:$('#authz').value, token_url:$('#token').value, client_id:$('#cid').value, redirect_uri:$('#redir').value },
    apis:{...cfg.apis, internal:Object.fromEntries($$('[data-int]').map(i=>[i.dataset.int,i.value])) } }; saveConfig(next); };
  $('#dlCfg').onclick=()=>downloadJSON('config.json', loadConfig());
}

/* ===== ุณูุงุณุงุช ููุณุงุนุฏุฉ ูุดุฑูุท ===== */
function privacyPage(){ const v=$('#view'); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>ุณูุงุณุฉ ุงูุฎุตูุตูุฉ ูุญูุงูุฉ ุงูุจูุงูุงุช (PDPL)</h2><span class="tag">ูุณุฎุฉ ุชูููุฐูุฉ</span></div>
  <ul><li>ุงูููุงููุฉ ุงูุตุฑูุญุฉ ูููู ุงูุฃูุฑ</li><li>ุงูุฃูู: ุชุดููุฑ + RBAC + ุชุณุฌูู ุฃุซุฑ</li><li>ุญููู: ุงูุงุทูุงุน/ุงูุชุตุญูุญ/ุงูุณุญุจ/ุงูุญุฐู</li></ul>
  <button class="ghost" onclick="window.print()">ุทุจุงุนุฉ</button></div>`; }

function childProtectPage(){ const v=$('#view'); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>ุณูุงุณุฉ ุญูุงูุฉ ุงูุทูู ูุงูุฅุจูุงุบ</h2><span class="tag">ุณูุงูุฉ ุงูุทูู ุฃูููุง</span></div>
  <ol><li>ุชูุซูู ุงููุงูุนุฉ</li><li>ุชูููู ุงููุฎุงุทุฑ</li><li>ุฅุญุงูุฉ ููุฌูุฉ ุงููุฎุชุตุฉ ูุงููุชุงุจุนุฉ</li></ol>
  <div class="callout">ููุงุฉ ุงูุฅุจูุงุบ ูุชุงุญุฉ ูุญุณุงุจุงุช ุงูููุงุฑุณูู ุงููุฎูููู.</div>
  <button class="ghost" onclick="window.print()">ุทุจุงุนุฉ ุงููููุฐุฌ</button></div>`; }

function helpCenterPage(){ const v=$('#view'); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>ูุฑูุฒ ุงููุณุงุนุฏุฉ</h2><span class="tag">ุงูุฏุนู ูุงูุฅุฑุดุงุฏ</span></div>
  <details open><summary><b>ููู ุฃุฑูุน ูุฑููุงุชุ</b></summary><p>ูู ุชุจููุจ "ูุฑููุงุช" ุฏุงุฎู ุญุณุงุจู โ ุงุฎุชุฑ ุงููููุงุช ูุณุชุธูุฑ ูู ููุชูุฒูู.</p></details>
  <details><summary><b>ุณูุฑ ุงูุฅุญุงูุฉ ูSLAุ</b></summary><p>ุฃุฏุฎู ุชุงุฑูุฎ ูุชุญ/ูุจูู ูุณุชุธูุฑ ุญุงูุฉ ุงูุงูุชุฒุงู ุจูSLA ุชููุงุฆููุง.</p></details>
</div>`; }

function termsPage(){ const v=$('#view'); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>ุงูุดุฑูุท ูุงูุฃุญูุงู</h2><span class="tag">ูุณุฎุฉ ุงุณุชุฎุฏุงู</span></div>
  <ul><li>ุงูุงูุชุฒุงู ุจุงูุณูุงุณุงุช ุงููุทููุฉ ูPDPL.</li><li>ุญุธุฑ ูุดุงุฑูุฉ ุจูุงูุงุช ุชุนุฑูููุฉ ุฎุงุฑุฌ ุงูููุธููุฉ.</li><li>ุงูุชูุงูู ุนุจุฑ ูููุงุช ุฑุณููุฉ ููุท.</li></ul>
  <button class="ghost" onclick="window.print()">ุทุจุงุนุฉ</button></div>`; }

/* ===== API Docs ===== */
function apiDocsPage(){
  const v=$('#view'); const cfg=loadConfig();
  v.innerHTML=`
  <div class="card">
    <div class="toolbar"><h2>API Docs</h2><span class="tag">ุนููุฉ ุชูุซูู</span></div>
    <table><thead><tr><th>ุงูููุงู</th><th>Endpoint</th></tr></thead>
      <tbody>${Object.entries(cfg.apis.internal).map(([k,val])=>`<tr><td>${k}</td><td><code>${val}</code></td></tr>`).join('')}</tbody>
    </table>
    <h3>ูููุฐุฌ ุฅุญุงูุฉ (POST)</h3>
    <pre class="callout">POST /api/health/referral
{ "mrn":"...", "ref_to":"education", "priority":"high", "attachments":["url1","url2"] }</pre>
  </div>`;
}

/* ===== Export ===== */
function exportPage(){ const v=$('#view'); v.innerHTML=`
  <div class="card"><h2>ุชุตุฏูุฑ</h2>
  <button class="btn" id="kjson">KPI Registry</button>
  <button class="ghost" id="rjson">RBAC</button>
  <button class="ghost" id="cfg">Config</button></div>`;
  $('#kjson').onclick=()=>downloadJSON('kpi_registry.json', KPI_REGISTRY);
  $('#rjson').onclick=()=>downloadJSON('rbac_policy.json', RBAC);
  $('#cfg').onclick=()=>downloadJSON('config.json', loadConfig());
}

/* ===== Router ===== */
const routes={
  '/intro':intro,'/kpi-registry':kpiRegistryPage,'/sponsors':sponsorsPage,'/pricing':pricingPage,'/sso':ssoPage,'/rbac':rbacPage,'/config':configPage,'/export':exportPage,'/apidocs':apiDocsPage,
  '/dispatch':dispatchPage,'/ops':opsPage,
  '/privacy':privacyPage,'/child-protect':childProtectPage,'/help':helpCenterPage,'/terms':termsPage,
  '/acc/health':()=>accountPage('health'),'/acc/clinic':()=>accountPage('clinic'),'/acc/education':()=>accountPage('education'),
  '/acc/neighborhood':()=>accountPage('neighborhood'),'/acc/nonprofit':()=>accountPage('nonprofit'),
  '/acc/hr':()=>accountPage('hr'),'/acc/csr':()=>accountPage('csr'),'/acc/family':()=>accountPage('family'),'/acc/admin':()=>accountPage('admin')
};
if(!location.hash) location.hash = '#/intro';
route();
</script>
</body>
</html>
