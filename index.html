import React, { useMemo, useState } from "react";
import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";import React, { useMemo, useState } from "react";
import { motion } from "framer-motion";

// shadcn/ui
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Table, TableBody, TableCaption, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Switch } from "@/components/ui/switch";

// Icons
import { Download, Search, Plus, Save, Info, Shield, HelpCircle, Building2, Landmark, University, Users, HandCoins, Activity, Stethoscope, Layers, ClipboardList, LineChart, Settings2, ListFilter, FileSpreadsheet, NotebookPen } from "lucide-react";

// شعارات — حدّث المسارات حسب مشروعك
import VisionLogo from "@/assets/vision2030.png";   // شعار رؤية 2030
import TalbiyaLogo from "@/assets/talbiya.png";     // شعار مبادرة تلبية

/**
 * منصة "نمو" — واجهة موحّدة مستقلة (لا تتضمن حسابات/مصطلحات منصة حصيف)
 * - الغرض: مركز مؤشرات وتنفيذ وتشغيل لمبادرات "نمو" فقط، مع صفحات للشركاء حسب النوع.
 * - تمت إزالة أي إشارات أو نماذج تخص حصيف (مثل: "اللبنات التسع"، "محفظة المانح"… إلخ).
 */

// تبويبات صفحات "نمو" (هوية مستقلة)
const NOMO_TABS = [
  { key: "overview", label: "نظرة عامة", icon: Info },
  { key: "gov_partners", label: "شركاؤنا الحكوميون", icon: Landmark },
  { key: "private_partners", label: "شركاء القطاع الخاص", icon: Building2 },
  { key: "uni_partners", label: "الجامعات الشريكة", icon: University },
  { key: "nonprofit_partners", label: "المنظمات الشريكة", icon: HandCoins },
  { key: "individuals", label: "المستخدمون", icon: Users },
  { key: "health_centers", label: "المراكز الصحية", icon: Stethoscope },
  { key: "kpis", label: "KPIs", icon: LineChart },
  { key: "reports", label: "التقارير", icon: FileSpreadsheet },
  { key: "policies", label: "السياسات", icon: Shield },
  { key: "help", label: "المساعدة", icon: HelpCircle },
] as const;

// شجرة خدمات/أقسام لكل صفحة شراكات (صياغة محايدة خاصة بـ "نمو")
const PAGE_SECTIONS: Record<string, any[]> = {
  gov_partners: [
    { name: "اتفاقيات التعاون" },
    { name: "الاحتياجات المشتركة" },
    { name: "سجل الأنشطة والموافقات" },
  ],
  private_partners: [
    { name: "اتفاقيات تعاون/تطوير" },
    { name: "مشروعات مشتركة" },
    { name: "سجل المبادرات" },
  ],
  uni_partners: [
    { name: "اتفاقيات بحث وتطوير" },
    { name: "دعم علمي/استشاري" },
    { name: "برامج تدريب وتدريب تعاوني" },
  ],
  nonprofit_partners: [
    { name: "مبادرات مشتركة" },
    { name: "برامج تدريب وتطوع" },
    { name: "سجل الأداء والتقارير" },
  ],
  individuals: [
    { name: "طلبات الانضمام" },
    { name: "سجل المشاركات" },
    { name: "الدعم الفني" },
  ],
  health_centers: [
    { name: "إدارة المواعيد" },
    { name: "الخدمات المجتمعية" },
    { name: "تقارير صحية موجزة" },
  ],
};

// بيانات وهمية موحّدة
const MOCK_ITEMS = Array.from({ length: 28 }).map((_, i) => ({
  id: i + 1,
  title: `سجل ${i + 1}`,
  partner: ["جهة حكومية","شركة","جامعة","منظمة","فرد"][i % 5],
  status: ["مسودة","قيد المراجعة","نشط","مكتمل"][i % 4],
  tag: ["تشغيل","تقني","تنموي","تقارير"][i % 4],
  score: Math.round(60 + Math.random()*40),
}));

// تعريفات KPI لنمو
const DEFAULT_KPIS = [
  { key: "delivery_speed", name: "سرعة التسليم", owner: "فريق التشغيل", definition: "متوسط زمن إنجاز مخرجات مبادرات نمو." },
  { key: "partner_satisfaction", name: "رضا الشركاء", owner: "إدارة الشراكات", definition: "مؤشر رضا الشركاء بالمشاريع المشتركة." },
  { key: "quality_index", name: "مؤشر الجودة", owner: "ضمان الجودة", definition: "نسبة الالتزام بالمعايير والمواصفات في المشاريع." },
  { key: "impact_score", name: "درجة الأثر", owner: "قياس الأثر", definition: "مؤشر مركّب لقياس أثر مبادرات نمو." },
];

function TopBar() {
  return (
    <div className="w-full sticky top-0 z-40 backdrop-blur bg-white/70 border-b">
      <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
        {/* الجانب الأيسر: شعاري رؤية 2030 وتلبية */}
        <div className="flex items-center gap-3">
          <img src={VisionLogo} alt="شعار رؤية 2030" className="h-10 object-contain" />
          <img src={TalbiyaLogo} alt="شعار مبادرة تلبية" className="h-10 object-contain" />
        </div>
        {/* يمين الشريط: بحث + تصدير */}
        <div className="flex items-center gap-2 w-full max-w-md">
          <div className="relative w-full">
            <Search className="absolute start-3 top-1/2 -translate-y-1/2 h-4 w-4" />
            <Input placeholder="ابحث في منصة نمو…" className="ps-9" />
          </div>
          <Button variant="outline" className="gap-1"><Download className="h-4 w-4" /> تصدير</Button>
        </div>
      </div>
    </div>
  );
}

function IntroCard() {
  return (
    <Card className="rounded-2xl shadow-sm">
      <CardHeader>
        <CardTitle>منصة نمو — تعريف</CardTitle>
        <CardDescription>منصة تشغيلية مستقلة لتمكين مبادرات "نمو" ومتابعة مؤشرات الأداء والشراكات.</CardDescription>
      </CardHeader>
      <CardContent className="grid md:grid-cols-3 gap-4">
        <div className="p-4 rounded-xl border bg-white">
          <h3 className="font-bold mb-2">الرؤية</h3>
          <p>منظومة تنفيذية ذكية تُسرّع الأثر وترفع الجودة في مبادرات "نمو".</p>
        </div>
        <div className="p-4 rounded-xl border bg-white">
          <h3 className="font-bold mb-2">الرسالة</h3>
          <p>تشغيل رشيق قائم على البيانات وشراكات فعّالة وتقارير دقيقة.</p>
        </div>
        <div className="p-4 rounded-xl border bg-white">
          <h3 className="font-bold mb-2">الأهداف</h3>
          <ul className="list-disc ms-5 space-y-1 text-sm">
            <li>رفع سرعة التسليم وتقليل الهدر.</li>
            <li>تعزيز جودة التنفيذ والتوثيق.</li>
            <li>تمكين الشراكات وتبادل المعرفة.</li>
            <li>تحسين قياس الأثر والتقارير.</li>
          </ul>
        </div>
      </CardContent>
    </Card>
  );
}

function ServiceTree({ nodes }: { nodes: any[] }) {
  return (
    <ul className="space-y-2">
      {nodes.map((n, idx) => (
        <li key={idx}>
          <div className="flex items-center gap-2">
            <Layers className="h-4 w-4" />
            <span className="font-medium">{n.name}</span>
          </div>
          {n.children && n.children.length > 0 && (
            <div className="ms-4 mt-2 border-s ps-4">
              <ServiceTree nodes={n.children} />
            </div>
          )}
        </li>
      ))}
    </ul>
  );
}

function SectionPanel({ pageKey, title, desc }: { pageKey: keyof typeof PAGE_SECTIONS; title: string; desc: string }) {
  return (
    <div className="space-y-4">
      <Card className="rounded-2xl">
        <CardHeader>
          <CardTitle>{title}</CardTitle>
          <CardDescription>{desc}</CardDescription>
        </CardHeader>
        <CardContent className="grid md:grid-cols-2 gap-4">
          <div className="p-4 rounded-xl border">
            <h4 className="font-bold mb-2 flex items-center gap-2"><ClipboardList className="h-4 w-4" /> أقسام الصفحة</h4>
            <ServiceTree nodes={PAGE_SECTIONS[pageKey] ?? []} />
          </div>
          <div className="p-4 rounded-xl border">
            <h4 className="font-bold mb-2 flex items-center gap-2"><Settings2 className="h-4 w-4" /> إعدادات</h4>
            <div className="grid gap-3 text-sm">
              <div className="flex items-center justify-between"><span>تفعيل استقبال الطلبات</span><Switch defaultChecked /></div>
              <div className="flex items-center justify-between"><span>إظهار مؤشرات الأداء</span><Switch defaultChecked /></div>
              <div className="flex items-center justify-between"><span>تنبيهات البريد</span><Switch /></div>
            </div>
          </div>
        </CardContent>
      </Card>
      <DataTable title="سجل العناصر/الطلبات/الأنشطة" />
    </div>
  );
}

function DataTable({ title }: { title: string }) {
  const [q, setQ] = useState("");
  const [status, setStatus] = useState<string | null>(null);
  const data = useMemo(() => {
    return MOCK_ITEMS.filter((r) =>
      (!q || r.title.includes(q) || r.partner.includes(q) || r.tag.includes(q)) &&
      (!status || r.status === status)
    );
  }, [q, status]);

  return (
    <Card className="rounded-2xl">
      <CardHeader className="flex flex-col gap-2">
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <CardTitle className="text-lg">{title}</CardTitle>
            <CardDescription>بحث/تصفية سريعة</CardDescription>
          </div>
          <div className="flex items-center gap-2">
            <div className="relative">
              <Search className="absolute start-3 top-1/2 -translate-y-1/2 h-4 w-4" />
              <Input placeholder="بحث…" value={q} onChange={(e) => setQ(e.target.value)} className="ps-9 w-56" />
            </div>
            <Select onValueChange={(v) => setStatus(v)}>
              <SelectTrigger className="w-56"><ListFilter className="me-2 h-4 w-4" />
                <SelectValue placeholder="تصفية حسب الحالة" />
              </SelectTrigger>
              <SelectContent>
                { ["مسودة","قيد المراجعة","نشط","مكتمل"].map(s => <SelectItem key={s} value={s}>{s}</SelectItem>) }
              </SelectContent>
            </Select>
            <Dialog>
              <DialogTrigger asChild>
                <Button className="gap-1"><Plus className="h-4 w-4" /> عنصر جديد</Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>إضافة عنصر</DialogTitle>
                  <DialogDescription>نموذج مبسّط — حفظ محلي للتجربة</DialogDescription>
                </DialogHeader>
                <div className="grid gap-3">
                  <Input placeholder="العنوان" />
                  <Input placeholder="الجهة/الشريك" />
                  <Select>
                    <SelectTrigger><SelectValue placeholder="الحالة" /></SelectTrigger>
                    <SelectContent>
                      { ["مسودة","قيد المراجعة","نشط","مكتمل"].map(s => <SelectItem key={s} value={s}>{s}</SelectItem>) }
                    </SelectContent>
                  </Select>
                  <Button className="gap-1"><Save className="h-4 w-4" /> حفظ</Button>
                </div>
              </DialogContent>
            </Dialog>
          </div>
        </div>
      </CardHeader>
      <CardContent>
        <Table>
          <TableCaption>قائمة العناصر</TableCaption>
          <TableHeader>
            <TableRow>
              <TableHead>#</TableHead>
              <TableHead>العنوان</TableHead>
              <TableHead>الشريك</TableHead>
              <TableHead>الحالة</TableHead>
              <TableHead>وسم</TableHead>
              <TableHead>النتيجة</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {data.map((r) => (
              <TableRow key={r.id}>
                <TableCell>{r.id}</TableCell>
                <TableCell className="font-medium">{r.title}</TableCell>
                <TableCell>{r.partner}</TableCell>
                <TableCell>
                  <Badge variant={r.status === "نشط" ? "default" : "secondary"}>{r.status}</Badge>
                </TableCell>
                <TableCell>{r.tag}</TableCell>
                <TableCell>{r.score}</TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  );
}

function KPIsPanel() {
  const [kpis, setKpis] = useState(DEFAULT_KPIS);
  const [json, setJson] = useState(JSON.stringify(kpis, null, 2));
  const [valid, setValid] = useState(true);

  function apply() {
    try {
      const parsed = JSON.parse(json);
      if (!Array.isArray(parsed)) throw new Error("صيغة غير صحيحة");
      setKpis(parsed);
      setValid(true);
    } catch (e) {
      setValid(false);
    }
  }

  return (
    <Card className="rounded-2xl">
      <CardHeader>
        <CardTitle className="flex items-center gap-2"><LineChart className="h-5 w-5" /> مؤشرات أداء "نمو"</CardTitle>
        <CardDescription>حرّر تعريفات KPIs وملاّكها هنا (حفظ مؤقت ضمن الواجهة).</CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="grid md:grid-cols-2 gap-4">
          <div className="space-y-2">
            <Label>JSON</Label>
            <Textarea value={json} onChange={(e) => setJson(e.target.value)} className="font-mono h-64" />
            <div className="flex items-center gap-2">
              <Button className="gap-1" onClick={apply}><Save className="h-4 w-4" /> تطبيق</Button>
              {!valid && <span className="text-red-600 text-sm">صيغة JSON غير صحيحة</span>}
            </div>
          </div>
          <div className="space-y-2">
            <Label>المعايير الحالية</Label>
            <div className="p-3 border rounded-xl bg-slate-50 space-y-2 max-h-64 overflow-auto">
              {kpis.map((k) => (
                <div key={k.key} className="p-2 bg-white rounded-lg border">
                  <div className="flex items-center justify-between">
                    <strong>{k.name}</strong>
                    <Badge variant="secondary">{k.owner}</Badge>
                  </div>
                  <p className="text-sm text-slate-600 mt-1">{k.definition}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

function PoliciesCard() {
  const [childSafe, setChildSafe] = useState(true);
  const [retention, setRetention] = useState(12);
  return (
    <Card className="rounded-2xl">
      <CardHeader>
        <CardTitle className="flex items-center gap-2"><Shield className="h-5 w-5" /> السياسات والخصوصية</CardTitle>
        <CardDescription>سياسات حماية الطفل والبيانات — صياغة خاصة بمنصة "نمو".</CardDescription>
      </CardHeader>
      <CardContent className="grid md:grid-cols-3 gap-4">
        <div className="p-4 rounded-xl border">
          <h4 className="font-bold mb-2">حماية الطفل</h4>
          <div className="flex items-center justify-between">
            <span className="text-sm text-slate-600">تفعيل أدوات الحماية</span>
            <Switch checked={childSafe} onCheckedChange={setChildSafe} />
          </div>
          <p className="text-xs text-slate-500 mt-3">إخفاء البيانات الحساسة، موافقة ولي الأمر، آليات الإبلاغ.</p>
        </div>
        <div className="p-4 rounded-xl border">
          <h4 className="font-bold mb-2">الاحتفاظ بالبيانات</h4>
          <div className="flex items-center gap-2">
            <Input type="number" value={retention} onChange={(e)=>setRetention(parseInt(e.target.value||"0"))} className="w-24" />
            <span>شهرًا</span>
          </div>
          <p className="text-xs text-slate-500 mt-3">يُحذف تلقائيًا ما لم تتطلب الأنظمة الاحتفاظ لفترة أطول.</p>
        </div>
        <div className="p-4 rounded-xl border">
          <h4 className="font-bold mb-2">الاستخدام العادل</h4>
          <p className="text-sm text-slate-600">تُستخدم البيانات لأغراض تشغيل "نمو" فقط مع تفعيل إخفاء الهوية للتحليلات.</p>
        </div>
      </CardContent>
    </Card>
  );
}

function HelpCenterCard() {
  return (
    <Card className="rounded-2xl">
      <CardHeader>
        <CardTitle className="flex items-center gap-2"><HelpCircle className="h-5 w-5" /> مركز المساعدة</CardTitle>
        <CardDescription>أسئلة شائعة ودليل تواصل خاص بمنصة "نمو".</CardDescription>
      </CardHeader>
      <CardContent className="grid md:grid-cols-3 gap-4">
        <Card className="border-dashed">
          <CardHeader className="pb-1"><CardTitle className="text-base">كيف أضيف شريكًا؟</CardTitle></CardHeader>
          <CardContent className="text-sm">من صفحة الشركاء المناسبة، اختر "عنصر جديد" وأكمل البيانات ثم احفظ.</CardContent>
        </Card>
        <Card className="border-dashed">
          <CardHeader className="pb-1"><CardTitle className="text-base">تحديث مؤشرات الأداء</CardTitle></CardHeader>
          <CardContent className="text-sm">من تبويب KPIs عدّل JSON ثم اضغط "تطبيق" لمزامنة التعريفات.</CardContent>
        </Card>
        <Card className="border-dashed">
          <CardHeader className="pb-1"><CardTitle className="text-base">إنشاء تقرير</CardTitle></CardHeader>
          <CardContent className="text-sm">اذهب إلى "التقارير" واختر نطاق التاريخ ونوع التقرير لتصدير ملف CSV.</CardContent>
        </Card>
      </CardContent>
    </Card>
  );
}

// ————— التطبيق الرئيسي (منصة نمو) —————
export default function NomoPlatform() {
  const [tab, setTab] = useState<string>("overview");

  return (
    <div dir="rtl" className="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-900">
      <TopBar />

      <main className="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <motion.div initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4 }}>
          <IntroCard />
        </motion.div>

        <Tabs value={tab} onValueChange={setTab} className="space-y-6">
          <TabsList className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2">
            {NOMO_TABS.map(({ key, label, icon: Icon }) => (
              <TabsTrigger key={key} value={key as string} className="gap-1"><Icon className="h-4 w-4" /> {label}</TabsTrigger>
            ))}
          </TabsList>

          <TabsContent value="overview">
            <DataTable title="لوحة عامة — عناصر عبر منصة نمو" />
          </TabsContent>

          <TabsContent value="gov_partners">
            <SectionPanel pageKey="gov_partners" title="شركاؤنا الحكوميون" desc="إدارة التعاون والأنشطة المشتركة" />
          </TabsContent>
          <TabsContent value="private_partners">
            <SectionPanel pageKey="private_partners" title="شركاء القطاع الخاص" desc="تنسيق المشاريع والتطوير" />
          </TabsContent>
          <TabsContent value="uni_partners">
            <SectionPanel pageKey="uni_partners" title="الجامعات الشريكة" desc="بحث وتطوير وبرامج تدريب" />
          </TabsContent>
          <TabsContent value="nonprofit_partners">
            <SectionPanel pageKey="nonprofit_partners" title="المنظمات الشريكة" desc="مبادرات مجتمعية وتقارير أداء" />
          </TabsContent>
          <TabsContent value="individuals">
            <SectionPanel pageKey="individuals" title="المستخدمون" desc="طلبات الانضمام وسجل المشاركات" />
          </TabsContent>
          <TabsContent value="health_centers">
            <SectionPanel pageKey="health_centers" title="المراكز الصحية" desc="مواعيد وخدمات وتقارير موجزة" />
          </TabsContent>

          <TabsContent value="kpis">
            <KPIsPanel />
          </TabsContent>

          <TabsContent value="reports">
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle className="flex items-center gap-2"><NotebookPen className="h-5 w-5" /> التقارير</CardTitle>
                <CardDescription>تصدير تقارير تشغيلية (نطاق زمني/نوع تقرير) — موك.</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid md:grid-cols-3 gap-3">
                  <Input type="date" />
                  <Input type="date" />
                  <Select>
                    <SelectTrigger><SelectValue placeholder="نوع التقرير" /></SelectTrigger>
                    <SelectContent>
                      <SelectItem value="summary">ملخص تنفيذي</SelectItem>
                      <SelectItem value="kpi">مؤشرات الأداء</SelectItem>
                      <SelectItem value="partners">الشركاء والأنشطة</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="mt-4"><Button variant="outline" className="gap-1"><Download className="h-4 w-4" /> تصدير CSV</Button></div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="policies">
            <PoliciesCard />
          </TabsContent>

          <TabsContent value="help">
            <HelpCenterCard />
          </TabsContent>
        </Tabs>

        <footer className="text-center text-xs text-slate-500 py-6">
          منصة نمو — واجهة مستقلة. © {new Date().getFullYear()}
        </footer>
      </main>
    </div>
  );
}

import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Table, TableBody, TableCaption, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Switch } from "@/components/ui/switch";
import { Separator } from "@/components/ui/separator";
import { Download, Search, Plus, Save, Info, Shield, HelpCircle, Building2, Landmark, University, Users, HandCoins, Activity, Stethoscope, Cog, Layers, Globe2, FileText, ClipboardList, LineChart, Settings2, ListFilter } from "lucide-react";
import VisionLogo from "@/assets/Vision 2030.png";
import TalbiyaLogo from "@/assets/talbiya.png";

/**
 * منصة نمو — ملف واجهة موحد مع الشعارات الرسمية لرؤية 2030 ومبادرة تلبية.
 */

const Logos = {
  vision2030: <img src={VisionLogo} alt="شعار رؤية 2030" className="h-12 object-contain" />, 
  talbiya: <img src={TalbiyaLogo} alt="شعار مبادرة تلبية" className="h-12 object-contain" />,
};

export default function PartnersStrip() {
  return (
    <div className="max-w-7xl mx-auto px-4">
      <div className="rounded-2xl border p-4 bg-white/60">
        <div className="text-slate-500 text-sm mb-3">شركاء المنصة:</div>
        <div className="grid grid-cols-2 md:grid-cols-4 items-center gap-6">
          <div className="flex items-center justify-center">{Logos.vision2030}</div>
          <div className="flex items-center justify-center">{Logos.talbiya}</div>
        </div>
      </div>
    </div>
  );
}
