<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>منصة نمو — تلبية × رؤية 2030</title>
  <meta name="description" content="منصة نمو الوطنية: ربط الأسرة والصحة والتعليم والجمعيات والقطاع الخاص واللجنة الوطنية ضمن هوية تلبية ومواءمة رؤية 2030."/>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Noto Sans Arabic','Tahoma','Arial','sans-serif'] },
          colors: {
            nomu: { 50:'#ecfdf5',100:'#d1fae5',200:'#a7f3d0',300:'#6ee7b7',400:'#34d399',500:'#10b981',600:'#059669',700:'#047857',800:'#065f46',900:'#064e3b' },
            telbiya: { 600:'#0ea5e9', 700:'#0369a1' },
            vision: { 700:'#0f766e' }
          }
        }
      }
    }
  </script>
  <style>
    html,body{height:100%;background:#fff}
    .container{max-width:80rem;margin-inline:auto}
  </style>
</head>
<body class="font-sans text-slate-800">
  <div id="root"></div>

  <!-- React 18 + ReactDOM + Babel (JSX in browser) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useMemo } = React;

    /* ====================== Utilities & Seed ====================== */
    const cn=(...a)=>a.filter(Boolean).join(" ");
    const store={ get:(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)), del:k=>localStorage.removeItem(k) };
    const REGIONS=["الرياض","مكة المكرمة","الشرقية","المدينة","عسير","حائل","تبوك","القصيم","نجران","جازان","الجوف","الباحة","الحدود الشمالية"];
    const ROLES=[
      {id:"family",label:"الأسرة/الأفراد"},
      {id:"health",label:"الصحة"},
      {id:"edu",label:"التعليم"},
      {id:"ngo",label:"الجمعيات"},
      {id:"csr",label:"القطاع الخاص (CSR)"},
      {id:"national",label:"اللجنة الوطنية"},
      {id:"admin",label:"إدارة المنصة"}
    ];
    const CONTACT={ email:"info@talbiya.sa", whatsapp:"966556083172" };

    // حقول ديناميكية لكل دور للإحالات (يمكن توسعتها لنماذج أخرى)
    const ROLE_FORMS={
      family:[
        {key:"guardianPhone", label:"هاتف ولي الأمر", type:"tel", required:true},
        {key:"preferredContact", label:"طريقة التواصل المفضلة", type:"select", options:["الهاتف","واتساب","البريد"], required:true}
      ],
      health:[
        {key:"diagnosis", label:"تشخيص/ملاحظة أولية", type:"textarea", required:true},
        {key:"priority", label:"الأولوية", type:"select", options:["عاجلة","مرتفعة","عادية"], required:true}
      ],
      edu:[
        {key:"schoolId", label:"رقم المنشأة التعليمية (إن وجد)", type:"text"},
        {key:"iep", label:"حالة خطة تعليم فردي (IEP)", type:"select", options:["غير مطبق","قيد الإعداد","مطبّق"], required:true}
      ],
      ngo:[
        {key:"program", label:"البرنامج/المبادرة", type:"select", options:["تدخل مبكر","إرشاد أسري","دعم مجتمعي"], required:true},
        {key:"capacity", label:"الطاقة الاستيعابية الحالية", type:"number"}
      ],
      csr:[
        {key:"sponsor", label:"اسم الجهة الراعية", type:"text", required:true},
        {key:"fundingRef", label:"مرجع التزام مالي/منحة", type:"text"}
      ],
      national:[
        {key:"policyRef", label:"مرجع السياسة/الإجراء", type:"text"},
        {key:"regionScope", label:"النطاق الجغرافي", type:"select", options:["وطني","منطقة","محافظة"], required:true}
      ],
      admin:[
        {key:"internalNote", label:"ملاحظة داخلية", type:"textarea"},
        {key:"sla", label:"مستوى الخدمة SLA", type:"select", options:["≤2س","≤8س","≤1يوم"], required:true}
      ]
    };

    function seed(){
      if(!store.get("nomu_initialized",false)){
        store.set("user",{ role:"family", region:"الرياض", name:"مستخدم تجريبي" });
        store.set("kpis",{ period:"آخر 30 يومًا", byRegion:{
          "الرياض":{coverage:82,immunization:91,readiness:76,referralsMedianHrs:18,kgEnroll:88,completeness:96},
          "مكة المكرمة":{coverage:78,immunization:89,readiness:72,referralsMedianHrs:22,kgEnroll:84,completeness:94}
        }});
        store.set("children",[
          {id:"CH-001", familyId:"F-001", name:"سعود", gender:"M", birthDate:"2021-06-10", region:"الرياض"},
          {id:"CH-002", familyId:"F-001", name:"نورة", gender:"F", birthDate:"2023-02-02", region:"الرياض"}
        ]);
        store.set("screenings",[
          {id:"SC-100", childId:"CH-002", type:"newborn_hearing", date:"2023-02-05", result:"PASS"},
          {id:"SC-101", childId:"CH-001", type:"developmental", date:"2024-10-01", result:"Needs follow-up"}
        ]);
        store.set("referrals",[
          {id:"RF-1001", child:"سعود", type:"تعليمي", status:"قيد المعالجة", created:"2025-09-22", region:"الرياض", notes:"تقييم جاهزية", meta:{}},
          {id:"RF-1002", child:"نورة", type:"صحي", status:"مفتوحة", created:"2025-09-28", region:"الرياض", notes:"متابعة سمع", meta:{}}
        ]);
        store.set("wallet",{ total:35000, entries:[
          {id:"TRX-01", source:"شركة ألف — رعاية روضة", amount:20000, date:"2025-09-05", tag:"CSR"},
          {id:"TRX-02", source:"منحة تعليم مبكر", amount:10000, date:"2025-09-18", tag:"Grant"},
          {id:"TRX-03", source:"متبرع فردي", amount:5000, date:"2025-10-01", tag:"Donation"}
        ]});
        store.set("notifications",[
          {id:"NT-01", level:"info", text:"تذكير: موعد تقييم نمائي بعد 3 أيام."},
          {id:"NT-02", level:"warn", text:"إحالة RF-1002 تجاوزت 48 ساعة دون تحديث."}
        ]);
        store.set("nomu_initialized",true);
      }
    }

    /* ====================== Inline Logos (SVG) ====================== */
    const LogoNOMU=({color="#059669",className="h-8 w-auto"})=>(
      <div className="flex items-center gap-2">
        <svg className={className} viewBox="0 0 220 60" aria-label="نمو" role="img">
          <title>نمو</title>
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stopColor={color} stopOpacity="0.35"/><stop offset="100%" stopColor={color} stopOpacity="0.9"/></linearGradient></defs>
          <circle cx="18" cy="16" r="6" fill="url(#g)"/>
          <path d="M10 46 Q18 28 28 36 T48 46" fill="none" stroke={color} strokeWidth="6" strokeLinecap="round"/>
          <path d="M75 28 q14-10 24 0 t24 0" fill="none" stroke={color} strokeWidth="6" strokeLinecap="round"/>
          <path d="M73 44 q14 12 24 0 t24 0" fill="none" stroke={color} strokeWidth="6" strokeLinecap="round"/>
          <line x1="10" y1="52" x2="200" y2="52" stroke={color} strokeWidth="2" strokeLinecap="round" opacity="0.2"/>
        </svg>
        <span className="text-xl font-bold" style={{color}}>منصة نمو</span>
      </div>
    );

    // شعارات يسارية (مكانها في الجانب الأيسر فعليًا ضمن الشريط)
    const LogoVision=({className="h-8 w-auto"})=>(
      <div className="flex items-center gap-2 text-vision-700" title="رؤية 2030">
        <svg className={className} viewBox="0 0 200 60" role="img"><text x="0" y="38" fontSize="28" fontWeight="700" fill="currentColor">رؤية 2030</text></svg>
      </div>
    );
    const LogoTelbiya=({className="h-8 w-auto"})=>(
      <div className="flex items-center gap-2 text-telbiya-700" title="تلبية">
        <svg className={className} viewBox="0 0 200 60" role="img"><text x="0" y="38" fontSize="28" fontWeight="700" fill="currentColor">تلبية</text></svg>
      </div>
    );

    /* ====================== Shared UI ====================== */
    const Badge=({text,color="bg-slate-100 text-slate-700"})=><span className={cn("text-xs px-2 py-1 rounded-full",color)}>{text}</span>;
    const Stat=({label,value,suffix="%",ok=true})=>(
      <div className={cn("rounded-2xl p-5 border shadow-sm",ok?"border-emerald-200 bg-emerald-50":"border-amber-200 bg-amber-50")}>
        <div className="text-sm text-slate-600">{label}</div>
        <div className="mt-2 text-3xl font-bold">{value}<span className="text-xl">{suffix}</span></div>
      </div>
    );

    /* ====================== Layout: Header / Footer ====================== */
    const TopBar=({onLogout})=>{
      const user=store.get("user",{});
      return (
        <header className="w-full bg-white/90 backdrop-blur border-b border-slate-200 sticky top-0 z-40">
          <div className="container px-3 sm:px-4 h-16 flex items-center justify-between">
            {/* يمين: NOMU */}
            <a href="#/home" className="flex items-center gap-3"><LogoNOMU/></a>

            {/* وسط: تنقّل */}
            <nav className="hidden xl:flex items-center gap-2 text-sm">
              <a href="#/home" className="px-3 py-2 hover:opacity-80">الرئيسية</a>
              <a href="#/journey" className="px-3 py-2 hover:opacity-80">رحلة الطفل</a>
              <a href="#/kpis" className="px-3 py-2 hover:opacity-80">مؤشرات الأداء</a>
              <a href="#/referrals" className="px-3 py-2 hover:opacity-80">الإحالات</a>
              <a href="#/health" className="px-3 py-2 hover:opacity-80">الصحة</a>
              <a href="#/education" className="px-3 py-2 hover:opacity-80">التعليم</a>
              <a href="#/ngo" className="px-3 py-2 hover:opacity-80">الجمعيات</a>
              <a href="#/wallet" className="px-3 py-2 hover:opacity-80">الرعايات/المحفظة</a>
              <a href="#/govern" className="px-3 py-2 hover:opacity-80">الحوكمة</a>
              <a href="#/support" className="px-3 py-2 hover:opacity-80">الدعم</a>
              <a href="#/settings" className="px-3 py-2 hover:opacity-80">الإعدادات</a>
            </nav>

            {/* يسار: رؤيــة + تلبية + دور/منطقة */}
            <div className="flex items-center gap-3">
              <div className="hidden md:flex items-center gap-3">
                <LogoVision/>
                <LogoTelbiya/>
              </div>
              <Badge text={ROLES.find(r=>r.id===user.role)?.label ?? "—"}/>
              <select className="text-sm border rounded-lg px-2 py-1" value={user.region}
                onChange={e=>{const u={...user,region:e.target.value};store.set("user",u);window.dispatchEvent(new Event("storage"));}}>
                {REGIONS.map(r=><option key={r} value={r}>{r}</option>)}
              </select>
              <button onClick={onLogout} className="text-xs px-2.5 py-1 rounded-lg border hover:bg-slate-50">تبديل الدور</button>
            </div>
          </div>
        </header>
      );
    };

    const Footer=()=>(
      <footer className="py-10 border-t border-slate-200 mt-12">
        <div className="container px-3 sm:px-4 text-sm text-slate-600 grid sm:grid-cols-3 gap-6 items-center">
          <div className="flex items-center gap-3">
            <LogoNOMU className="h-7 w-auto"/><span>© {new Date().getFullYear()} — منصة نمو</span>
          </div>
          <div className="text-center">
            <span className="opacity-70">بمواءمة رؤية 2030 وبدعم تلبية</span>
          </div>
          <div className="flex justify-end gap-4">
            <a href="#/kpis" className="hover:opacity-80">المؤشرات</a>
            <a href="#/support" className="hover:opacity-80">الدعم</a>
          </div>
        </div>
      </footer>
    );

    /* ====================== Auth / Login ====================== */
    const Login=({onLogin})=>{
      const [role,setRole]=useState(store.get("user",{role:"family"}).role||"family");
      const [region,setRegion]=useState(store.get("user",{region:"الرياض"}).region||"الرياض");
      const [name,setName]=useState(store.get("user",{name:""}).name||"");
      return (
        <div className="min-h-screen bg-gradient-to-tr from-nomu-50 via-white to-sky-50">
          <div className="container px-3 sm:px-4 py-16">
            <div className="flex items-center justify-between">
              <LogoNOMU className="h-10 w-auto"/>
              <div className="flex items-center gap-4"><LogoVision/><LogoTelbiya/></div>
            </div>
            <h1 className="mt-6 text-xl sm:text-2xl font-bold text-center">مرحبًا بك في منصة نمو</h1>
            <p className="mt-2 text-center text-slate-600">اختر الدور والمنطقة لبدء التجربة</p>
            <div className="mt-6 bg-white border border-slate-200 rounded-2xl shadow-sm p-5 grid md:grid-cols-3 gap-4">
              <div><label className="text-sm text-slate-600">الدور</label>
                <select className="w-full rounded-xl border px-3 py-2 mt-1" value={role} onChange={e=>setRole(e.target.value)}>
                  {ROLES.map(r=><option key={r.id} value={r.id}>{r.label}</option>)}
                </select></div>
              <div><label className="text-sm text-slate-600">المنطقة</label>
                <select className="w-full rounded-xl border px-3 py-2 mt-1" value={region} onChange={e=>setRegion(e.target.value)}>
                  {REGIONS.map(r=><option key={r} value={r}>{r}</option>)}
                </select></div>
              <div><label className="text-sm text-slate-600">الاسم (اختياري)</label>
                <input className="w-full rounded-xl border px-3 py-2 mt-1" value={name} onChange={e=>setName(e.target.value)} placeholder="اسم المستخدم"/></div>
              <div className="md:col-span-3 flex items-center justify-between">
                <div className="text-xs text-slate-500">نسخة تشغيلية تجريبية — بيانات محلية.</div>
                <button onClick={()=>{store.set("user",{role,region,name});onLogin();}} className="rounded-xl bg-nomu-600 text-white px-4 py-2.5 hover:bg-nomu-700">دخول</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    /* ====================== Home (Enhanced) ====================== */
    const Home=()=>{
      const user=store.get("user",{});
      const notes=store.get("notifications",[]);
      return (
        <main>
          {/* Hero */}
          <section className="bg-gradient-to-l from-nomu-50 via-white to-sky-50">
            <div className="container px-3 sm:px-4 py-12">
              <div className="rounded-3xl border bg-white shadow-sm p-6 md:p-8 flex flex-col lg:flex-row gap-6 items-center">
                <div className="flex-1">
                  <h1 className="text-2xl md:text-3xl font-extrabold">منصة وطنية للتكامل بين الأسرة والصحة والتعليم والشركاء</h1>
                  <p className="mt-3 text-slate-600 leading-7">
                    تربط <b>نمو</b> رحلة الطفل (0–6) بخدمات الجهات، وتحوّل الإحالات إلى نتائج ملموسة، وتعرض مؤشرات أثر
                    متوائمة مع <b>رؤية 2030</b>، وبدعم تقني من <b>تلبية</b>.
                  </p>
                  <div className="mt-4 flex flex-wrap gap-2">
                    <a href="#/journey" className="px-4 py-2 rounded-xl bg-nomu-600 text-white hover:bg-nomu-700">ابدأ رحلة الطفل</a>
                    <a href="#/referrals" className="px-4 py-2 rounded-xl border hover:bg-slate-50">فتح إحالة</a>
                    <a href="#/kpis" className="px-4 py-2 rounded-xl border hover:bg-slate-50">عرض المؤشرات</a>
                  </div>
                </div>
                <div className="w-full lg:w-1/3 grid grid-cols-2 gap-3">
                  <div className="rounded-2xl border bg-emerald-50 p-4 text-center">
                    <div className="text-3xl font-bold">+90%</div><div className="text-xs mt-1">تحصين أساسي</div>
                  </div>
                  <div className="rounded-2xl border bg-sky-50 p-4 text-center">
                    <div className="text-3xl font-bold">≤24س</div><div className="text-xs mt-1">وسيط إغلاق الإحالات</div>
                  </div>
                  <div className="rounded-2xl border bg-amber-50 p-4 text-center">
                    <div className="text-3xl font-bold">+85%</div><div className="text-xs mt-1">التحاق رياض الأطفال</div>
                  </div>
                  <div className="rounded-2xl border bg-fuchsia-50 p-4 text-center">
                    <div className="text-3xl font-bold">+95%</div><div className="text-xs mt-1">اكتمال السجل الأسري</div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          {/* Value Cards */}
          <section className="container px-3 sm:px-4 py-8">
            <div className="grid md:grid-cols-3 gap-4">
              <div className="rounded-2xl border bg-white p-5 shadow-sm">
                <h3 className="font-semibold">سير عمل مُحكم</h3>
                <p className="mt-2 text-sm text-slate-600">من فتح الإحالة حتى الإغلاق، مع SLA وتنبيهات وتعليقات ومرفقات.</p>
              </div>
              <div className="rounded-2xl border bg-white p-5 shadow-sm">
                <h3 className="font-semibold">تكامل وطني</h3>
                <p className="mt-2 text-sm text-slate-600">مواءمة مع نفاذ، NPHIES، نظام نور، والدفع المحلي عند الحاجة.</p>
              </div>
              <div className="rounded-2xl border bg-white p-5 shadow-sm">
                <h3 className="font-semibold">قياس أثر</h3>
                <p className="mt-2 text-sm text-slate-600">لوحات KPIs وارتباطها بسوق الرعايات ونتائج الجهات.</p>
              </div>
            </div>
          </section>

          {/* Target Audiences */}
          <section className="container px-3 sm:px-4 pb-8">
            <h2 className="text-xl font-bold mb-3">لمن صُمّمت نمو؟</h2>
            <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {["الأسرة","الصحة","التعليم","الجمعيات","القطاع الخاص (CSR)","اللجنة الوطنية"].map(x=>(
                <div key={x} className="rounded-2xl border bg-white p-5 shadow-sm flex items-center justify-between">
                  <span className="font-semibold">{x}</span>
                  <a href="#/referrals" className="text-sm underline decoration-nomu-400">بدء الاستخدام</a>
                </div>
              ))}
            </div>
          </section>

          {/* Alerts */}
          <section className="container px-3 sm:px-4 pb-8">
            <div className="grid md:grid-cols-3 gap-4">
              {notes.map(n=>(
                <div key={n.id} className={cn("rounded-xl border p-4 text-sm", n.level==="warn"?"bg-amber-50 border-amber-200":"bg-sky-50 border-sky-200")}>
                  {n.text}
                </div>
              ))}
            </div>
          </section>
        </main>
      );
    };

    /* ====================== KPIs ====================== */
    const KPIs=()=>{
      const user=store.get("user",{});
      const k=store.get("kpis",{});
      const current=k.byRegion[user.region] ?? Object.values(k.byRegion)[0];
      const [period,setPeriod]=useState(k.period||"آخر 30 يومًا");
      useEffect(()=>{const s=store.get("kpis",{}); s.period=period; store.set("kpis",s);},[period]);
      return (
        <main className="container px-3 sm:px-4 py-8">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold">مؤشرات الأداء — {user.region}</h2>
            <select className="border rounded-xl px-3 py-2 text-sm" value={period} onChange={e=>setPeriod(e.target.value)}>
              {["آخر 7 أيام","آخر 30 يومًا","آخر 90 يومًا","سنة كاملة"].map(p=><option key={p} value={p}>{p}</option>)}
            </select>
          </div>
          <div className="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <Stat label="التغطية 0–6" value={current.coverage} ok={current.coverage>=80}/>
            <Stat label="اكتمال التحصين" value={current.immunization} ok={current.immunization>=90}/>
            <Stat label="جاهزية التعليم" value={current.readiness} ok={current.readiness>=75}/>
            <div className="rounded-2xl p-5 border bg-sky-50 border-sky-200">
              <div className="text-sm text-slate-600">وسيط إغلاق الإحالات</div>
              <div className="mt-2 text-3xl font-bold">{current.referralsMedianHrs}<span className="text-xl">س</span></div>
              <div className="mt-1 text-xs inline-block px-2 py-1 rounded-full bg-sky-100 text-sky-800">≤ 24 ساعة مستهدف</div>
            </div>
            <Stat label="التحاق رياض الأطفال" value={current.kgEnroll} ok={current.kgEnroll>=85}/>
            <Stat label="اكتمال السجل الأسري" value={current.completeness} ok={current.completeness>=95}/>
          </div>
        </main>
      );
    };

    /* ====================== Journey ====================== */
    const Journey=()=>{
      const children=store.get("children",[]);
      const screenings=store.get("screenings",[]);
      return (
        <main className="container px-3 sm:px-4 py-8">
          <h2 className="text-xl font-bold">رحلة الطفل (0–6)</h2>
          <div className="mt-4 grid lg:grid-cols-2 gap-6">
            <div className="rounded-2xl border bg-white p-5 shadow-sm">
              <h3 className="font-semibold">أطفال الأسرة</h3>
              <ul className="mt-3 text-sm">
                {children.map(c=>(
                  <li key={c.id} className="border-t first:border-0 py-2">
                    <div className="flex items-center justify-between">
                      <div><b>{c.name}</b> — {c.gender==="M"?"ذكر":"أنثى"} — مولود {c.birthDate}</div>
                      <Badge text={c.region}/>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
            <div className="rounded-2xl border bg-white p-5 shadow-sm">
              <h3 className="font-semibold">الفحوص/التقييمات</h3>
              <ul className="mt-3 text-sm">
                {screenings.map(s=>(
                  <li key={s.id} className="border-t first:border-0 py-2">
                    <div className="flex items-center justify-between">
                      <div><b>{s.type}</b> — {s.date}</div>
                      <Badge text={s.result==="PASS"?"سليم":"متابعة"} color={s.result==="PASS"?"bg-emerald-100 text-emerald-800":"bg-amber-100 text-amber-800"}/>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </main>
      );
    };

    /* ====================== Referrals (Role-aware Forms) ====================== */
    const Referrals=()=>{
      const [list,setList]=useState(store.get("referrals",[]));
      const [q,setQ]=useState(""); const [modal,setModal]=useState(false);
      const user=store.get("user",{role:"family",region:"الرياض"});
      const [form,setForm]=useState({ child:"", type:"صحي", region:user.region, notes:"", meta:{} });
      useEffect(()=>store.set("referrals",list),[list]);
      const filtered=list.filter(r=>[r.id,r.child,r.type,r.status,r.region,r.notes,JSON.stringify(r.meta)].join(" ").includes(q));

      const extraFields=ROLE_FORMS[user.role]||[];
      const setExtra=(k,v)=>setForm(prev=>({...prev, meta:{...prev.meta,[k]:v}}));

      const setStatus=(id,status)=>setList(prev=>prev.map(r=>r.id===id?{...r,status}:r));
      const addReferral=()=>{
        if(!form.child) return alert("يرجى إدخال اسم الطفل.");
        // تحقق سريع من الحقول المطلوبة حسب الدور
        for(const f of extraFields.filter(f=>f.required)){
          if(!form.meta || !form.meta[f.key]) return alert(`الرجاء تعبئة الحقل: ${f.label}`);
        }
        const id="RF-"+Math.random().toString(36).slice(2,6).toUpperCase();
        setList(prev=>[{ id, child:form.child, type:form.type, status:"مفتوحة", created:new Date().toISOString().slice(0,10), region:form.region, notes:form.notes, meta:form.meta },...prev]);
        setModal(false); setForm({ child:"", type:"صحي", region:user.region, notes:"", meta:{} });
      };

      return (
        <main className="container px-3 sm:px-4 py-8">
          <div className="flex items-center justify-between flex-wrap gap-3">
            <h2 className="text-xl font-bold">الإحالات</h2>
            <div className="flex items-center gap-2">
              <input className="rounded-xl border px-3 py-2 text-sm" placeholder="بحث..." value={q} onChange={e=>setQ(e.target.value)}/>
              <button className="rounded-xl bg-nomu-600 text-white px-3 py-2 text-sm hover:bg-nomu-700" onClick={()=>setModal(true)}>فتح إحالة</button>
            </div>
          </div>

          <div className="mt-4 overflow-x-auto rounded-2xl border bg-white shadow-sm">
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-600">
                <tr>
                  <th className="p-3 text-right">المعرف</th>
                  <th className="p-3 text-right">الطفل</th>
                  <th className="p-3 text-right">النوع</th>
                  <th className="p-3 text-right">الحالة</th>
                  <th className="p-3 text-right">التاريخ</th>
                  <th className="p-3 text-right">المنطقة</th>
                  <th className="p-3 text-right">ملاحظات</th>
                  <th className="p-3 text-right">تفاصيل الدور</th>
                  <th className="p-3"></th>
                </tr>
              </thead>
              <tbody>
                {filtered.map(r=>(
                  <tr key={r.id} className="border-t align-top">
                    <td className="p-3">{r.id}</td>
                    <td className="p-3">{r.child}</td>
                    <td className="p-3">{r.type}</td>
                    <td className="p-3">{r.status}</td>
                    <td className="p-3">{r.created}</td>
                    <td className="p-3">{r.region}</td>
                    <td className="p-3">{r.notes||"-"}</td>
                    <td className="p-3">
                      <div className="text-xs text-slate-700 space-y-1">
                        {Object.entries(r.meta||{}).map(([k,v])=><div key={k}><b>{k}:</b> {String(v)}</div>)}
                        {(!r.meta || Object.keys(r.meta).length===0) && <span className="opacity-60">—</span>}
                      </div>
                    </td>
                    <td className="p-3 text-left">
                      <div className="flex gap-2">
                        <button className="text-xs px-2 py-1 rounded border hover:bg-slate-50" onClick={()=>setStatus(r.id,"قيد المعالجة")}>بدء</button>
                        <button className="text-xs px-2 py-1 rounded border hover:bg-slate-50" onClick={()=>setStatus(r.id,"مغلقة")}>إغلاق</button>
                      </div>
                    </td>
                  </tr>
                ))}
                {filtered.length===0 && <tr><td className="p-4 text-center text-slate-500" colSpan="9">لا نتائج.</td></tr>}
              </tbody>
            </table>
          </div>

          {modal && (
            <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-4">
              <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl">
                <div className="p-4 border-b flex items-center justify-between">
                  <div>
                    <h3 className="font-semibold">فتح إحالة جديدة</h3>
                    <div className="text-xs text-slate-500 mt-1">الدور الحالي: <b>{ROLES.find(r=>r.id===user.role)?.label}</b> — سيتم تطبيق حقول مخصصة.</div>
                  </div>
                  <button className="p-2 rounded hover:bg-slate-100" onClick={()=>setModal(false)}>✕</button>
                </div>
                <div className="p-4 grid md:grid-cols-2 gap-3">
                  <input className="rounded-xl border px-3 py-2" placeholder="اسم الطفل" value={form.child} onChange={e=>setForm({...form,child:e.target.value})}/>
                  <select className="rounded-xl border px-3 py-2" value={form.type} onChange={e=>setForm({...form,type:e.target.value})}>
                    {["صحي","نمائي 0–3","تعليمي","دعم أسري"].map(t=><option key={t}>{t}</option>)}
                  </select>
                  <select className="rounded-xl border px-3 py-2" value={form.region} onChange={e=>setForm({...form,region:e.target.value})}>
                    {REGIONS.map(r=><option key={r}>{r}</option>)}
                  </select>
                  <input className="rounded-xl border px-3 py-2" placeholder="وصف مختصر/عنوان" value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})}/>

                  {/* حقول الدور الإضافية */}
                  <div className="md:col-span-2 rounded-xl border p-3 bg-slate-50">
                    <div className="text-sm font-semibold mb-2">حقول مخصّصة لدورك</div>
                    <div className="grid md:grid-cols-2 gap-3">
                      {extraFields.map(f=>{
                        if(f.type==="select") return (
                          <div key={f.key}>
                            <label className="text-xs text-slate-600">{f.label}{f.required&&" *"}</label>
                            <select className="w-full rounded-xl border px-3 py-2 mt-1" value={form.meta[f.key]||""} onChange={e=>setExtra(f.key,e.target.value)}>
                              <option value="">— اختر —</option>
                              {f.options.map(o=><option key={o} value={o}>{o}</option>)}
                            </select>
                          </div>
                        );
                        if(f.type==="textarea") return (
                          <div key={f.key} className="md:col-span-2">
                            <label className="text-xs text-slate-600">{f.label}{f.required&&" *"}</label>
                            <textarea rows="3" className="w-full rounded-2xl border px-3 py-2 mt-1" value={form.meta[f.key]||""} onChange={e=>setExtra(f.key,e.target.value)}></textarea>
                          </div>
                        );
                        return (
                          <div key={f.key}>
                            <label className="text-xs text-slate-600">{f.label}{f.required&&" *"}</label>
                            <input className="w-full rounded-xl border px-3 py-2 mt-1" type={f.type||"text"} value={form.meta[f.key]||""} onChange={e=>setExtra(f.key,e.target.value)}/>
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  <div className="md:col-span-2 flex items-center justify-end gap-2">
                    <button className="rounded-xl border px-4 py-2 hover:bg-slate-50" onClick={()=>setModal(false)}>إلغاء</button>
                    <button className="rounded-xl bg-nomu-600 text-white px-4 py-2 hover:bg-nomu-700" onClick={addReferral}>حفظ الإحالة</button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </main>
      );
    };

    /* ====================== Health / Education / NGO / Wallet / Govern / Support / Settings / Admin ====================== */
    const Health=()=>{
      const screenings=store.get("screenings",[]); const [type,setType]=useState("all");
      const list=useMemo(()=>type==="all"?screenings:screenings.filter(s=>s.type===type),[screenings,type]);
      return (
        <main className="container px-3 sm:px-4 py-8">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold">الصحة — الفحوص والتتبّع</h2>
            <select className="border rounded-xl px-3 py-2 text-sm" value={type} onChange={e=>setType(e.target.value)}>
              <option value="all">الكل</option>
              <option value="newborn_hearing">فحص سمع المواليد</option>
              <option value="metabolic">استقلابي</option>
              <option value="developmental">نمائي</option>
              <option value="vision">بصري</option>
            </select>
          </div>
          <div className="mt-4 rounded-2xl border bg-white p-4 shadow-sm">
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-600"><tr><th className="p-3 text-right">المعرف</th><th className="p-3 text-right">الطفل</th><th className="p-3 text-right">النوع</th><th className="p-3 text-right">التاريخ</th><th className="p-3 text-right">النتيجة</th></tr></thead>
              <tbody>
                {list.map(s=>(
                  <tr key={s.id} className="border-t">
                    <td className="p-3">{s.id}</td>
                    <td className="p-3">{store.get("children",[]).find(c=>c.id===s.childId)?.name || "-"}</td>
                    <td className="p-3">{s.type}</td><td className="p-3">{s.date}</td><td className="p-3">{s.result}</td>
                  </tr>
                ))}
                {list.length===0 && <tr><td className="p-4 text-center text-slate-500" colSpan="5">لا سجلات.</td></tr>}
              </tbody>
            </table>
          </div>
        </main>
      );
    };

    const Education=()=>{
      const [applications,setApps]=useState([
        {id:"KG-01", child:"سعود", status:"قيد المراجعة", region:"الرياض", date:"2025-09-15"},
        {id:"KG-02", child:"نورة", status:"مقبول", region:"الرياض", date:"2025-10-03"}
      ]);
      const approve=id=>setApps(prev=>prev.map(a=>a.id===id?{...a,status:"مقبول"}:a));
      return (
        <main className="container px-3 sm:px-4 py-8">
          <h2 className="text-xl font-bold">التعليم — رياض الأطفال والجاهزية</h2>
          <div className="mt-4 rounded-2xl border bg-white p-4 shadow-sm">
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-600"><tr><th className="p-3 text-right">المعرف</th><th className="p-3 text-right">الطفل</th><th className="p-3 text-right">الحالة</th><th className="p-3 text-right">التاريخ</th><th className="p-3 text-right">المنطقة</th><th className="p-3"></th></tr></thead>
              <tbody>
                {applications.map(a=>(
                  <tr key={a.id} className="border-t">
                    <td className="p-3">{a.id}</td><td className="p-3">{a.child}</td><td className="p-3">{a.status}</td>
                    <td className="p-3">{a.date}</td><td className="p-3">{a.region}</td>
                    <td className="p-3 text-left">{a.status!=="مقبول" && <button className="text-xs px-2 py-1 rounded border hover:bg-slate-50" onClick={()=>approve(a.id)}>قبول</button>}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </main>
      );
    };

    const NGO=()=>{
      const [cases,setCases]=useState([
        {id:"NGO-11", title:"جلسة إرشاد أسري", status:"مجدولة", region:"الرياض"},
        {id:"NGO-12", title:"دعم تدخل مبكر", status:"منفذة", region:"الرياض"}
      ]);
      return (
        <main className="container px-3 sm:px-4 py-8">
          <h2 className="text-xl font-bold">الجمعيات — إدارة البرامج</h2>
          <div className="mt-4 grid md:grid-cols-2 gap-4">
            {cases.map(c=>(
              <div key={c.id} className="rounded-2xl border bg-white p-5 shadow-sm">
                <div className="flex items-center justify-between">
                  <b>{c.title}</b>
                  <Badge text={c.status} color={c.status==="منفذة"?"bg-emerald-100 text-emerald-800":"bg-sky-100 text-sky-800"}/>
                </div>
                <div className="text-sm text-slate-600 mt-2">المعرف: {c.id} — المنطقة: {c.region}</div>
              </div>
            ))}
          </div>
        </main>
      );
    };

    const Wallet=()=>{
      const [state,setState]=useState(store.get("wallet",{total:0,entries:[]}));
      const [form,setForm]=useState({ source:"", amount:"", tag:"CSR" });
      useEffect(()=>store.set("wallet",state),[state]);
      const add=()=>{
        if(!form.source || !Number(form.amount)) return;
        const id="TRX-"+Math.random().toString(36).slice(2,6).toUpperCase();
        const e={id,source:form.source,amount:Number(form.amount),date:new Date().toISOString().slice(0,10),tag:form.tag};
        setState(prev=>({ total: prev.total+e.amount, entries:[e,...prev.entries]}));
        setForm({source:"",amount:"",tag:"CSR"});
      };
      return (
        <main className="container px-3 sm:px-4 py-8">
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 rounded-2xl border bg-white shadow-sm">
              <div className="p-4 border-b flex items-center justify-between">
                <h2 className="text-lg font-semibold">سوق الرعايات/المحفظة</h2>
                <Badge text={`الإجمالي: ${state.total.toLocaleString()} ر.س`} color="bg-nomu-100 text-nomu-900"/>
              </div>
              <div className="p-4 overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50 text-slate-600"><tr><th className="p-3 text-right">المعرف</th><th className="p-3 text-right">المصدر</th><th className="p-3 text-right">التصنيف</th><th className="p-3 text-right">المبلغ</th><th className="p-3 text-right">التاريخ</th></tr></thead>
                  <tbody>
                    {state.entries.map(e=>(
                      <tr key={e.id} className="border-t">
                        <td className="p-3">{e.id}</td><td className="p-3">{e.source}</td><td className="p-3"><Badge text={e.tag}/></td>
                        <td className="p-3">{e.amount.toLocaleString()} ر.س</td><td className="p-3">{e.date}</td>
                      </tr>
                    ))}
                    {state.entries.length===0 && <tr><td className="p-4 text-center text-slate-500" colSpan="5">لا توجد عمليات بعد.</td></tr>}
                  </tbody>
                </table>
              </div>
            </div>
            <div className="rounded-2xl border bg-white shadow-sm p-4">
              <h3 className="font-semibold">إضافة مساهمة</h3>
              <div className="mt-3 grid gap-2">
                <input className="rounded-xl border px-3 py-2" placeholder="المصدر (شركة/منحة/متبرع)" value={form.source} onChange={e=>setForm({...form,source:e.target.value})}/>
                <input type="number" min="1" className="rounded-xl border px-3 py-2" placeholder="المبلغ (ر.س)" value={form.amount} onChange={e=>setForm({...form,amount:e.target.value})}/>
                <select className="rounded-xl border px-3 py-2" value={form.tag} onChange={e=>setForm({...form,tag:e.target.value})}>
                  {["CSR","Grant","Donation","Other"].map(t=><option key={t}>{t}</option>)}
                </select>
                <button className="rounded-xl bg-nomu-600 text-white py-2.5 hover:bg-nomu-700" onClick={add}>إضافة</button>
                <p className="text-xs text-slate-500">سيُربط لاحقًا كل تمويل بمؤشرات أثر وحالات.</p>
              </div>
            </div>
          </div>
        </main>
      );
    };

    const Govern=()=>{
      const policies=[
        "الامتثال لنظام حماية البيانات الشخصية (PDPL).",
        "سجل تدقيق (Audit Log) على كل العمليات.",
        "نموذج صلاحيات RBAC حسب الدور والجهة والمنطقة.",
        "سياسة احتفاظ بيانات ونسخ احتياطي واستعادة.",
      ];
      return (
        <main className="container px-3 sm:px-4 py-8">
          <h2 className="text-xl font-bold">الحوكمة والامتثال</h2>
          <div className="mt-4 grid md:grid-cols-2 gap-4">
            {policies.map((p,i)=>(
              <div key={i} className="rounded-2xl border bg-white p-5 shadow-sm">
                <b>سياسة #{i+1}</b>
                <p className="mt-2 text-sm text-slate-700">{p}</p>
              </div>
            ))}
          </div>
        </main>
      );
    };

    const Support=()=>{
      const [name,setName]=useState(""), [email,setEmail]=useState(""), [msg,setMsg]=useState("");
      const mail=()=>{const s=encodeURIComponent("تواصل — منصة نمو"); const b=encodeURIComponent(`الاسم: ${name}\nالبريد: ${email}\n\n${msg}\n`); window.location.href=`mailto:${CONTACT.email}?subject=${s}&body=${b}`;};
      const wa=()=>{const t=encodeURIComponent(`مرحبًا فريق نمو/تلبية\nاسمي: ${name}\nبريدي: ${email}\n\n${msg}`); window.open(`https://wa.me/${CONTACT.whatsapp}?text=${t}`,"_blank");};
      return (
        <main className="container px-3 sm:px-4 py-8">
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="rounded-2xl border bg-white p-5 shadow-sm">
              <h3 className="font-semibold">قنوات التواصل</h3>
              <ul className="mt-3 space-y-2 text-sm leading-7">
                <li>البريد: <a className="underline decoration-nomu-400 underline-offset-2" href={`mailto:${CONTACT.email}`}>{CONTACT.email}</a></li>
                <li>واتساب: <a className="underline decoration-nomu-400 underline-offset-2" target="_blank" href={`https://wa.me/${CONTACT.whatsapp}`}>+966 55 608 3172</a></li>
              </ul>
            </div>
            <div className="rounded-2xl border bg-white p-5 shadow-sm lg:col-span-2">
              <h3 className="font-semibold">نموذج تواصل سريع</h3>
              <form className="mt-3 grid sm:grid-cols-2 gap-3" onSubmit={(e)=>{e.preventDefault(); mail();}}>
                <input required placeholder="الاسم*" className="rounded-xl border px-3 py-2" value={name} onChange={e=>setName(e.target.value)}/>
                <input required type="email" placeholder="البريد الإلكتروني*" className="rounded-xl border px-3 py-2" value={email} onChange={e=>setEmail(e.target.value)}/>
                <textarea required rows="5" className="sm:col-span-2 rounded-2xl border px-3 py-2" placeholder="وصف الطلب/المشكلة*" value={msg} onChange={e=>setMsg(e.target.value)}></textarea>
                <div className="sm:col-span-2 flex flex-wrap gap-2">
                  <button type="submit" className="rounded-xl bg-nomu-600 text-white px-4 py-2.5 hover:bg-nomu-700">إرسال عبر البريد</button>
                  <button type="button" className="rounded-xl border px-4 py-2.5 hover:bg-slate-50" onClick={wa}>إرسال عبر واتساب</button>
                </div>
              </form>
            </div>
          </div>
        </main>
      );
    };

    const Settings=()=>{
      const [u,setU]=useState(store.get("user",{role:"family",region:"الرياض",name:""}));
      const clear=()=>{
        ["kpis","children","screenings","referrals","wallet","notifications","user","nomu_initialized"].forEach(store.del);
        seed(); location.reload();
      };
      return (
        <main className="container px-3 sm:px-4 py-8">
          <h2 className="text-xl font-bold">الإعدادات</h2>
          <div className="mt-4 grid lg:grid-cols-3 gap-6">
            <div className="rounded-2xl border bg-white p-5 shadow-sm">
              <h3 className="font-semibold">الحساب</h3>
              <div className="mt-3 grid gap-2 text-sm">
                <label>الاسم</label>
                <input className="rounded-xl border px-3 py-2" value={u.name} onChange={e=>{const nu={...u,name:e.target.value}; setU(nu); store.set("user",nu);}}/>
                <label>الدور</label>
                <select className="rounded-xl border px-3 py-2" value={u.role} onChange={e=>{const nu={...u,role:e.target.value}; setU(nu); store.set("user",nu);}}>
                  {ROLES.map(r=><option key={r.id} value={r.id}>{r.label}</option>)}
                </select>
                <label>المنطقة</label>
                <select className="rounded-xl border px-3 py-2" value={u.region} onChange={e=>{const nu={...u,region:e.target.value}; setU(nu); store.set("user",nu);}}>
                  {REGIONS.map(r=><option key={r} value={r}>{r}</option>)}
                </select>
              </div>
            </div>
            <div className="rounded-2xl border bg-white p-5 shadow-sm">
              <h3 className="font-semibold">البيانات</h3>
              <button className="mt-2 rounded-xl border px-3 py-2 hover:bg-slate-50" onClick={clear}>تصفير جميع البيانات</button>
              <p className="text-xs text-slate-500 mt-2">سيتم إعادة توليد بيانات تجريبية.</p>
            </div>
            <div className="rounded-2xl border bg-white p-5 shadow-sm">
              <h3 className="font-semibold">عن المنصة</h3>
              <ul className="mt-2 text-sm text-slate-700 list-disc pr-5 space-y-1">
                <li>هوية مشتركة: نمو (يمين) + رؤية/تلبية (يسار).</li>
                <li>نماذج إدخال **ديناميكية** حسب الدور لضمان اكتمال دورة الحياة.</li>
                <li>البيانات محلية — جاهزة للترقية إلى APIs.</li>
              </ul>
            </div>
          </div>
        </main>
      );
    };

    const Admin=()=>{
      const rolesMatrix=[
        {entity:"الإحالات", family:"R", health:"RW", edu:"RW", ngo:"RW", csr:"R", national:"R", admin:"RW"},
        {entity:"الفحوص",  family:"R", health:"RW", edu:"R",  ngo:"R",  csr:"-", national:"R", admin:"RW"},
        {entity:"التعليم",  family:"R", health:"-",  edu:"RW", ngo:"R",  csr:"-", national:"R", admin:"RW"},
        {entity:"المحفظة",  family:"-", health:"-",  edu:"-",  ngo:"R",  csr:"RW", national:"R", admin:"RW"},
        {entity:"المؤشرات", family:"R", health:"R",  edu:"R",  ngo:"R",  csr:"R",  national:"RW", admin:"RW"},
      ];
      return (
        <main className="container px-3 sm:px-4 py-8">
          <h2 className="text-xl font-bold">إدارة المنصة — مصفوفة الصلاحيات (تجريبي)</h2>
          <div className="mt-4 overflow-x-auto rounded-2xl border bg-white p-4 shadow-sm">
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-600">
                <tr><th className="p-3 text-right">الكيان</th>{ROLES.map(r=><th key={r.id} className="p-3 text-center">{r.label}</th>)}</tr>
              </thead>
              <tbody>
                {rolesMatrix.map((row,i)=>(
                  <tr key={i} className="border-t">
                    <td className="p-3">{row.entity}</td>
                    {ROLES.map(r=><td key={r.id} className="p-3 text-center">{row[r.id]||"-"}</td>)}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </main>
      );
    };

    /* ====================== Router & App ====================== */
    const Router=()=>{
      const [hash,setHash]=useState(window.location.hash||"#/home");
      useEffect(()=>{const on=()=>setHash(window.location.hash||"#/home");window.addEventListener("hashchange",on);return()=>window.removeEventListener("hashchange",on)},[]);
      switch(hash.replace("#","")){
        case "/home": return <Home/>;
        case "/kpis": return <KPIs/>;
        case "/journey": return <Journey/>;
        case "/referrals": return <Referrals/>;
        case "/health": return <Health/>;
        case "/education": return <Education/>;
        case "/ngo": return <NGO/>;
        case "/wallet": return <Wallet/>;
        case "/govern": return <Govern/>;
        case "/support": return <Support/>;
        case "/settings": return <Settings/>;
        case "/admin": return <Admin/>;
        default: return <Home/>;
      }
    };

    const App=()=>{
      const [logged,setLogged]=useState(!!store.get("user",null));
      useEffect(()=>{seed(); if(!window.location.hash) window.location.hash="/home";},[]);
      if(!logged) return <Login onLogin={()=>setLogged(true)}/>;
      return (
        <div className="min-h-screen bg-white">
          <TopBar onLogout={()=>{ localStorage.removeItem("user"); location.hash="#/home"; location.reload(); }}/>
          <Router/>
          <Footer/>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
