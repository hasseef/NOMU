<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نمو NOMU — نموذج أحادي الملف (index.html)</title>
  <meta name="description" content="نمو NOMU — منصة وطنية للطفولة المبكرة. نموذج أحادي الملف مع نماذج موسّعة، RBAC، تصدير CSV، شعارات قابلة للرفع، ودعم ثنائي اللغة (AR/EN)." />
  <style>
    :root{ --bg:#0b1220;--card:#121a2b;--muted:#1a2440;--pri:#5ac8fa;--sec:#8ef6d0;--acc:#ffd166;--danger:#ff6b6b;--ok:#22c55e;--text:#e6edf7;--sub:#a7b0c3;--border:#263251;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px;--pad:18px;--gap:14px;--gap-lg:22px;--font:system-ui,"Segoe UI",Tahoma,Arial;--mono:ui-monospace,Consolas,monospace }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220 0%,#0b1220 50%,#0e172a 100%);color:var(--text);font:15px/1.6 var(--font)}
    a{color:var(--pri);text-decoration:none}
    .app{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .topbar{display:flex;align-items:center;gap:12px;max-width:1200px;margin:auto;padding:10px var(--pad)}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .logo img{width:34px;height:34px;border-radius:8px;object-fit:cover}
    .logo .ph{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--pri),var(--sec))}
    .badge{display:inline-flex;align-items:center;gap:6px;background:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--sub);font-size:12px}
    .search{margin-inline-start:auto;position:relative}
    .search input{width:320px;max-width:60vw;background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 34px 10px 12px;border-radius:10px}
    .search svg{position:absolute;inset-inline-end:10px;top:50%;transform:translateY(-50%);opacity:.7}
    .user{display:flex;align-items:center;gap:10px}
    .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#4158d0,#c850c0 60%,#ffcc70)}

    .main{max-width:1200px;margin:24px auto;display:grid;grid-template-columns:260px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
    nav{position:sticky;top:65px;height:fit-content}
    .side{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px}
    .group{margin:10px 0}
    .group h4{margin:6px 12px 8px;color:var(--sub);font-weight:600;font-size:13px}
    .link{display:flex;align-items:center;gap:10px;border-radius:10px;padding:10px 12px;color:var(--text);border:1px solid transparent}
    .link:hover{background:var(--muted);border-color:var(--border)}
    .link.active{background:linear-gradient(180deg,rgba(90,200,250,.09),rgba(90,200,250,.04));border-color:#274a70}
    .link[hidden]{display:none}

    .content{display:grid;gap:var(--gap-lg)}
    .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .card{grid-column:span 4;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
    .card span.k{display:block;color:var(--sub);font-size:12px}
    .card b.v{display:block;font-size:26px;margin-top:6px}
    .card small{color:var(--sub)}

    .wide{grid-column:span 12}
    .half{grid-column:span 6}
    .third{grid-column:span 4}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button,.btn{background:var(--pri);color:#071426;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(90,200,250,.25)}
    button.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    button.warn{background:var(--acc);color:#1b1100}
    button.danger{background:var(--danger)}
    .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--muted);padding:6px 10px;border-radius:999px;color:var(--sub);font-size:12px}

    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{text-align:right;padding:12px;background:var(--card)}
    th{color:var(--sub);font-size:12px}
    tbody tr{border:1px solid var(--border)}
    tbody td{border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    tbody td:first-child{border-inline-start:1px solid var(--border);border-start-start-radius:10px;border-end-start-radius:10px}
    tbody td:last-child{border-inline-end:1px solid var(--border);border-start-end-radius:10px;border-end-end-radius:10px}

    .grid{display:grid;gap:var(--gap)}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:repeat(3,1fr)}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
    .modal.open{display:grid}
    .modal .box{width:min(680px,94vw);background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:var(--shadow)}

    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--text)}
    label{font-size:13px;color:var(--sub)}
    .field{display:grid;gap:6px;margin:10px 0}
    .help{font-size:12px;color:var(--sub)}

    .empty{border:1px dashed var(--border);border-radius:14px;padding:26px;color:var(--sub);text-align:center}

    .footer{margin:30px auto;max-width:1200px;color:var(--sub);text-align:center;padding:10px}

    @media (max-width:960px){
      .main{grid-template-columns:1fr}
      nav{position:static}
      .cards{grid-template-columns:repeat(6,1fr)}
      .card{grid-column:span 6}
      .half{grid-column:span 6}
      .third{grid-column:span 6}
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="topbar" role="banner">
      <div class="logo" aria-label="NOMU">
        <img id="logo" alt="شعار" class="ph" />
        <span id="t-app">نمو NOMU</span>
        <span class="badge" title="نموذج">Prototype</span>
      </div>
      <nav class="actions" aria-label="التنقل السريع">
        <a class="btn" href="#/home" data-i18n="nav.home">الرئيسية</a>
        <button class="ghost" onclick="openLogin()" data-i18n="nav.login">تسجيل الدخول</button>
        <button class="ghost" onclick="openConsent()" data-i18n="nav.consent">الموافقة والخصوصية</button>
      </nav>
      <div class="search" role="search">
        <input id="q" placeholder="ابحث عن طفل، إحالة، جمعية، مبادرة…" oninput="globalSearch(this.value)" />
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </div>
      <div class="user" aria-label="الحساب">
        <div class="tag" id="roleTag">دخول ضيف</div>
        <div class="avatar" title="المستخدم"></div>
      </div>
    </div>
  </header>

  <main class="main" role="main">
    <nav>
      <div class="side" role="navigation" aria-label="أقسام المنصة">
        <div class="group">
          <h4 data-i18n="nav.dashboards">لوحات القيادة</h4>
          <a class="link active" href="#/home" data-route data-i18n="nav.home">الرئيسية</a>
          <a class="link" href="#/family" data-route data-perm="family:view" data-i18n="nav.family">حساب الأسرة</a>
          <a class="link" href="#/health" data-route data-perm="health:view" data-i18n="nav.health">الصحة</a>
          <a class="link" href="#/education" data-route data-perm="education:view" data-i18n="nav.education">التعليم</a>
          <a class="link" href="#/nonprofit" data-route data-perm="nonprofit:view" data-i18n="nav.nonprofit">الجمعيات</a>
          <a class="link" href="#/csr" data-route data-perm="csr:view" data-i18n="nav.csr">القطاع الخاص (CSR)</a>
          <a class="link" href="#/admin" data-route data-perm="admin:view" data-i18n="nav.admin">اللجنة الوطنية / الإدارة</a>
        </div>
        <div class="group">
          <h4 data-i18n="nav.tools">أدوات</h4>
          <a class="link" href="#/market" data-route data-perm="market:view" data-i18n="nav.market">سوق الرعاية</a>
          <a class="link" href="#/referrals" data-route data-perm="referrals:view" data-i18n="nav.referrals">الإحالات</a>
          <a class="link" href="#/reports" data-route data-perm="reports:view" data-i18n="nav.reports">التقارير</a>
          <a class="link" href="#/settings" data-route data-i18n="nav.settings">الإعدادات</a>
        </div>
      </div>
    </nav>

    <section class="content" id="view"></section>
  </main>

  <footer class="footer" id="footer-note">نمو — نموذج أحادي الملف. البيانات محليًا. يمكن تفعيل API ورفع شعار من الإعدادات.</footer>
</div>

<!-- Modals: Login / Consent / Forms / Logo Upload -->
<div class="modal" id="modal-login" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <div class="box">
    <h3 id="loginTitle" data-i18n="login.title">تسجيل الدخول</h3>
    <p class="help" data-i18n="login.help">اختر نوع الحساب لتجربة الواجهات.</p>
    <div class="grid two">
      <div class="field">
        <label data-i18n="login.role">نوع المستخدم</label>
        <select id="loginRole">
          <option value="guest">ضيف</option>
          <option value="family">أسرة</option>
          <option value="health">الصحة</option>
          <option value="education">التعليم</option>
          <option value="nonprofit">جمعية</option>
          <option value="csr">شركة (CSR)</option>
          <option value="admin">لجنة وطنية</option>
        </select>
      </div>
      <div class="field">
        <label data-i18n="login.region">المنطقة الإدارية</label>
        <select id="loginRegion">
          <option>الرياض</option>
          <option>حائل</option>
          <option>الشرقية</option>
          <option>مكة المكرمة</option>
          <option>المدينة المنورة</option>
        </select>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="doLogin()" data-i18n="btn.login">دخول</button>
      <button class="ghost" onclick="closeModal('modal-login')" data-i18n="btn.cancel">إلغاء</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-consent" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
  <div class="box">
    <h3 id="consentTitle" data-i18n="consent.title">الموافقة وإدارة الخصوصية (PDPL)</h3>
    <div class="grid two">
      <div class="field"><label><input type="checkbox" id="c1"> <span data-i18n="consent.c1">معالجة بيانات الأم خلال الحمل لأغراض المتابعة الصحية</span></label></div>
      <div class="field"><label><input type="checkbox" id="c2"> <span data-i18n="consent.c2">مشاركة تقارير الطفل النمائية مع وزارة التعليم</span></label></div>
      <div class="field"><label><input type="checkbox" id="c3"> <span data-i18n="consent.c3">مشاركة بيانات الدعم الاجتماعي مع الوزارة المختصة</span></label></div>
      <div class="field"><label><input type="checkbox" id="c4"> <span data-i18n="consent.c4">تلقي تنبيهات وتوصيات عبر البريد/الرسائل</span></label></div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="saveConsent()" data-i18n="btn.save">حفظ</button>
      <button class="ghost" onclick="closeModal('modal-consent')" data-i18n="btn.cancel">إلغاء</button>
    </div>
  </div>
</div>

<!-- Forms -->
<div class="modal" id="modal-screening" role="dialog" aria-modal="true" aria-labelledby="screeningTitle">
  <div class="box">
    <h3 id="screeningTitle" data-i18n="screening.title">تسجيل فحص</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_sc_child" placeholder="C-501"></div>
      <div class="field"><label data-i18n="labels.type">نوع الفحص</label><select id="f_sc_type"><option>نمو نمائي</option><option>سمع</option><option>نظر</option><option>نفسي</option></select></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_sc_date" type="date"></div>
      <div class="field"><label data-i18n="labels.result">النتيجة</label><input id="f_sc_result" placeholder="سليم / إحالة / متابعة"></div>
      <div class="field"><label data-i18n="labels.facility">المنشأة</label><input id="f_sc_facility" placeholder="مركز صحي - المنطقة"></div>
    </div>
    <div class="actions"><button onclick="submitScreening()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-screening')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-referral" role="dialog" aria-modal="true" aria-labelledby="refTitle">
  <div class="box">
    <h3 id="refTitle" data-i18n="referral.title">إنشاء إحالة</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.from">من</label><select id="f_ref_from"><option>الأسرة</option><option>الصحة</option><option>التعليم</option><option>جمعية</option></select></div>
      <div class="field"><label data-i18n="labels.to">إلى</label><select id="f_ref_to"><option>الصحة</option><option>التعليم</option><option>جمعية</option></select></div>
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_ref_child" placeholder="C-501"></div>
      <div class="field"><label data-i18n="labels.priority">الأولوية</label><select id="f_ref_pri"><option>عادية</option><option>عاجلة</option></select></div>
      <div class="field"><label data-i18n="labels.status">الحالة</label><select id="f_ref_status"><option>قيد المعالجة</option><option>مكتملة</option></select></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_ref_date" type="date"></div>
    </div>
    <div class="actions"><button onclick="submitReferral()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-referral')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-iep" role="dialog" aria-modal="true" aria-labelledby="iepTitle">
  <div class="box">
    <h3 id="iepTitle" data-i18n="iep.title">إنشاء خطة IEP</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_iep_child" placeholder="C-502"></div>
      <div class="field"><label data-i18n="labels.review">مراجعة</label><input id="f_iep_review" type="date"></div>
      <div class="field" style="grid-column:1/-1"><label data-i18n="labels.goals">الأهداف</label><textarea id="f_iep_goals" rows="3" placeholder="أهداف قابلة للقياس بزمن ومسؤولية"></textarea></div>
    </div>
    <div class="actions"><button onclick="submitIEP()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-iep')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-market" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="box">
    <h3 id="mTitle" data-i18n="market.title">طرح مبادرة</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.title">العنوان</label><input id="f_m_title" placeholder="جلسات تدخل مبكر - الرياض"></div>
      <div class="field"><label data-i18n="labels.kpi">الهدف (KPI)</label><input id="f_m_kpi" placeholder="100 طفل خلال 6 أشهر"></div>
      <div class="field"><label data-i18n="labels.ask">المبلغ المطلوب</label><input id="f_m_ask" type="number" min="0" step="1000" placeholder="100000"></div>
      <div class="field"><label data-i18n="labels.owner">الجهة المالكة</label><input id="f_m_owner" placeholder="جمعية نماء"></div>
    </div>
    <div class="actions"><button onclick="submitMarket()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-market')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-csr" role="dialog" aria-modal="true" aria-labelledby="csrTitle">
  <div class="box">
    <h3 id="csrTitle" data-i18n="csr.title">مساهمة CSR</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.marketId">معرف المبادرة</label><input id="f_csr_to" placeholder="M-1"></div>
      <div class="field"><label data-i18n="labels.company">الشركة</label><input id="f_csr_company" placeholder="شركة الأفق"></div>
      <div class="field"><label data-i18n="labels.amount">المبلغ (ر.س)</label><input id="f_csr_amount" type="number" min="0" step="1000" placeholder="20000"></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_csr_date" type="date"></div>
    </div>
    <div class="actions"><button onclick="submitCSR()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-csr')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<!-- رفع الشعار -->
<div class="modal" id="modal-logo" role="dialog" aria-modal="true" aria-labelledby="logoTitle">
  <div class="box">
    <h3 id="logoTitle" data-i18n="logo.title">رفع شعار الجهة</h3>
    <div class="field"><input type="file" accept="image/*" id="logoFile"></div>
    <div class="actions"><button onclick="uploadLogo()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-logo')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<script>
/* ==========================================================
   NOMU — Single-File Prototype (Enhanced + RBAC + i18n + CSV)
   ========================================================== */

const $ = (q,root=document)=>root.querySelector(q)
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q))

/* ---------- i18n (basic) ---------- */
const i18n = {
  lang: localStorage.getItem('nomu.lang') || 'ar',
  t: {
    ar: {
      'nav.home':'الرئيسية','nav.login':'تسجيل الدخول','nav.consent':'الموافقة والخصوصية','nav.dashboards':'لوحات القيادة','nav.family':'حساب الأسرة','nav.health':'الصحة','nav.education':'التعليم','nav.nonprofit':'الجمعيات','nav.csr':'القطاع الخاص (CSR)','nav.admin':'اللجنة الوطنية / الإدارة','nav.tools':'أدوات','nav.market':'سوق الرعاية','nav.referrals':'الإحالات','nav.reports':'التقارير','nav.settings':'الإعدادات',
      'login.title':'تسجيل الدخول','login.help':'اختر نوع الحساب لتجربة الواجهات.','login.role':'نوع المستخدم','login.region':'المنطقة الإدارية',
      'btn.login':'دخول','btn.cancel':'إلغاء','btn.save':'حفظ','btn.print':'طباعة/حفظ PDF','btn.logo':'رفع شعار',
      'consent.title':'الموافقة وإدارة الخصوصية (PDPL)','consent.c1':'معالجة بيانات الأم خلال الحمل لأغراض المتابعة الصحية','consent.c2':'مشاركة تقارير الطفل النمائية مع وزارة التعليم','consent.c3':'مشاركة بيانات الدعم الاجتماعي مع الوزارة المختصة','consent.c4':'تلقي تنبيهات وتوصيات عبر البريد/الرسائل',
      'labels.childId':'معرف الطفل','labels.type':'نوع الفحص','labels.date':'التاريخ','labels.result':'النتيجة','labels.facility':'المنشأة','labels.from':'من','labels.to':'إلى','labels.priority':'الأولوية','labels.status':'الحالة','labels.review':'مراجعة','labels.goals':'الأهداف','labels.title':'العنوان','labels.kpi':'الهدف (KPI)','labels.ask':'المبلغ المطلوب','labels.owner':'الجهة المالكة','labels.marketId':'معرف المبادرة','labels.company':'الشركة','labels.amount':'المبلغ (ر.س)',
      'screening.title':'تسجيل فحص','referral.title':'إنشاء إحالة','iep.title':'إنشاء خطة IEP','market.title':'طرح مبادرة','csr.title':'مساهمة CSR','logo.title':'رفع شعار الجهة',
      'reports.export':'تصدير CSV'
    },
    en: {
      'nav.home':'Home','nav.login':'Sign in','nav.consent':'Consent & Privacy','nav.dashboards':'Dashboards','nav.family':'Family','nav.health':'Health','nav.education':'Education','nav.nonprofit':'Nonprofits','nav.csr':'Private Sector (CSR)','nav.admin':'National Committee / Admin','nav.tools':'Tools','nav.market':'Care Marketplace','nav.referrals':'Referrals','nav.reports':'Reports','nav.settings':'Settings',
      'login.title':'Sign in','login.help':'Pick a role to explore the UI.','login.role':'Role','login.region':'Region',
      'btn.login':'Sign in','btn.cancel':'Cancel','btn.save':'Save','btn.print':'Print / Save PDF','btn.logo':'Upload Logo',
      'consent.title':'Consent & Privacy (PDPL)','consent.c1':'Process maternal data during pregnancy for healthcare follow-up','consent.c2':'Share child developmental reports with MoE','consent.c3':'Share social support data with the relevant ministry','consent.c4':'Receive alerts/recommendations via email/SMS',
      'labels.childId':'Child ID','labels.type':'Type','labels.date':'Date','labels.result':'Result','labels.facility':'Facility','labels.from':'From','labels.to':'To','labels.priority':'Priority','labels.status':'Status','labels.review':'Review','labels.goals':'Goals','labels.title':'Title','labels.kpi':'KPI','labels.ask':'Requested Amount','labels.owner':'Owner','labels.marketId':'Market ID','labels.company':'Company','labels.amount':'Amount (SAR)',
      'screening.title':'Record Screening','referral.title':'Create Referral','iep.title':'Create IEP','market.title':'Post Initiative','csr.title':'CSR Contribution','logo.title':'Upload Logo',
      'reports.export':'Export CSV'
    }
  }
}
function applyI18n(){
  const dict=i18n.t[i18n.lang]||i18n.t.ar
  $$('[data-i18n]').forEach(el=>{ const key=el.getAttribute('data-i18n'); if(dict[key]) el.textContent=dict[key] })
  document.documentElement.lang = i18n.lang
  document.documentElement.dir = (i18n.lang==='ar')?'rtl':'ltr'
}

/* ---------- API Bridge ---------- */
const api = { enabled:false, baseUrl:'https://api.example.com', token:null }
async function apiFetch(path,opts={}){ if(!api.enabled){ throw new Error('API_DISABLED') } const res = await fetch(api.baseUrl+path,{ headers:Object.assign({'Content-Type':'application/json', ...(api.token?{Authorization:'Bearer '+api.token}:{})}), ...opts }); if(!res.ok){ const t=await res.text(); throw new Error('API '+res.status+': '+t) } return res.json() }

/* ---------- RBAC ---------- */
const permsByRole = {
  guest: ['home:view','reports:view','market:view','referrals:view','settings:view'],
  family:['home:view','family:view','referrals:view','screening:create','settings:view'],
  health:['home:view','health:view','screening:create','referrals:create','reports:view','settings:view'],
  education:['home:view','education:view','iep:create','referrals:view','reports:view','settings:view'],
  nonprofit:['home:view','nonprofit:view','market:create','reports:view','settings:view'],
  csr:['home:view','csr:view','csr:create','market:view','reports:view','settings:view'],
  admin:['home:view','admin:view','family:view','health:view','education:view','nonprofit:view','csr:view','market:view','referrals:view','reports:view','settings:view']
}
function can(perm){ const role=store.state.user.role||'guest'; const allow=(permsByRole[role]||[]).includes(perm); return allow }
function enforceRBAC(){ $$('[data-perm]').forEach(el=>{ const need=el.getAttribute('data-perm'); el.hidden=!can(need) }) }

/* ---------- Store ---------- */
const store = {
  load(){
    try{const data=JSON.parse(localStorage.getItem('nomu')||'{}');this.state=Object.assign({
      user:{role:'guest',region:'الرياض'}, ui:{logo:null},
      consent:{c1:false,c2:false,c3:false,c4:false},
      households:[{id:'H-1001', father:'محمد', mother:'سارة', region:'حائل', children:[{id:'C-501', name:'ليان', dob:'2021-03-10'},{id:'C-502', name:'تركي', dob:'2019-11-02'}]}],
      screenings:[{id:'S-9001', childId:'C-501', type:'نمو نمائي', date:'2025-09-20', result:'سليم', facility:'مركز صحي شمال حائل'}],
      referrals:[{id:'R-7001', from:'الصحة', to:'التعليم', childId:'C-502', priority:'عادية', status:'قيد المعالجة', created:'2025-09-25'}],
      ieps:[{id:'IEP-3001', childId:'C-502', goals:'تحسين المهارات اللغوية', review:'2025-12-01'}],
      nonprofits:[{id:'NPO-10', name:'جمعية نماء للطفولة', region:'حائل', programs:3, beneficiaries:120}],
      marketplace:[{id:'M-1', title:'جلسات تدخل مبكر لحائل', kpi:'100 طفل خلال 6 أشهر', ask:250000, funded:120000, owner:'جمعية نماء'}, {id:'M-2', title:'فحوص سمع لحديثي الولادة – الشرقية', kpi:'300 وليد', ask:180000, funded:45000, owner:'صحة الشرقية'}],
      csr:[{id:'CSR-100', company:'شركة الأفق', amount:50000, to:'M-1', date:'2025-10-01'}]
    }, data)}catch(e){this.state={}}
  },
  save(){localStorage.setItem('nomu',JSON.stringify(this.state))}
}
store.load()

/* ---------- Utilities ---------- */
function fmt(n){return new Intl.NumberFormat(i18n.lang==='ar'?'ar-SA':'en-US').format(n)}
function today(){return new Date().toISOString().slice(0,10)}
function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',bottom:'18px',left:'18px',background:'#111b',color:'#fff',padding:'10px 14px',borderRadius:'12px',backdropFilter:'blur(4px)',zIndex:9999}); document.body.appendChild(t); setTimeout(()=>t.remove(),2200) }
function escapeHtml(str){return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'})); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000) }

/* ---------- Router ---------- */
const routes = { '/home': viewHome, '/family': viewFamily, '/health': viewHealth, '/education': viewEducation, '/nonprofit': viewNonprofit, '/csr': viewCSR, '/admin': viewAdmin, '/market': viewMarket, '/referrals': viewReferrals, '/reports': viewReports, '/settings': viewSettings }
function router(){ const path = location.hash.replace('#','') || '/home'; $$('a.link').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===`#${path}`)); const el = document.getElementById('view'); el.innerHTML=''; (routes[path]||view404)(el); enforceRBAC(); applyI18n() }
window.addEventListener('hashchange',router)

/* ---------- Cards helper ---------- */
function kpiCard(title,value,delta){ return `<div class="card third"><span class="k">${title}</span><b class="v">${value}</b><small>${delta||''}</small></div>` }

/* ---------- Views ---------- */
function viewHome(root){
  const totalKids = store.state.households.reduce((a,h)=>a+h.children.length,0)
  const screened = store.state.screenings.length
  const referrals = store.state.referrals.length
  const funded = store.state.marketplace.reduce((a,m)=>a+m.funded,0)
  root.innerHTML = `
    <div class="toolbar">
      <h2>${i18n.lang==='ar'?'لوحة وطنية مختصرة':'National Overview'}</h2>
      <div class="actions">
        <span class="tag">${i18n.lang==='ar'?'المنطقة':'Region'}: ${store.state.user.region}</span>
        <button onclick="location.hash='#/reports'">${i18n.lang==='ar'?'عرض التقارير':'Open Reports'}</button>
      </div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'الأطفال في السجل':'Registered Children', fmt(totalKids), '—')}
      ${kpiCard(i18n.lang==='ar'?'فحوص نمائية مُسجلة':'Recorded Screenings', fmt(screened))}
      ${kpiCard(i18n.lang==='ar'?'إحالات نشطة':'Active Referrals', fmt(referrals))}
      ${kpiCard(i18n.lang==='ar'?'تمويل CSR/منح (ر.س)':'CSR/Grants Funding (SAR)', fmt(funded))}
      <div class="card wide" id="chart"></div>
      <div class="card half">
        <div class="toolbar"><b>${i18n.lang==='ar'?'آخر المبادرات في سوق الرعاية':'Latest Marketplace Initiatives'}</b><div class="actions"><button class="ghost" onclick="location.hash='#/market'">${i18n.lang==='ar'?'إدارة':'Manage'}</button></div></div>
        ${tableMarketplace(store.state.marketplace.slice(0,5))}
      </div>
      <div class="card half">
        <div class="toolbar"><b>${i18n.lang==='ar'?'آخر الإحالات':'Recent Referrals'}</b><div class="actions"><button class="ghost" onclick="location.hash='#/referrals'">${i18n.lang==='ar'?'إدارة':'Manage'}</button></div></div>
        ${tableReferrals(store.state.referrals.slice(0,5))}
      </div>
    </div>`
  drawTrend($('#chart'), i18n.lang==='ar'?'أطفال مفحوصون خلال 6 أشهر':'Screened Children (6m)', [40,55,61,70,86,93])
}

function viewFamily(root){
  if(!can('family:view')){ return (root.innerHTML = denyCard()) }
  const h = store.state.households[0]
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'حساب الأسرة':'Family Account'}</h2><div class="actions">${can('screening:create')?`<button onclick=\"openModal('modal-screening')\">${i18n.lang==='ar'?'حجز/تسجيل فحص':'Book/Record Screening'}</button>`:''}${can('referrals:create')?`<button class=\"ghost\" onclick=\"openModal('modal-referral')\">${i18n.lang==='ar'?'طلب إحالة':'Create Referral'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'الأطفال':'Children', h.children.length)}
    ${kpiCard(i18n.lang==='ar'?'فحوص مكتملة':'Completed Screenings', store.state.screenings.filter(s=>h.children.some(c=>c.id===s.childId)).length)}
    ${kpiCard(i18n.lang==='ar'?'إحالات مرتبطة':'Related Referrals', store.state.referrals.filter(r=>h.children.some(c=>c.id===r.childId)).length)}
    <div class="card wide">
      <div class="toolbar"><b>${i18n.lang==='ar'?'أطفال الأسرة':'Children'}</b><div class="actions"><button class="ghost" onclick="addChild()">${i18n.lang==='ar'?'إضافة طفل':'Add Child'}</button></div></div>
      ${tableKids(h.children)}
    </div>
    <div class="card half">
      <b>${i18n.lang==='ar'?'الفحوص':'Screenings'}</b>
      ${tableScreenings(store.state.screenings.filter(s=>h.children.some(c=>c.id===s.childId)))}
    </div>
    <div class="card half">
      <b>${i18n.lang==='ar'?'التوصيات الذكية':'Smart Tips'}</b>
      <div class="empty">${i18n.lang==='ar'?'ستظهر التوصيات حسب العمر والفحوص المنجزة.':'Tips will appear based on age and completed screenings.'}</div>
    </div>
  </div>`
}

function viewHealth(root){
  if(!can('health:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'وزارة الصحة':'Ministry of Health'}</h2><div class="actions">${can('screening:create')?`<button onclick=\"openModal('modal-screening')\">${i18n.lang==='ar'?'تسجيل فحص':'Record Screening'}</button>`:''}${can('referrals:create')?`<button class=\"ghost\" onclick=\"openModal('modal-referral')\">${i18n.lang==='ar'?'إحالة للتعليم':'Refer to Education'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'فحوص هذا الشهر':'This Month Screenings', store.state.screenings.filter(s=>s.date.slice(0,7)===today().slice(0,7)).length)}
    ${kpiCard(i18n.lang==='ar'?'متوسط زمن الانتظار (يوم)':'Avg Wait (days)', 7)}
    ${kpiCard(i18n.lang==='ar'?'الإحالات المرسلة':'Referrals Sent', store.state.referrals.filter(r=>r.from==='الصحة').length)}
    <div class="card wide">
      <b>${i18n.lang==='ar'?'سجل الفحوص':'Screenings Log'}</b>
      ${tableScreenings(store.state.screenings)}
    </div>
  </div>`
}

function viewEducation(root){
  if(!can('education:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'وزارة التعليم':'Ministry of Education'}</h2><div class="actions">${can('iep:create')?`<button onclick=\"openModal('modal-iep')\">${i18n.lang==='ar'?'إنشاء IEP':'Create IEP'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'تقارير الجاهزية الصادرة':'Readiness Reports Issued', 42)}
    ${kpiCard(i18n.lang==='ar'?'خطط IEP نشطة':'Active IEPs', store.state.ieps.length)}
    ${kpiCard(i18n.lang==='ar'?'إحالات واردة':'Incoming Referrals', store.state.referrals.filter(r=>r.to==='التعليم').length)}
    <div class="card half">
      <b>${i18n.lang==='ar'?'الإحالات الواردة':'Incoming Referrals'}</b>
      ${tableReferrals(store.state.referrals.filter(r=>r.to==='التعليم'))}
    </div>
    <div class="card half">
      <b>IEP</b>
      ${tableIEP(store.state.ieps)}
    </div>
  </div>`
}

function viewNonprofit(root){
  if(!can('nonprofit:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'الجمعيات':'Nonprofits'}</h2><div class="actions">${can('market:create')?`<button onclick=\"openModal('modal-market')\">${i18n.lang==='ar'?'طرح مبادرة':'Post Initiative'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'برامج فعّالة':'Active Programs', 5)}
    ${kpiCard(i18n.lang==='ar'?'المستفيدون':'Beneficiaries', 120)}
    ${kpiCard(i18n.lang==='ar'?'المتطوعون':'Volunteers', 48)}
    <div class="card wide">
      <b>${i18n.lang==='ar'?'جمعيات مسجلة':'Registered NGOs'}</b>
      ${tableNPOs(store.state.npof || store.state.nonprofits)}
    </div>
  </div>`
}

function viewCSR(root){
  if(!can('csr:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>CSR</h2><div class="actions">${can('csr:create')?`<button onclick=\"openModal('modal-csr')\">${i18n.lang==='ar'?'مساهمة جديدة':'New Contribution'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'إجمالي المساهمات (ر.س)':'Total Contributions (SAR)', fmt(store.state.csr.reduce((a,c)=>a+c.amount,0)))}
    ${kpiCard(i18n.lang==='ar'?'عدد الشركات':'Companies', new Set(store.state.csr.map(c=>c.company)).size)}
    ${kpiCard(i18n.lang==='ar'?'مبادرات مدعومة':'Supported Initiatives', new Set(store.state.csr.map(c=>c.to)).size)}
    <div class="card half">
      <b>${i18n.lang==='ar'?'المساهمات':'Contributions'}</b>
      ${tableCSR(store.state.csr)}
    </div>
    <div class="card half">
      <b>${i18n.lang==='ar'?'سوق الرعاية':'Marketplace'}</b>
      ${tableMarketplace(store.state.marketplace)}
    </div>
  </div>`
}

function viewAdmin(root){
  if(!can('admin:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'اللجنة الوطنية / إدارة المنصة':'National Committee / Platform Admin'}</h2><div class="actions"><button class="warn" onclick="seedDemo()">${i18n.lang==='ar'?'ملء بيانات تجريبية':'Seed Demo'}</button><button class="danger" onclick="wipe()">${i18n.lang==='ar'?'مسح البيانات':'Wipe Data'}</button></div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'مستخدمون نشطون (تجريبي)':'Active Users (Demo)', 312)}
    ${kpiCard(i18n.lang==='ar'?'عمليات تكامل ناجحة':'Successful Integrations', 99+'%')}
    ${kpiCard(i18n.lang==='ar'?'أمان وامتثال':'Security & Compliance', 'PDPL / MFA')}
    <div class="card half"><b>${i18n.lang==='ar'?'إعدادات عامة':'General Settings'}</b>
      <div class="grid two">
        <div class="field"><label>${i18n.lang==='ar'?'منطقة افتراضية':'Default Region'}</label><select onchange="setRegion(this.value)"><option ${store.state.user.region==='الرياض'?'selected':''}>الرياض</option><option ${store.state.user.region==='حائل'?'selected':''}>حائل</option><option ${store.state.user.region==='الشرقية'?'selected':''}>الشرقية</option></select></div>
        <div class="field"><label>${i18n.lang==='ar'?'لغة الواجهة':'Interface Language'}</label><select id="langSel" onchange="setLang(this.value)"><option value="ar" ${i18n.lang==='ar'?'selected':''}>العربية</option><option value="en" ${i18n.lang==='en'?'selected':''}>English</option></select></div>
        <div class="field"><label>${i18n.lang==='ar'?'شعار الواجهة':'Logo'}</label><div class="actions"><button class="ghost" onclick="openModal('modal-logo')">${i18n.lang==='ar'?'رفع شعار':'Upload Logo'}</button></div></div>
      </div>
    </div>
    <div class="card half"><b>${i18n.lang==='ar'?'سياسات الخصوصية':'Privacy Policies'}</b>
      <div class="grid">
        <div class="tag">PoLP</div><div class="tag">Audit Trail</div><div class="tag">Encryption</div><div class="tag">Consent</div>
      </div>
    </div>
  </div>`
}

function viewMarket(root){ if(!can('market:view')) return (root.innerHTML=denyCard()); root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'سوق الرعاية':'Care Marketplace'}</h2><div class="actions">${can('market:create')?`<button onclick=\"openModal('modal-market')\">${i18n.lang==='ar'?'مبادرة جديدة':'New Initiative'}</button>`:''}</div></div><div class=\"cards\"><div class=\"card wide\">${tableMarketplace(store.state.marketplace,true)}</div></div>` }
function viewReferrals(root){ if(!can('referrals:view')) return (root.innerHTML=denyCard()); root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'الإحالات':'Referrals'}</h2><div class="actions">${can('referrals:create')?`<button onclick=\"openModal('modal-referral')\">${i18n.lang==='ar'?'إحالة جديدة':'New Referral'}</button>`:''}</div></div><div class=\"cards\"><div class=\"card wide\">${tableReferrals(store.state.referrals,true)}</div></div>` }
function viewReports(root){ if(!can('reports:view')) return (root.innerHTML=denyCard()); const totals={kids:store.state.households.reduce((a,h)=>a+h.children.length,0), scr:store.state.screenings.length, ref:store.state.referrals.length}; root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'التقارير':'Reports'}</h2><div class="actions"><button class="ghost" onclick="window.print()" data-i18n="btn.print">طباعة/حفظ PDF</button><button onclick=\"exportCSVs()\">${i18n.lang==='ar'?'تصدير CSV':'Export CSV'}</button></div></div><div class="cards">${kpiCard(i18n.lang==='ar'?'إجمالي الأطفال':'Total Children', fmt(totals.kids))}${kpiCard(i18n.lang==='ar'?'الفحوص':'Screenings', fmt(totals.scr))}${kpiCard(i18n.lang==='ar'?'الإحالات':'Referrals', fmt(totals.ref))}<div class="card wide" id="chart2"></div><div class="card wide"><b>${i18n.lang==='ar'?'سجل كامل':'Full Dump'}</b><pre style="white-space:pre-wrap;background:#0f172a;border:1px solid var(--border);padding:12px;border-radius:12px;direction:ltr">${escapeHtml(JSON.stringify(store.state,null,2))}</pre></div></div>`; drawTrend($('#chart2'), i18n.lang==='ar'?'تمويل شهري (ر.س)':'Monthly Funding (SAR)', [20,30,15,60,40,80]) }
function viewSettings(root){ root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'الإعدادات':'Settings'}</h2></div><div class="cards"><div class="card half"><b>${i18n.lang==='ar'?'إدارة الموافقات':'Consent Management'}</b><p class="help">${i18n.lang==='ar'?'نفس عناصر نافذة الخصوصية.':'Same as consent modal.'}</p><div class="actions"><button onclick="openConsent()">${i18n.lang==='ar'?'فتح':'Open'}</button></div></div><div class="card half"><b>${i18n.lang==='ar'?'جلسة المستخدم':'User Session'}</b><div class="actions"><button class="ghost" onclick="openLogin()">${i18n.lang==='ar'?'تبديل الدور':'Switch Role'}</button><button class="danger" onclick="wipe()">${i18n.lang==='ar'?'مسح البيانات المحلية':'Clear Local Data'}</button></div></div><div class="card wide"><b>${i18n.lang==='ar'?'وضع التكامل مع API':'API Bridge'}</b><div class="grid two"><div class="field"><label><input type="checkbox" id="api_enabled"> ${i18n.lang==='ar'?'تفعيل وضع API':'Enable API Mode'}</label><div class="help">${i18n.lang==='ar'?'عند التفعيل، يُستخدم REST بدلاً من LocalStorage.':'When enabled, REST replaces LocalStorage.'}</div></div><div class="field"><label>Base URL</label><input id="api_base" placeholder="https://api.example.com" /></div><div class="field"><label>Token</label><input id="api_token" placeholder="Bearer ..." /></div><div class="field"><label>${i18n.lang==='ar'?'الشعار':'Logo'}</label><div class="actions"><button class="ghost" onclick="openModal('modal-logo')">${i18n.lang==='ar'?'رفع شعار':'Upload Logo'}</button></div></div></div><div class="actions"><button onclick="applyApiSettings()">${i18n.lang==='ar'?'حفظ إعدادات API':'Save API Settings'}</button></div></div></div>`; $('#api_enabled').checked=api.enabled; $('#api_base').value=api.baseUrl; $('#api_token').value=api.token||'' }
function view404(root){ root.innerHTML = `<div class="empty"><b>${i18n.lang==='ar'?'الصفحة غير موجودة':'Page Not Found'}</b><div>${i18n.lang==='ar'?'المسار:':'Path:'} ${location.hash}</div></div>` }

function denyCard(){ return `<div class=\"empty\"><b>${i18n.lang==='ar'?'صلاحيات غير كافية':'Insufficient permissions'}</b></div>` }

/* ---------- Tables ---------- */
function tableKids(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'الرقم':'ID'}</th><th>${i18n.lang==='ar'?'الاسم':'Name'}</th><th>${i18n.lang==='ar'?'الميلاد':'Birthdate'}</th></tr></thead><tbody>${items.map(c=>`<tr><td>${c.id}</td><td>${c.name}</td><td>${c.dob}</td></tr>`).join('')}</tbody></table>` }
function tableScreenings(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'النوع':'Type'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th><th>${i18n.lang==='ar'?'النتيجة':'Result'}</th><th>${i18n.lang==='ar'?'المنشأة':'Facility'}</th></tr></thead><tbody>${items.map(s=>`<tr><td>${s.id}</td><td>${s.childId}</td><td>${s.type}</td><td>${s.date}</td><td>${s.result}</td><td>${s.facility}</td></tr>`).join('')}</tbody></table>` }
function tableReferrals(items,actions){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'من':'From'}</th><th>${i18n.lang==='ar'?'إلى':'To'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'الأولوية':'Priority'}</th><th>${i18n.lang==='ar'?'الحالة':'Status'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th>${actions?'<th></th>':''}</tr></thead><tbody>${items.map(r=>`<tr><td>${r.id}</td><td>${r.from}</td><td>${r.to}</td><td>${r.childId}</td><td>${r.priority}</td><td>${r.status}</td><td>${r.created}</td>${actions?`<td><button class='ghost' onclick=\"updateReferral('${r.id}')\">${i18n.lang==='ar'?'تحديث':'Update'}</button></td>`:''}</tr>`).join('')}</tbody></table>` }
function tableIEP(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'الأهداف':'Goals'}</th><th>${i18n.lang==='ar'?'مراجعة':'Review'}</th></tr></thead><tbody>${items.map(i=>`<tr><td>${i.id}</td><td>${i.childId}</td><td>${i.goals}</td><td>${i.review}</td></tr>`).join('')}</tbody></table>` }
function tableNPOs(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الاسم':'Name'}</th><th>${i18n.lang==='ar'?'المنطقة':'Region'}</th><th>${i18n.lang==='ar'?'برامج':'Programs'}</th><th>${i18n.lang==='ar'?'مستفيدون':'Beneficiaries'}</th></tr></thead><tbody>${items.map(n=>`<tr><td>${n.id||'-'}</td><td>${n.name}</td><td>${n.region}</td><td>${n.programs}</td><td>${n.beneficiaries}</td></tr>`).join('')}</tbody></table>` }
function tableCSR(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الشركة':'Company'}</th><th>${i18n.lang==='ar'?'المبلغ':'Amount'}</th><th>${i18n.lang==='ar'?'المبادرة':'Initiative'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th></tr></thead><tbody>${items.map(c=>`<tr><td>${c.id}</td><td>${c.company}</td><td>${fmt(c.amount)}</td><td>${c.to}</td><td>${c.date}</td></tr>`).join('')}</tbody></table>` }
function tableMarketplace(items,actions){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'المبادرة':'Initiative'}</th><th>KPI</th><th>${i18n.lang==='ar'?'المطلوب':'Requested'}</th><th>${i18n.lang==='ar'?'الممول':'Funded'}</th><th>${i18n.lang==='ar'?'الجهة':'Owner'}</th>${actions?'<th></th>':''}</tr></thead><tbody>${items.map(m=>`<tr><td>${m.id}</td><td>${m.title}</td><td>${m.kpi}</td><td>${fmt(m.ask)}</td><td>${fmt(m.funded)}</td><td>${m.owner}</td>${actions?`<td><button class='ghost' onclick=\"fund('${m.id}')\">${i18n.lang==='ar'?'تمويل':'Fund'}</button></td>`:''}</tr>`).join('')}</tbody></table>` }

/* ---------- Chart ---------- */
function drawTrend(el,title,data){ const w=el.clientWidth||600,h=160,p=18;const min=Math.min(...data),max=Math.max(...data); const points=data.map((v,i)=>{ const x=p + (i*(w-2*p))/(data.length-1); const y=h-p - ((v-min)*(h-2*p))/(max-min||1); return `${x},${y}` }).join(' '); el.innerHTML = `<b>${title}</b><svg viewBox=\"0 0 ${w} ${h}\" width=\"100%\" height=\"${h}\" role=\"img\" aria-label=\"${title}\"><polyline points=\"${points}\" fill=\"none\" stroke=\"${getComputedStyle(document.documentElement).getPropertyValue('--pri')}\" stroke-width=\"3\"/></svg>` }

/* ---------- Modals & Forms ---------- */
function openLogin(){openModal('modal-login')}
function openConsent(){ const c=store.state.consent;$('#c1').checked=c.c1;$('#c2').checked=c.c2;$('#c3').checked=c.c3;$('#c4').checked=c.c4;openModal('modal-consent') }
function openModal(id){$('#'+id).classList.add('open')}
function closeModal(id){$('#'+id).classList.remove('open')}

function doLogin(){ const role=$('#loginRole').value; const region=$('#loginRegion').value; store.state.user={role,region}; store.save(); $('#roleTag').textContent=(i18n.lang==='ar'?'دور: ':'Role: ')+role; closeModal('modal-login'); toast((i18n.lang==='ar'?'تم تسجيل الدخول كـ ':'Signed in as ')+role); enforceRBAC(); router() }
function saveConsent(){ store.state.consent={c1:$('#c1').checked,c2:$('#c2').checked,c3:$('#c3').checked,c4:$('#c4').checked}; store.save(); closeModal('modal-consent'); toast(i18n.lang==='ar'?'تم حفظ الموافقات':'Consents saved') }

function submitScreening(){ const id='S-'+Math.floor(Math.random()*1e5); const payload={ id, childId:$('#f_sc_child').value||'C-501', type:$('#f_sc_type').value, date:$('#f_sc_date').value||today(), result:$('#f_sc_result').value||'—', facility:$('#f_sc_facility').value||store.state.user.region+"/مركز صحي" }; if(api.enabled){ apiFetch('/screenings',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال الفحص عبر API':'Screening sent via API')).catch(()=>{store.state.screenings.push(payload);store.save();toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-screening');router()}) } else { store.state.screenings.push(payload); store.save(); closeModal('modal-screening'); toast(i18n.lang==='ar'?'تم تسجيل الفحص':'Screening recorded'); router() } }
function submitReferral(){ const id='R-'+Math.floor(Math.random()*1e5); const payload={ id, from:$('#f_ref_from').value, to:$('#f_ref_to').value, childId:$('#f_ref_child').value||'C-501', priority:$('#f_ref_pri').value, status:$('#f_ref_status').value, created:$('#f_ref_date').value||today() }; if(api.enabled){ apiFetch('/referrals',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال الإحالة عبر API':'Referral sent via API')).catch(()=>{store.state.referrals.push(payload);store.save();toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-referral');router()}) } else { store.state.referrals.push(payload); store.save(); closeModal('modal-referral'); toast(i18n.lang==='ar'?'تم إنشاء الإحالة':'Referral created'); router() } }
function updateReferral(id){ const r=store.state.referrals.find(x=>x.id===id); if(!r) return; const st=prompt(i18n.lang==='ar'?'تحديث الحالة:':'Update status:', r.status)||r.status; r.status=st; store.save(); toast(i18n.lang==='ar'?'تم التحديث':'Updated'); router() }
function submitIEP(){ const id='IEP-'+Math.floor(Math.random()*1e5); const payload={ id, childId:$('#f_iep_child').value||'C-502', goals:$('#f_iep_goals').value||'Goals', review:$('#f_iep_review').value||today() }; if(api.enabled){ apiFetch('/iep',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال IEP عبر API':'IEP sent via API')).catch(()=>{store.state.ieps.push(payload);store.save();toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-iep');router()}) } else { store.state.ieps.push(payload); store.save(); closeModal('modal-iep'); toast(i18n.lang==='ar'?'تم إنشاء IEP':'IEP created'); router() } }
function submitMarket(){ const id='M-'+Math.floor(Math.random()*1e5); const payload={ id, title:$('#f_m_title').value, kpi:$('#f_m_kpi').value, ask:parseInt($('#f_m_ask').value||'0',10), funded:0, owner:$('#f_m_owner').value||'جمعية' }; if(api.enabled){ apiFetch('/market',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال المبادرة عبر API':'Initiative sent via API')).catch(()=>{store.state.marketplace.push(payload);store.save();toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-market');router()}) } else { store.state.marketplace.push(payload); store.save(); closeModal('modal-market'); toast(i18n.lang==='ar'?'تمت إضافة المبادرة':'Initiative added'); router() } }
function submitCSR(){ const id='CSR-'+Math.floor(Math.random()*1e5); const payload={ id, company:$('#f_csr_company').value||'Company', amount:parseInt($('#f_csr_amount').value||'0',10), to:$('#f_csr_to').value||'M-1', date:$('#f_csr_date').value||today() }; if(api.enabled){ apiFetch('/csr',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال المساهمة عبر API':'Contribution sent via API')).catch(()=>{store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===payload.to); if(m) m.funded+=payload.amount; store.save(); toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-csr');router()}) } else { store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===payload.to); if(m) m.funded+=payload.amount; store.save(); closeModal('modal-csr'); toast(i18n.lang==='ar'?'تم تسجيل مساهمة CSR':'CSR contribution recorded'); router() } }
function fund(id){ const amount=parseInt(prompt(i18n.lang==='ar'?'مبلغ التمويل (ر.س):':'Funding amount (SAR):','10000')||'0',10); if(!amount) return; const payload={ id:'CSR-'+Math.floor(Math.random()*1e5), company:'Supporter', amount, to:id, date:today() }; if(api.enabled){ apiFetch('/csr',{method:'POST',body:JSON.stringify(payload)}).catch(()=>{}); } store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===id); if(m) m.funded+=amount; store.save(); toast(i18n.lang==='ar'?'تم تحديث التمويل':'Funding updated'); router() }
function addChild(){ const h=store.state.households[0]; const id='C-'+Math.floor(Math.random()*1e4); const name=prompt(i18n.lang==='ar'?'اسم الطفل:':'Child name:','طفلي'); const dob=prompt(i18n.lang==='ar'?'تاريخ الميلاد (YYYY-MM-DD):':'Birthdate (YYYY-MM-DD):',today()); if(!name) return; h.children.push({id,name,dob}); store.save(); toast(i18n.lang==='ar'?'تمت إضافة الطفل':'Child added'); router() }

/* ---------- Logo upload ---------- */
function uploadLogo(){ const f=$('#logoFile').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ store.state.ui.logo=e.target.result; store.save(); $('#logo').src=store.state.ui.logo; closeModal('modal-logo'); toast(i18n.lang==='ar'?'تم تحديث الشعار':'Logo updated') }; r.readAsDataURL(f) }

/* ---------- CSV Exports ---------- */
function toCSV(rows, headers){ const esc=v=>(''+(v??'')).replaceAll('"','""'); const head=headers.join(','); const body=rows.map(r=>headers.map(h=>`"${esc(r[h])}"`).join(',')).join('
'); return head+'
'+body }
function exportCSVs(){
  const sCSV=toCSV(store.state.screenings,["id","childId","type","date","result","facility"]); download('screenings.csv',sCSV)
  const rCSV=toCSV(store.state.referrals,["id","from","to","childId","priority","status","created"]); download('referrals.csv',rCSV)
  const cCSV=toCSV(store.state.csr,["id","company","amount","to","date"]); download('csr.csv',cCSV)
  toast(i18n.lang==='ar'?'تم تصدير CSV':'CSV exported')
}

/* ---------- Settings helpers ---------- */
function setRegion(region){store.state.user.region=region;store.save();toast(i18n.lang==='ar'?'تم ضبط المنطقة':'Region set');router()}
function setLang(lang){ i18n.lang=lang; localStorage.setItem('nomu.lang',lang); applyI18n(); router() }
function applyApiSettings(){ api.enabled=$('#api_enabled').checked; api.baseUrl=$('#api_base').value||api.baseUrl; api.token=$('#api_token').value||null; toast(api.enabled?(i18n.lang==='ar'?'تم تفعيل وضع API':'API mode enabled'):(i18n.lang==='ar'?'تم تعطيل وضع API':'API mode disabled')) }

/* ---------- Init ---------- */
function initLogo(){ if(store.state.ui.logo){ $('#logo').src=store.state.ui.logo; $('#logo').classList.remove('ph') } }
router(); applyI18n(); enforceRBAC(); initLogo();
$('#roleTag').textContent = (i18n.lang==='ar'?'دور: ':'Role: ')+ (store.state.user.role||'guest')
</script>
</body>
</html>
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نمو NOMU — نموذج أحادي الملف (index.html)</title>
  <meta name="description" content="نمو NOMU — منصة وطنية للطفولة المبكرة. نموذج أحادي الملف مع نماذج موسّعة، RBAC، تصدير CSV، شعارات قابلة للرفع، ودعم ثنائي اللغة (AR/EN)." />
  <style>
    :root{ --bg:#0b1220;--card:#121a2b;--muted:#1a2440;--pri:#5ac8fa;--sec:#8ef6d0;--acc:#ffd166;--danger:#ff6b6b;--ok:#22c55e;--text:#e6edf7;--sub:#a7b0c3;--border:#263251;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px;--pad:18px;--gap:14px;--gap-lg:22px;--font:system-ui,"Segoe UI",Tahoma,Arial;--mono:ui-monospace,Consolas,monospace }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220 0%,#0b1220 50%,#0e172a 100%);color:var(--text);font:15px/1.6 var(--font)}
    a{color:var(--pri);text-decoration:none}
    .app{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .topbar{display:flex;align-items:center;gap:12px;max-width:1200px;margin:auto;padding:10px var(--pad)}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .logo img{width:34px;height:34px;border-radius:8px;object-fit:cover}
    .logo .ph{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--pri),var(--sec))}
    .badge{display:inline-flex;align-items:center;gap:6px;background:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--sub);font-size:12px}
    .search{margin-inline-start:auto;position:relative}
    .search input{width:320px;max-width:60vw;background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 34px 10px 12px;border-radius:10px}
    .search svg{position:absolute;inset-inline-end:10px;top:50%;transform:translateY(-50%);opacity:.7}
    .user{display:flex;align-items:center;gap:10px}
    .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#4158d0,#c850c0 60%,#ffcc70)}

    .main{max-width:1200px;margin:24px auto;display:grid;grid-template-columns:260px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
    nav{position:sticky;top:65px;height:fit-content}
    .side{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px}
    .group{margin:10px 0}
    .group h4{margin:6px 12px 8px;color:var(--sub);font-weight:600;font-size:13px}
    .link{display:flex;align-items:center;gap:10px;border-radius:10px;padding:10px 12px;color:var(--text);border:1px solid transparent}
    .link:hover{background:var(--muted);border-color:var(--border)}
    .link.active{background:linear-gradient(180deg,rgba(90,200,250,.09),rgba(90,200,250,.04));border-color:#274a70}
    .link[hidden]{display:none}

    .content{display:grid;gap:var(--gap-lg)}
    .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .card{grid-column:span 4;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
    .card span.k{display:block;color:var(--sub);font-size:12px}
    .card b.v{display:block;font-size:26px;margin-top:6px}
    .card small{color:var(--sub)}

    .wide{grid-column:span 12}
    .half{grid-column:span 6}
    .third{grid-column:span 4}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button,.btn{background:var(--pri);color:#071426;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(90,200,250,.25)}
    button.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    button.warn{background:var(--acc);color:#1b1100}
    button.danger{background:var(--danger)}
    .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--muted);padding:6px 10px;border-radius:999px;color:var(--sub);font-size:12px}

    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{text-align:right;padding:12px;background:var(--card)}
    th{color:var(--sub);font-size:12px}
    tbody tr{border:1px solid var(--border)}
    tbody td{border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    tbody td:first-child{border-inline-start:1px solid var(--border);border-start-start-radius:10px;border-end-start-radius:10px}
    tbody td:last-child{border-inline-end:1px solid var(--border);border-start-end-radius:10px;border-end-end-radius:10px}

    .grid{display:grid;gap:var(--gap)}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:repeat(3,1fr)}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
    .modal.open{display:grid}
    .modal .box{width:min(680px,94vw);background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:var(--shadow)}

    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--text)}
    label{font-size:13px;color:var(--sub)}
    .field{display:grid;gap:6px;margin:10px 0}
    .help{font-size:12px;color:var(--sub)}

    .empty{border:1px dashed var(--border);border-radius:14px;padding:26px;color:var(--sub);text-align:center}

    .footer{margin:30px auto;max-width:1200px;color:var(--sub);text-align:center;padding:10px}

    @media (max-width:960px){
      .main{grid-template-columns:1fr}
      nav{position:static}
      .cards{grid-template-columns:repeat(6,1fr)}
      .card{grid-column:span 6}
      .half{grid-column:span 6}
      .third{grid-column:span 6}
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="topbar" role="banner">
      <div class="logo" aria-label="NOMU">
        <img id="logo" alt="شعار" class="ph" />
        <span id="t-app">نمو NOMU</span>
        <span class="badge" title="نموذج">Prototype</span>
      </div>
      <nav class="actions" aria-label="التنقل السريع">
        <a class="btn" href="#/home" data-i18n="nav.home">الرئيسية</a>
        <button class="ghost" onclick="openLogin()" data-i18n="nav.login">تسجيل الدخول</button>
        <button class="ghost" onclick="openConsent()" data-i18n="nav.consent">الموافقة والخصوصية</button>
      </nav>
      <div class="search" role="search">
        <input id="q" placeholder="ابحث عن طفل، إحالة، جمعية، مبادرة…" oninput="globalSearch(this.value)" />
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </div>
      <div class="user" aria-label="الحساب">
        <div class="tag" id="roleTag">دخول ضيف</div>
        <div class="avatar" title="المستخدم"></div>
      </div>
    </div>
  </header>

  <main class="main" role="main">
    <nav>
      <div class="side" role="navigation" aria-label="أقسام المنصة">
        <div class="group">
          <h4 data-i18n="nav.dashboards">لوحات القيادة</h4>
          <a class="link active" href="#/home" data-route data-i18n="nav.home">الرئيسية</a>
          <a class="link" href="#/family" data-route data-perm="family:view" data-i18n="nav.family">حساب الأسرة</a>
          <a class="link" href="#/health" data-route data-perm="health:view" data-i18n="nav.health">الصحة</a>
          <a class="link" href="#/education" data-route data-perm="education:view" data-i18n="nav.education">التعليم</a>
          <a class="link" href="#/nonprofit" data-route data-perm="nonprofit:view" data-i18n="nav.nonprofit">الجمعيات</a>
          <a class="link" href="#/csr" data-route data-perm="csr:view" data-i18n="nav.csr">القطاع الخاص (CSR)</a>
          <a class="link" href="#/admin" data-route data-perm="admin:view" data-i18n="nav.admin">اللجنة الوطنية / الإدارة</a>
        </div>
        <div class="group">
          <h4 data-i18n="nav.tools">أدوات</h4>
          <a class="link" href="#/market" data-route data-perm="market:view" data-i18n="nav.market">سوق الرعاية</a>
          <a class="link" href="#/referrals" data-route data-perm="referrals:view" data-i18n="nav.referrals">الإحالات</a>
          <a class="link" href="#/reports" data-route data-perm="reports:view" data-i18n="nav.reports">التقارير</a>
          <a class="link" href="#/settings" data-route data-i18n="nav.settings">الإعدادات</a>
        </div>
      </div>
    </nav>

    <section class="content" id="view"></section>
  </main>

  <footer class="footer" id="footer-note">نمو — نموذج أحادي الملف. البيانات محليًا. يمكن تفعيل API ورفع شعار من الإعدادات.</footer>
</div>

<!-- Modals: Login / Consent / Forms / Logo Upload -->
<div class="modal" id="modal-login" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <div class="box">
    <h3 id="loginTitle" data-i18n="login.title">تسجيل الدخول</h3>
    <p class="help" data-i18n="login.help">اختر نوع الحساب لتجربة الواجهات.</p>
    <div class="grid two">
      <div class="field">
        <label data-i18n="login.role">نوع المستخدم</label>
        <select id="loginRole">
          <option value="guest">ضيف</option>
          <option value="family">أسرة</option>
          <option value="health">الصحة</option>
          <option value="education">التعليم</option>
          <option value="nonprofit">جمعية</option>
          <option value="csr">شركة (CSR)</option>
          <option value="admin">لجنة وطنية</option>
        </select>
      </div>
      <div class="field">
        <label data-i18n="login.region">المنطقة الإدارية</label>
        <select id="loginRegion">
          <option>الرياض</option>
          <option>حائل</option>
          <option>الشرقية</option>
          <option>مكة المكرمة</option>
          <option>المدينة المنورة</option>
        </select>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="doLogin()" data-i18n="btn.login">دخول</button>
      <button class="ghost" onclick="closeModal('modal-login')" data-i18n="btn.cancel">إلغاء</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-consent" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
  <div class="box">
    <h3 id="consentTitle" data-i18n="consent.title">الموافقة وإدارة الخصوصية (PDPL)</h3>
    <div class="grid two">
      <div class="field"><label><input type="checkbox" id="c1"> <span data-i18n="consent.c1">معالجة بيانات الأم خلال الحمل لأغراض المتابعة الصحية</span></label></div>
      <div class="field"><label><input type="checkbox" id="c2"> <span data-i18n="consent.c2">مشاركة تقارير الطفل النمائية مع وزارة التعليم</span></label></div>
      <div class="field"><label><input type="checkbox" id="c3"> <span data-i18n="consent.c3">مشاركة بيانات الدعم الاجتماعي مع الوزارة المختصة</span></label></div>
      <div class="field"><label><input type="checkbox" id="c4"> <span data-i18n="consent.c4">تلقي تنبيهات وتوصيات عبر البريد/الرسائل</span></label></div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="saveConsent()" data-i18n="btn.save">حفظ</button>
      <button class="ghost" onclick="closeModal('modal-consent')" data-i18n="btn.cancel">إلغاء</button>
    </div>
  </div>
</div>

<!-- Forms -->
<div class="modal" id="modal-screening" role="dialog" aria-modal="true" aria-labelledby="screeningTitle">
  <div class="box">
    <h3 id="screeningTitle" data-i18n="screening.title">تسجيل فحص</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_sc_child" placeholder="C-501"></div>
      <div class="field"><label data-i18n="labels.type">نوع الفحص</label><select id="f_sc_type"><option>نمو نمائي</option><option>سمع</option><option>نظر</option><option>نفسي</option></select></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_sc_date" type="date"></div>
      <div class="field"><label data-i18n="labels.result">النتيجة</label><input id="f_sc_result" placeholder="سليم / إحالة / متابعة"></div>
      <div class="field"><label data-i18n="labels.facility">المنشأة</label><input id="f_sc_facility" placeholder="مركز صحي - المنطقة"></div>
    </div>
    <div class="actions"><button onclick="submitScreening()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-screening')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-referral" role="dialog" aria-modal="true" aria-labelledby="refTitle">
  <div class="box">
    <h3 id="refTitle" data-i18n="referral.title">إنشاء إحالة</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.from">من</label><select id="f_ref_from"><option>الأسرة</option><option>الصحة</option><option>التعليم</option><option>جمعية</option></select></div>
      <div class="field"><label data-i18n="labels.to">إلى</label><select id="f_ref_to"><option>الصحة</option><option>التعليم</option><option>جمعية</option></select></div>
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_ref_child" placeholder="C-501"></div>
      <div class="field"><label data-i18n="labels.priority">الأولوية</label><select id="f_ref_pri"><option>عادية</option><option>عاجلة</option></select></div>
      <div class="field"><label data-i18n="labels.status">الحالة</label><select id="f_ref_status"><option>قيد المعالجة</option><option>مكتملة</option></select></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_ref_date" type="date"></div>
    </div>
    <div class="actions"><button onclick="submitReferral()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-referral')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-iep" role="dialog" aria-modal="true" aria-labelledby="iepTitle">
  <div class="box">
    <h3 id="iepTitle" data-i18n="iep.title">إنشاء خطة IEP</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_iep_child" placeholder="C-502"></div>
      <div class="field"><label data-i18n="labels.review">مراجعة</label><input id="f_iep_review" type="date"></div>
      <div class="field" style="grid-column:1/-1"><label data-i18n="labels.goals">الأهداف</label><textarea id="f_iep_goals" rows="3" placeholder="أهداف قابلة للقياس بزمن ومسؤولية"></textarea></div>
    </div>
    <div class="actions"><button onclick="submitIEP()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-iep')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-market" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="box">
    <h3 id="mTitle" data-i18n="market.title">طرح مبادرة</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.title">العنوان</label><input id="f_m_title" placeholder="جلسات تدخل مبكر - الرياض"></div>
      <div class="field"><label data-i18n="labels.kpi">الهدف (KPI)</label><input id="f_m_kpi" placeholder="100 طفل خلال 6 أشهر"></div>
      <div class="field"><label data-i18n="labels.ask">المبلغ المطلوب</label><input id="f_m_ask" type="number" min="0" step="1000" placeholder="100000"></div>
      <div class="field"><label data-i18n="labels.owner">الجهة المالكة</label><input id="f_m_owner" placeholder="جمعية نماء"></div>
    </div>
    <div class="actions"><button onclick="submitMarket()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-market')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-csr" role="dialog" aria-modal="true" aria-labelledby="csrTitle">
  <div class="box">
    <h3 id="csrTitle" data-i18n="csr.title">مساهمة CSR</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.marketId">معرف المبادرة</label><input id="f_csr_to" placeholder="M-1"></div>
      <div class="field"><label data-i18n="labels.company">الشركة</label><input id="f_csr_company" placeholder="شركة الأفق"></div>
      <div class="field"><label data-i18n="labels.amount">المبلغ (ر.س)</label><input id="f_csr_amount" type="number" min="0" step="1000" placeholder="20000"></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_csr_date" type="date"></div>
    </div>
    <div class="actions"><button onclick="submitCSR()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-csr')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<!-- رفع الشعار -->
<div class="modal" id="modal-logo" role="dialog" aria-modal="true" aria-labelledby="logoTitle">
  <div class="box">
    <h3 id="logoTitle" data-i18n="logo.title">رفع شعار الجهة</h3>
    <div class="field"><input type="file" accept="image/*" id="logoFile"></div>
    <div class="actions"><button onclick="uploadLogo()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-logo')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<script>
/* ==========================================================
   NOMU — Single-File Prototype (Enhanced + RBAC + i18n + CSV)
   ========================================================== */

const $ = (q,root=document)=>root.querySelector(q)
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q))

/* ---------- i18n (basic) ---------- */
const i18n = {
  lang: localStorage.getItem('nomu.lang') || 'ar',
  t: {
    ar: {
      'nav.home':'الرئيسية','nav.login':'تسجيل الدخول','nav.consent':'الموافقة والخصوصية','nav.dashboards':'لوحات القيادة','nav.family':'حساب الأسرة','nav.health':'الصحة','nav.education':'التعليم','nav.nonprofit':'الجمعيات','nav.csr':'القطاع الخاص (CSR)','nav.admin':'اللجنة الوطنية / الإدارة','nav.tools':'أدوات','nav.market':'سوق الرعاية','nav.referrals':'الإحالات','nav.reports':'التقارير','nav.settings':'الإعدادات',
      'login.title':'تسجيل الدخول','login.help':'اختر نوع الحساب لتجربة الواجهات.','login.role':'نوع المستخدم','login.region':'المنطقة الإدارية',
      'btn.login':'دخول','btn.cancel':'إلغاء','btn.save':'حفظ','btn.print':'طباعة/حفظ PDF','btn.logo':'رفع شعار',
      'consent.title':'الموافقة وإدارة الخصوصية (PDPL)','consent.c1':'معالجة بيانات الأم خلال الحمل لأغراض المتابعة الصحية','consent.c2':'مشاركة تقارير الطفل النمائية مع وزارة التعليم','consent.c3':'مشاركة بيانات الدعم الاجتماعي مع الوزارة المختصة','consent.c4':'تلقي تنبيهات وتوصيات عبر البريد/الرسائل',
      'labels.childId':'معرف الطفل','labels.type':'نوع الفحص','labels.date':'التاريخ','labels.result':'النتيجة','labels.facility':'المنشأة','labels.from':'من','labels.to':'إلى','labels.priority':'الأولوية','labels.status':'الحالة','labels.review':'مراجعة','labels.goals':'الأهداف','labels.title':'العنوان','labels.kpi':'الهدف (KPI)','labels.ask':'المبلغ المطلوب','labels.owner':'الجهة المالكة','labels.marketId':'معرف المبادرة','labels.company':'الشركة','labels.amount':'المبلغ (ر.س)',
      'screening.title':'تسجيل فحص','referral.title':'إنشاء إحالة','iep.title':'إنشاء خطة IEP','market.title':'طرح مبادرة','csr.title':'مساهمة CSR','logo.title':'رفع شعار الجهة',
      'reports.export':'تصدير CSV'
    },
    en: {
      'nav.home':'Home','nav.login':'Sign in','nav.consent':'Consent & Privacy','nav.dashboards':'Dashboards','nav.family':'Family','nav.health':'Health','nav.education':'Education','nav.nonprofit':'Nonprofits','nav.csr':'Private Sector (CSR)','nav.admin':'National Committee / Admin','nav.tools':'Tools','nav.market':'Care Marketplace','nav.referrals':'Referrals','nav.reports':'Reports','nav.settings':'Settings',
      'login.title':'Sign in','login.help':'Pick a role to explore the UI.','login.role':'Role','login.region':'Region',
      'btn.login':'Sign in','btn.cancel':'Cancel','btn.save':'Save','btn.print':'Print / Save PDF','btn.logo':'Upload Logo',
      'consent.title':'Consent & Privacy (PDPL)','consent.c1':'Process maternal data during pregnancy for healthcare follow-up','consent.c2':'Share child developmental reports with MoE','consent.c3':'Share social support data with the relevant ministry','consent.c4':'Receive alerts/recommendations via email/SMS',
      'labels.childId':'Child ID','labels.type':'Type','labels.date':'Date','labels.result':'Result','labels.facility':'Facility','labels.from':'From','labels.to':'To','labels.priority':'Priority','labels.status':'Status','labels.review':'Review','labels.goals':'Goals','labels.title':'Title','labels.kpi':'KPI','labels.ask':'Requested Amount','labels.owner':'Owner','labels.marketId':'Market ID','labels.company':'Company','labels.amount':'Amount (SAR)',
      'screening.title':'Record Screening','referral.title':'Create Referral','iep.title':'Create IEP','market.title':'Post Initiative','csr.title':'CSR Contribution','logo.title':'Upload Logo',
      'reports.export':'Export CSV'
    }
  }
}
function applyI18n(){
  const dict=i18n.t[i18n.lang]||i18n.t.ar
  $$('[data-i18n]').forEach(el=>{ const key=el.getAttribute('data-i18n'); if(dict[key]) el.textContent=dict[key] })
  document.documentElement.lang = i18n.lang
  document.documentElement.dir = (i18n.lang==='ar')?'rtl':'ltr'
}

/* ---------- API Bridge ---------- */
const api = { enabled:false, baseUrl:'https://api.example.com', token:null }
async function apiFetch(path,opts={}){ if(!api.enabled){ throw new Error('API_DISABLED') } const res = await fetch(api.baseUrl+path,{ headers:Object.assign({'Content-Type':'application/json', ...(api.token?{Authorization:'Bearer '+api.token}:{})}), ...opts }); if(!res.ok){ const t=await res.text(); throw new Error('API '+res.status+': '+t) } return res.json() }

/* ---------- RBAC ---------- */
const permsByRole = {
  guest: ['home:view','reports:view','market:view','referrals:view','settings:view'],
  family:['home:view','family:view','referrals:view','screening:create','settings:view'],
  health:['home:view','health:view','screening:create','referrals:create','reports:view','settings:view'],
  education:['home:view','education:view','iep:create','referrals:view','reports:view','settings:view'],
  nonprofit:['home:view','nonprofit:view','market:create','reports:view','settings:view'],
  csr:['home:view','csr:view','csr:create','market:view','reports:view','settings:view'],
  admin:['home:view','admin:view','family:view','health:view','education:view','nonprofit:view','csr:view','market:view','referrals:view','reports:view','settings:view']
}
function can(perm){ const role=store.state.user.role||'guest'; const allow=(permsByRole[role]||[]).includes(perm); return allow }
function enforceRBAC(){ $$('[data-perm]').forEach(el=>{ const need=el.getAttribute('data-perm'); el.hidden=!can(need) }) }

/* ---------- Store ---------- */
const store = {
  load(){
    try{const data=JSON.parse(localStorage.getItem('nomu')||'{}');this.state=Object.assign({
      user:{role:'guest',region:'الرياض'}, ui:{logo:null},
      consent:{c1:false,c2:false,c3:false,c4:false},
      households:[{id:'H-1001', father:'محمد', mother:'سارة', region:'حائل', children:[{id:'C-501', name:'ليان', dob:'2021-03-10'},{id:'C-502', name:'تركي', dob:'2019-11-02'}]}],
      screenings:[{id:'S-9001', childId:'C-501', type:'نمو نمائي', date:'2025-09-20', result:'سليم', facility:'مركز صحي شمال حائل'}],
      referrals:[{id:'R-7001', from:'الصحة', to:'التعليم', childId:'C-502', priority:'عادية', status:'قيد المعالجة', created:'2025-09-25'}],
      ieps:[{id:'IEP-3001', childId:'C-502', goals:'تحسين المهارات اللغوية', review:'2025-12-01'}],
      nonprofits:[{id:'NPO-10', name:'جمعية نماء للطفولة', region:'حائل', programs:3, beneficiaries:120}],
      marketplace:[{id:'M-1', title:'جلسات تدخل مبكر لحائل', kpi:'100 طفل خلال 6 أشهر', ask:250000, funded:120000, owner:'جمعية نماء'}, {id:'M-2', title:'فحوص سمع لحديثي الولادة – الشرقية', kpi:'300 وليد', ask:180000, funded:45000, owner:'صحة الشرقية'}],
      csr:[{id:'CSR-100', company:'شركة الأفق', amount:50000, to:'M-1', date:'2025-10-01'}]
    }, data)}catch(e){this.state={}}
  },
  save(){localStorage.setItem('nomu',JSON.stringify(this.state))}
}
store.load()

/* ---------- Utilities ---------- */
function fmt(n){return new Intl.NumberFormat(i18n.lang==='ar'?'ar-SA':'en-US').format(n)}
function today(){return new Date().toISOString().slice(0,10)}
function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',bottom:'18px',left:'18px',background:'#111b',color:'#fff',padding:'10px 14px',borderRadius:'12px',backdropFilter:'blur(4px)',zIndex:9999}); document.body.appendChild(t); setTimeout(()=>t.remove(),2200) }
function escapeHtml(str){return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'})); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000) }

/* ---------- Router ---------- */
const routes = { '/home': viewHome, '/family': viewFamily, '/health': viewHealth, '/education': viewEducation, '/nonprofit': viewNonprofit, '/csr': viewCSR, '/admin': viewAdmin, '/market': viewMarket, '/referrals': viewReferrals, '/reports': viewReports, '/settings': viewSettings }
function router(){ const path = location.hash.replace('#','') || '/home'; $$('a.link').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===`#${path}`)); const el = document.getElementById('view'); el.innerHTML=''; (routes[path]||view404)(el); enforceRBAC(); applyI18n() }
window.addEventListener('hashchange',router)

/* ---------- Cards helper ---------- */
function kpiCard(title,value,delta){ return `<div class="card third"><span class="k">${title}</span><b class="v">${value}</b><small>${delta||''}</small></div>` }

/* ---------- Views ---------- */
function viewHome(root){
  const totalKids = store.state.households.reduce((a,h)=>a+h.children.length,0)
  const screened = store.state.screenings.length
  const referrals = store.state.referrals.length
  const funded = store.state.marketplace.reduce((a,m)=>a+m.funded,0)
  root.innerHTML = `
    <div class="toolbar">
      <h2>${i18n.lang==='ar'?'لوحة وطنية مختصرة':'National Overview'}</h2>
      <div class="actions">
        <span class="tag">${i18n.lang==='ar'?'المنطقة':'Region'}: ${store.state.user.region}</span>
        <button onclick="location.hash='#/reports'">${i18n.lang==='ar'?'عرض التقارير':'Open Reports'}</button>
      </div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'الأطفال في السجل':'Registered Children', fmt(totalKids), '—')}
      ${kpiCard(i18n.lang==='ar'?'فحوص نمائية مُسجلة':'Recorded Screenings', fmt(screened))}
      ${kpiCard(i18n.lang==='ar'?'إحالات نشطة':'Active Referrals', fmt(referrals))}
      ${kpiCard(i18n.lang==='ar'?'تمويل CSR/منح (ر.س)':'CSR/Grants Funding (SAR)', fmt(funded))}
      <div class="card wide" id="chart"></div>
      <div class="card half">
        <div class="toolbar"><b>${i18n.lang==='ar'?'آخر المبادرات في سوق الرعاية':'Latest Marketplace Initiatives'}</b><div class="actions"><button class="ghost" onclick="location.hash='#/market'">${i18n.lang==='ar'?'إدارة':'Manage'}</button></div></div>
        ${tableMarketplace(store.state.marketplace.slice(0,5))}
      </div>
      <div class="card half">
        <div class="toolbar"><b>${i18n.lang==='ar'?'آخر الإحالات':'Recent Referrals'}</b><div class="actions"><button class="ghost" onclick="location.hash='#/referrals'">${i18n.lang==='ar'?'إدارة':'Manage'}</button></div></div>
        ${tableReferrals(store.state.referrals.slice(0,5))}
      </div>
    </div>`
  drawTrend($('#chart'), i18n.lang==='ar'?'أطفال مفحوصون خلال 6 أشهر':'Screened Children (6m)', [40,55,61,70,86,93])
}

function viewFamily(root){
  if(!can('family:view')){ return (root.innerHTML = denyCard()) }
  const h = store.state.households[0]
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'حساب الأسرة':'Family Account'}</h2><div class="actions">${can('screening:create')?`<button onclick=\"openModal('modal-screening')\">${i18n.lang==='ar'?'حجز/تسجيل فحص':'Book/Record Screening'}</button>`:''}${can('referrals:create')?`<button class=\"ghost\" onclick=\"openModal('modal-referral')\">${i18n.lang==='ar'?'طلب إحالة':'Create Referral'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'الأطفال':'Children', h.children.length)}
    ${kpiCard(i18n.lang==='ar'?'فحوص مكتملة':'Completed Screenings', store.state.screenings.filter(s=>h.children.some(c=>c.id===s.childId)).length)}
    ${kpiCard(i18n.lang==='ar'?'إحالات مرتبطة':'Related Referrals', store.state.referrals.filter(r=>h.children.some(c=>c.id===r.childId)).length)}
    <div class="card wide">
      <div class="toolbar"><b>${i18n.lang==='ar'?'أطفال الأسرة':'Children'}</b><div class="actions"><button class="ghost" onclick="addChild()">${i18n.lang==='ar'?'إضافة طفل':'Add Child'}</button></div></div>
      ${tableKids(h.children)}
    </div>
    <div class="card half">
      <b>${i18n.lang==='ar'?'الفحوص':'Screenings'}</b>
      ${tableScreenings(store.state.screenings.filter(s=>h.children.some(c=>c.id===s.childId)))}
    </div>
    <div class="card half">
      <b>${i18n.lang==='ar'?'التوصيات الذكية':'Smart Tips'}</b>
      <div class="empty">${i18n.lang==='ar'?'ستظهر التوصيات حسب العمر والفحوص المنجزة.':'Tips will appear based on age and completed screenings.'}</div>
    </div>
  </div>`
}

function viewHealth(root){
  if(!can('health:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'وزارة الصحة':'Ministry of Health'}</h2><div class="actions">${can('screening:create')?`<button onclick=\"openModal('modal-screening')\">${i18n.lang==='ar'?'تسجيل فحص':'Record Screening'}</button>`:''}${can('referrals:create')?`<button class=\"ghost\" onclick=\"openModal('modal-referral')\">${i18n.lang==='ar'?'إحالة للتعليم':'Refer to Education'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'فحوص هذا الشهر':'This Month Screenings', store.state.screenings.filter(s=>s.date.slice(0,7)===today().slice(0,7)).length)}
    ${kpiCard(i18n.lang==='ar'?'متوسط زمن الانتظار (يوم)':'Avg Wait (days)', 7)}
    ${kpiCard(i18n.lang==='ar'?'الإحالات المرسلة':'Referrals Sent', store.state.referrals.filter(r=>r.from==='الصحة').length)}
    <div class="card wide">
      <b>${i18n.lang==='ar'?'سجل الفحوص':'Screenings Log'}</b>
      ${tableScreenings(store.state.screenings)}
    </div>
  </div>`
}

function viewEducation(root){
  if(!can('education:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'وزارة التعليم':'Ministry of Education'}</h2><div class="actions">${can('iep:create')?`<button onclick=\"openModal('modal-iep')\">${i18n.lang==='ar'?'إنشاء IEP':'Create IEP'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'تقارير الجاهزية الصادرة':'Readiness Reports Issued', 42)}
    ${kpiCard(i18n.lang==='ar'?'خطط IEP نشطة':'Active IEPs', store.state.ieps.length)}
    ${kpiCard(i18n.lang==='ar'?'إحالات واردة':'Incoming Referrals', store.state.referrals.filter(r=>r.to==='التعليم').length)}
    <div class="card half">
      <b>${i18n.lang==='ar'?'الإحالات الواردة':'Incoming Referrals'}</b>
      ${tableReferrals(store.state.referrals.filter(r=>r.to==='التعليم'))}
    </div>
    <div class="card half">
      <b>IEP</b>
      ${tableIEP(store.state.ieps)}
    </div>
  </div>`
}

function viewNonprofit(root){
  if(!can('nonprofit:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'الجمعيات':'Nonprofits'}</h2><div class="actions">${can('market:create')?`<button onclick=\"openModal('modal-market')\">${i18n.lang==='ar'?'طرح مبادرة':'Post Initiative'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'برامج فعّالة':'Active Programs', 5)}
    ${kpiCard(i18n.lang==='ar'?'المستفيدون':'Beneficiaries', 120)}
    ${kpiCard(i18n.lang==='ar'?'المتطوعون':'Volunteers', 48)}
    <div class="card wide">
      <b>${i18n.lang==='ar'?'جمعيات مسجلة':'Registered NGOs'}</b>
      ${tableNPOs(store.state.npof || store.state.nonprofits)}
    </div>
  </div>`
}

function viewCSR(root){
  if(!can('csr:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>CSR</h2><div class="actions">${can('csr:create')?`<button onclick=\"openModal('modal-csr')\">${i18n.lang==='ar'?'مساهمة جديدة':'New Contribution'}</button>`:''}</div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'إجمالي المساهمات (ر.س)':'Total Contributions (SAR)', fmt(store.state.csr.reduce((a,c)=>a+c.amount,0)))}
    ${kpiCard(i18n.lang==='ar'?'عدد الشركات':'Companies', new Set(store.state.csr.map(c=>c.company)).size)}
    ${kpiCard(i18n.lang==='ar'?'مبادرات مدعومة':'Supported Initiatives', new Set(store.state.csr.map(c=>c.to)).size)}
    <div class="card half">
      <b>${i18n.lang==='ar'?'المساهمات':'Contributions'}</b>
      ${tableCSR(store.state.csr)}
    </div>
    <div class="card half">
      <b>${i18n.lang==='ar'?'سوق الرعاية':'Marketplace'}</b>
      ${tableMarketplace(store.state.marketplace)}
    </div>
  </div>`
}

function viewAdmin(root){
  if(!can('admin:view')){ return (root.innerHTML = denyCard()) }
  root.innerHTML = `
  <div class="toolbar"><h2>${i18n.lang==='ar'?'اللجنة الوطنية / إدارة المنصة':'National Committee / Platform Admin'}</h2><div class="actions"><button class="warn" onclick="seedDemo()">${i18n.lang==='ar'?'ملء بيانات تجريبية':'Seed Demo'}</button><button class="danger" onclick="wipe()">${i18n.lang==='ar'?'مسح البيانات':'Wipe Data'}</button></div></div>
  <div class="cards">
    ${kpiCard(i18n.lang==='ar'?'مستخدمون نشطون (تجريبي)':'Active Users (Demo)', 312)}
    ${kpiCard(i18n.lang==='ar'?'عمليات تكامل ناجحة':'Successful Integrations', 99+'%')}
    ${kpiCard(i18n.lang==='ar'?'أمان وامتثال':'Security & Compliance', 'PDPL / MFA')}
    <div class="card half"><b>${i18n.lang==='ar'?'إعدادات عامة':'General Settings'}</b>
      <div class="grid two">
        <div class="field"><label>${i18n.lang==='ar'?'منطقة افتراضية':'Default Region'}</label><select onchange="setRegion(this.value)"><option ${store.state.user.region==='الرياض'?'selected':''}>الرياض</option><option ${store.state.user.region==='حائل'?'selected':''}>حائل</option><option ${store.state.user.region==='الشرقية'?'selected':''}>الشرقية</option></select></div>
        <div class="field"><label>${i18n.lang==='ar'?'لغة الواجهة':'Interface Language'}</label><select id="langSel" onchange="setLang(this.value)"><option value="ar" ${i18n.lang==='ar'?'selected':''}>العربية</option><option value="en" ${i18n.lang==='en'?'selected':''}>English</option></select></div>
        <div class="field"><label>${i18n.lang==='ar'?'شعار الواجهة':'Logo'}</label><div class="actions"><button class="ghost" onclick="openModal('modal-logo')">${i18n.lang==='ar'?'رفع شعار':'Upload Logo'}</button></div></div>
      </div>
    </div>
    <div class="card half"><b>${i18n.lang==='ar'?'سياسات الخصوصية':'Privacy Policies'}</b>
      <div class="grid">
        <div class="tag">PoLP</div><div class="tag">Audit Trail</div><div class="tag">Encryption</div><div class="tag">Consent</div>
      </div>
    </div>
  </div>`
}

function viewMarket(root){ if(!can('market:view')) return (root.innerHTML=denyCard()); root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'سوق الرعاية':'Care Marketplace'}</h2><div class="actions">${can('market:create')?`<button onclick=\"openModal('modal-market')\">${i18n.lang==='ar'?'مبادرة جديدة':'New Initiative'}</button>`:''}</div></div><div class=\"cards\"><div class=\"card wide\">${tableMarketplace(store.state.marketplace,true)}</div></div>` }
function viewReferrals(root){ if(!can('referrals:view')) return (root.innerHTML=denyCard()); root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'الإحالات':'Referrals'}</h2><div class="actions">${can('referrals:create')?`<button onclick=\"openModal('modal-referral')\">${i18n.lang==='ar'?'إحالة جديدة':'New Referral'}</button>`:''}</div></div><div class=\"cards\"><div class=\"card wide\">${tableReferrals(store.state.referrals,true)}</div></div>` }
function viewReports(root){ if(!can('reports:view')) return (root.innerHTML=denyCard()); const totals={kids:store.state.households.reduce((a,h)=>a+h.children.length,0), scr:store.state.screenings.length, ref:store.state.referrals.length}; root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'التقارير':'Reports'}</h2><div class="actions"><button class="ghost" onclick="window.print()" data-i18n="btn.print">طباعة/حفظ PDF</button><button onclick=\"exportCSVs()\">${i18n.lang==='ar'?'تصدير CSV':'Export CSV'}</button></div></div><div class="cards">${kpiCard(i18n.lang==='ar'?'إجمالي الأطفال':'Total Children', fmt(totals.kids))}${kpiCard(i18n.lang==='ar'?'الفحوص':'Screenings', fmt(totals.scr))}${kpiCard(i18n.lang==='ar'?'الإحالات':'Referrals', fmt(totals.ref))}<div class="card wide" id="chart2"></div><div class="card wide"><b>${i18n.lang==='ar'?'سجل كامل':'Full Dump'}</b><pre style="white-space:pre-wrap;background:#0f172a;border:1px solid var(--border);padding:12px;border-radius:12px;direction:ltr">${escapeHtml(JSON.stringify(store.state,null,2))}</pre></div></div>`; drawTrend($('#chart2'), i18n.lang==='ar'?'تمويل شهري (ر.س)':'Monthly Funding (SAR)', [20,30,15,60,40,80]) }
function viewSettings(root){ root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'الإعدادات':'Settings'}</h2></div><div class="cards"><div class="card half"><b>${i18n.lang==='ar'?'إدارة الموافقات':'Consent Management'}</b><p class="help">${i18n.lang==='ar'?'نفس عناصر نافذة الخصوصية.':'Same as consent modal.'}</p><div class="actions"><button onclick="openConsent()">${i18n.lang==='ar'?'فتح':'Open'}</button></div></div><div class="card half"><b>${i18n.lang==='ar'?'جلسة المستخدم':'User Session'}</b><div class="actions"><button class="ghost" onclick="openLogin()">${i18n.lang==='ar'?'تبديل الدور':'Switch Role'}</button><button class="danger" onclick="wipe()">${i18n.lang==='ar'?'مسح البيانات المحلية':'Clear Local Data'}</button></div></div><div class="card wide"><b>${i18n.lang==='ar'?'وضع التكامل مع API':'API Bridge'}</b><div class="grid two"><div class="field"><label><input type="checkbox" id="api_enabled"> ${i18n.lang==='ar'?'تفعيل وضع API':'Enable API Mode'}</label><div class="help">${i18n.lang==='ar'?'عند التفعيل، يُستخدم REST بدلاً من LocalStorage.':'When enabled, REST replaces LocalStorage.'}</div></div><div class="field"><label>Base URL</label><input id="api_base" placeholder="https://api.example.com" /></div><div class="field"><label>Token</label><input id="api_token" placeholder="Bearer ..." /></div><div class="field"><label>${i18n.lang==='ar'?'الشعار':'Logo'}</label><div class="actions"><button class="ghost" onclick="openModal('modal-logo')">${i18n.lang==='ar'?'رفع شعار':'Upload Logo'}</button></div></div></div><div class="actions"><button onclick="applyApiSettings()">${i18n.lang==='ar'?'حفظ إعدادات API':'Save API Settings'}</button></div></div></div>`; $('#api_enabled').checked=api.enabled; $('#api_base').value=api.baseUrl; $('#api_token').value=api.token||'' }
function view404(root){ root.innerHTML = `<div class="empty"><b>${i18n.lang==='ar'?'الصفحة غير موجودة':'Page Not Found'}</b><div>${i18n.lang==='ar'?'المسار:':'Path:'} ${location.hash}</div></div>` }

function denyCard(){ return `<div class=\"empty\"><b>${i18n.lang==='ar'?'صلاحيات غير كافية':'Insufficient permissions'}</b></div>` }

/* ---------- Tables ---------- */
function tableKids(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'الرقم':'ID'}</th><th>${i18n.lang==='ar'?'الاسم':'Name'}</th><th>${i18n.lang==='ar'?'الميلاد':'Birthdate'}</th></tr></thead><tbody>${items.map(c=>`<tr><td>${c.id}</td><td>${c.name}</td><td>${c.dob}</td></tr>`).join('')}</tbody></table>` }
function tableScreenings(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'النوع':'Type'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th><th>${i18n.lang==='ar'?'النتيجة':'Result'}</th><th>${i18n.lang==='ar'?'المنشأة':'Facility'}</th></tr></thead><tbody>${items.map(s=>`<tr><td>${s.id}</td><td>${s.childId}</td><td>${s.type}</td><td>${s.date}</td><td>${s.result}</td><td>${s.facility}</td></tr>`).join('')}</tbody></table>` }
function tableReferrals(items,actions){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'من':'From'}</th><th>${i18n.lang==='ar'?'إلى':'To'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'الأولوية':'Priority'}</th><th>${i18n.lang==='ar'?'الحالة':'Status'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th>${actions?'<th></th>':''}</tr></thead><tbody>${items.map(r=>`<tr><td>${r.id}</td><td>${r.from}</td><td>${r.to}</td><td>${r.childId}</td><td>${r.priority}</td><td>${r.status}</td><td>${r.created}</td>${actions?`<td><button class='ghost' onclick=\"updateReferral('${r.id}')\">${i18n.lang==='ar'?'تحديث':'Update'}</button></td>`:''}</tr>`).join('')}</tbody></table>` }
function tableIEP(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'الأهداف':'Goals'}</th><th>${i18n.lang==='ar'?'مراجعة':'Review'}</th></tr></thead><tbody>${items.map(i=>`<tr><td>${i.id}</td><td>${i.childId}</td><td>${i.goals}</td><td>${i.review}</td></tr>`).join('')}</tbody></table>` }
function tableNPOs(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الاسم':'Name'}</th><th>${i18n.lang==='ar'?'المنطقة':'Region'}</th><th>${i18n.lang==='ar'?'برامج':'Programs'}</th><th>${i18n.lang==='ar'?'مستفيدون':'Beneficiaries'}</th></tr></thead><tbody>${items.map(n=>`<tr><td>${n.id||'-'}</td><td>${n.name}</td><td>${n.region}</td><td>${n.programs}</td><td>${n.beneficiaries}</td></tr>`).join('')}</tbody></table>` }
function tableCSR(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الشركة':'Company'}</th><th>${i18n.lang==='ar'?'المبلغ':'Amount'}</th><th>${i18n.lang==='ar'?'المبادرة':'Initiative'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th></tr></thead><tbody>${items.map(c=>`<tr><td>${c.id}</td><td>${c.company}</td><td>${fmt(c.amount)}</td><td>${c.to}</td><td>${c.date}</td></tr>`).join('')}</tbody></table>` }
function tableMarketplace(items,actions){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'المبادرة':'Initiative'}</th><th>KPI</th><th>${i18n.lang==='ar'?'المطلوب':'Requested'}</th><th>${i18n.lang==='ar'?'الممول':'Funded'}</th><th>${i18n.lang==='ar'?'الجهة':'Owner'}</th>${actions?'<th></th>':''}</tr></thead><tbody>${items.map(m=>`<tr><td>${m.id}</td><td>${m.title}</td><td>${m.kpi}</td><td>${fmt(m.ask)}</td><td>${fmt(m.funded)}</td><td>${m.owner}</td>${actions?`<td><button class='ghost' onclick=\"fund('${m.id}')\">${i18n.lang==='ar'?'تمويل':'Fund'}</button></td>`:''}</tr>`).join('')}</tbody></table>` }

/* ---------- Chart ---------- */
function drawTrend(el,title,data){ const w=el.clientWidth||600,h=160,p=18;const min=Math.min(...data),max=Math.max(...data); const points=data.map((v,i)=>{ const x=p + (i*(w-2*p))/(data.length-1); const y=h-p - ((v-min)*(h-2*p))/(max-min||1); return `${x},${y}` }).join(' '); el.innerHTML = `<b>${title}</b><svg viewBox=\"0 0 ${w} ${h}\" width=\"100%\" height=\"${h}\" role=\"img\" aria-label=\"${title}\"><polyline points=\"${points}\" fill=\"none\" stroke=\"${getComputedStyle(document.documentElement).getPropertyValue('--pri')}\" stroke-width=\"3\"/></svg>` }

/* ---------- Modals & Forms ---------- */
function openLogin(){openModal('modal-login')}
function openConsent(){ const c=store.state.consent;$('#c1').checked=c.c1;$('#c2').checked=c.c2;$('#c3').checked=c.c3;$('#c4').checked=c.c4;openModal('modal-consent') }
function openModal(id){$('#'+id).classList.add('open')}
function closeModal(id){$('#'+id).classList.remove('open')}

function doLogin(){ const role=$('#loginRole').value; const region=$('#loginRegion').value; store.state.user={role,region}; store.save(); $('#roleTag').textContent=(i18n.lang==='ar'?'دور: ':'Role: ')+role; closeModal('modal-login'); toast((i18n.lang==='ar'?'تم تسجيل الدخول كـ ':'Signed in as ')+role); enforceRBAC(); router() }
function saveConsent(){ store.state.consent={c1:$('#c1').checked,c2:$('#c2').checked,c3:$('#c3').checked,c4:$('#c4').checked}; store.save(); closeModal('modal-consent'); toast(i18n.lang==='ar'?'تم حفظ الموافقات':'Consents saved') }

function submitScreening(){ const id='S-'+Math.floor(Math.random()*1e5); const payload={ id, childId:$('#f_sc_child').value||'C-501', type:$('#f_sc_type').value, date:$('#f_sc_date').value||today(), result:$('#f_sc_result').value||'—', facility:$('#f_sc_facility').value||store.state.user.region+"/مركز صحي" }; if(api.enabled){ apiFetch('/screenings',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال الفحص عبر API':'Screening sent via API')).catch(()=>{store.state.screenings.push(payload);store.save();toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-screening');router()}) } else { store.state.screenings.push(payload); store.save(); closeModal('modal-screening'); toast(i18n.lang==='ar'?'تم تسجيل الفحص':'Screening recorded'); router() } }
function submitReferral(){ const id='R-'+Math.floor(Math.random()*1e5); const payload={ id, from:$('#f_ref_from').value, to:$('#f_ref_to').value, childId:$('#f_ref_child').value||'C-501', priority:$('#f_ref_pri').value, status:$('#f_ref_status').value, created:$('#f_ref_date').value||today() }; if(api.enabled){ apiFetch('/referrals',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال الإحالة عبر API':'Referral sent via API')).catch(()=>{store.state.referrals.push(payload);store.save();toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-referral');router()}) } else { store.state.referrals.push(payload); store.save(); closeModal('modal-referral'); toast(i18n.lang==='ar'?'تم إنشاء الإحالة':'Referral created'); router() } }
function updateReferral(id){ const r=store.state.referrals.find(x=>x.id===id); if(!r) return; const st=prompt(i18n.lang==='ar'?'تحديث الحالة:':'Update status:', r.status)||r.status; r.status=st; store.save(); toast(i18n.lang==='ar'?'تم التحديث':'Updated'); router() }
function submitIEP(){ const id='IEP-'+Math.floor(Math.random()*1e5); const payload={ id, childId:$('#f_iep_child').value||'C-502', goals:$('#f_iep_goals').value||'Goals', review:$('#f_iep_review').value||today() }; if(api.enabled){ apiFetch('/iep',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال IEP عبر API':'IEP sent via API')).catch(()=>{store.state.ieps.push(payload);store.save();toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-iep');router()}) } else { store.state.ieps.push(payload); store.save(); closeModal('modal-iep'); toast(i18n.lang==='ar'?'تم إنشاء IEP':'IEP created'); router() } }
function submitMarket(){ const id='M-'+Math.floor(Math.random()*1e5); const payload={ id, title:$('#f_m_title').value, kpi:$('#f_m_kpi').value, ask:parseInt($('#f_m_ask').value||'0',10), funded:0, owner:$('#f_m_owner').value||'جمعية' }; if(api.enabled){ apiFetch('/market',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال المبادرة عبر API':'Initiative sent via API')).catch(()=>{store.state.marketplace.push(payload);store.save();toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-market');router()}) } else { store.state.marketplace.push(payload); store.save(); closeModal('modal-market'); toast(i18n.lang==='ar'?'تمت إضافة المبادرة':'Initiative added'); router() } }
function submitCSR(){ const id='CSR-'+Math.floor(Math.random()*1e5); const payload={ id, company:$('#f_csr_company').value||'Company', amount:parseInt($('#f_csr_amount').value||'0',10), to:$('#f_csr_to').value||'M-1', date:$('#f_csr_date').value||today() }; if(api.enabled){ apiFetch('/csr',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(i18n.lang==='ar'?'تم إرسال المساهمة عبر API':'Contribution sent via API')).catch(()=>{store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===payload.to); if(m) m.funded+=payload.amount; store.save(); toast(i18n.lang==='ar'?'API غير متاح — حُفظ محليًا':'API unavailable — saved locally')}).finally(()=>{closeModal('modal-csr');router()}) } else { store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===payload.to); if(m) m.funded+=payload.amount; store.save(); closeModal('modal-csr'); toast(i18n.lang==='ar'?'تم تسجيل مساهمة CSR':'CSR contribution recorded'); router() } }
function fund(id){ const amount=parseInt(prompt(i18n.lang==='ar'?'مبلغ التمويل (ر.س):':'Funding amount (SAR):','10000')||'0',10); if(!amount) return; const payload={ id:'CSR-'+Math.floor(Math.random()*1e5), company:'Supporter', amount, to:id, date:today() }; if(api.enabled){ apiFetch('/csr',{method:'POST',body:JSON.stringify(payload)}).catch(()=>{}); } store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===id); if(m) m.funded+=amount; store.save(); toast(i18n.lang==='ar'?'تم تحديث التمويل':'Funding updated'); router() }
function addChild(){ const h=store.state.households[0]; const id='C-'+Math.floor(Math.random()*1e4); const name=prompt(i18n.lang==='ar'?'اسم الطفل:':'Child name:','طفلي'); const dob=prompt(i18n.lang==='ar'?'تاريخ الميلاد (YYYY-MM-DD):':'Birthdate (YYYY-MM-DD):',today()); if(!name) return; h.children.push({id,name,dob}); store.save(); toast(i18n.lang==='ar'?'تمت إضافة الطفل':'Child added'); router() }

/* ---------- Logo upload ---------- */
function uploadLogo(){ const f=$('#logoFile').files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ store.state.ui.logo=e.target.result; store.save(); $('#logo').src=store.state.ui.logo; closeModal('modal-logo'); toast(i18n.lang==='ar'?'تم تحديث الشعار':'Logo updated') }; r.readAsDataURL(f) }

/* ---------- CSV Exports ---------- */
function toCSV(rows, headers){ const esc=v=>(''+(v??'')).replaceAll('"','""'); const head=headers.join(','); const body=rows.map(r=>headers.map(h=>`"${esc(r[h])}"`).join(',')).join('
'); return head+'
'+body }
function exportCSVs(){
  const sCSV=toCSV(store.state.screenings,["id","childId","type","date","result","facility"]); download('screenings.csv',sCSV)
  const rCSV=toCSV(store.state.referrals,["id","from","to","childId","priority","status","created"]); download('referrals.csv',rCSV)
  const cCSV=toCSV(store.state.csr,["id","company","amount","to","date"]); download('csr.csv',cCSV)
  toast(i18n.lang==='ar'?'تم تصدير CSV':'CSV exported')
}

/* ---------- Settings helpers ---------- */
function setRegion(region){store.state.user.region=region;store.save();toast(i18n.lang==='ar'?'تم ضبط المنطقة':'Region set');router()}
function setLang(lang){ i18n.lang=lang; localStorage.setItem('nomu.lang',lang); applyI18n(); router() }
function applyApiSettings(){ api.enabled=$('#api_enabled').checked; api.baseUrl=$('#api_base').value||api.baseUrl; api.token=$('#api_token').value||null; toast(api.enabled?(i18n.lang==='ar'?'تم تفعيل وضع API':'API mode enabled'):(i18n.lang==='ar'?'تم تعطيل وضع API':'API mode disabled')) }

/* ---------- Init ---------- */
function initLogo(){ if(store.state.ui.logo){ $('#logo').src=store.state.ui.logo; $('#logo').classList.remove('ph') } }
router(); applyI18n(); enforceRBAC(); initLogo();
$('#roleTag').textContent = (i18n.lang==='ar'?'دور: ':'Role: ')+ (store.state.user.role||'guest')
</script>
</body>
</html>
