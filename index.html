<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>منصة نمو — تلبية × رؤية 2030</title>
<meta name="description" content="منصة نمو الوطنية — حل تشغيلي متكامل لرحلة الطفل 0–6 وربط الشركاء وفق رؤية 2030 وبدعم تلبية.">
<style>
  :root{
    --bg:#ffffff;--txt:#0f172a;--muted:#64748b;--soft:#f1f5f9;--brd:#e2e8f0;
    --nomu:#059669;--nomu-100:#d1fae5;--nomu-800:#065f46;
    --sky:#0ea5e9;--vision:#0f766e;--amber:#f59e0b;--emerald:#10b981;--violet:#7c3aed;
  }
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Arabic",Tahoma,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .container{max-width:1280px;margin-inline:auto}
  .btn{border:1px solid var(--brd);padding:.6rem 1rem;border-radius:12px;background:#fff;cursor:pointer}
  .btn:hover{background:#f8fafc}
  .btn-primary{background:var(--nomu);color:#fff;border-color:transparent}
  .btn-primary:hover{background:#047857}
  .btn-ghost{background:transparent;border-color:transparent}
  .chip{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#eef2f7;font-size:.75rem;color:#334155}
  .card{background:#fff;border:1px solid var(--brd);border-radius:18px;box-shadow:0 1px 2px rgba(0,0,0,.02)}
  .grid{display:grid;gap:1rem}
  .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
  .mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.mb-2{margin-bottom:.5rem}
  .p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.p-8{padding:2rem}
  .text-center{text-align:center}.text-right{text-align:right}.text-left{text-align:left}
  .text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}
  .muted{color:var(--muted)}
  .title{font-weight:800}
  .badge-ok{background:#dcfce7;color:#065f46}
  .badge-warn{background:#fef3c7;color:#92400e}
  .badge-accred{background:#e0f2fe;color:#075985}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:.7rem;border-top:1px solid var(--brd);vertical-align:top}
  .table thead th{background:#f8fafc;color:#475569}
  input,select,textarea{width:100%;padding:.6rem .7rem;border:1px solid var(--brd);border-radius:12px;background:#fff}
  textarea{resize:vertical}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--brd);z-index:10}
  #nav{display:none}
  @media(min-width:1200px){#nav{display:flex}}
  .navlink{padding:.6rem .8rem;border-radius:10px}
  .navlink:hover{background:#f1f5f9}
  .hero{background:linear-gradient(135deg,#ecfdf5,#ffffff 40%,#e0f2fe)}
  footer{border-top:1px solid var(--brd)}
  .mobile{display:flex;gap:.5rem}
  @media(min-width:768px){.mobile{display:none}}
  .left-logos{display:none}
  @media(min-width:768px){.left-logos{display:flex;gap:.5rem;align-items:center}}
  .cols-3{grid-template-columns:repeat(1,minmax(0,1fr))}
  @media(min-width:768px){.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .cols-2{grid-template-columns:repeat(1,minmax(0,1fr))}
  @media(min-width:992px){.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .cols-4{grid-template-columns:repeat(1,minmax(0,1fr))}
  @media(min-width:992px){.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}
  .hidden{display:none}
  .w-full{width:100%}
  .notice{background:#fffbeb;border:1px solid #fde68a;border-radius:12px;padding:.6rem}
  .svg-txt{display:flex;align-items:center;color:#0f766e}
  #fatal{display:none;margin:.5rem;border-radius:10px}
</style>
</head>
<body>
<div id="fatal" class="notice"></div>

<header>
  <div class="container p-3 row" style="justify-content:space-between">
    <!-- يمين: شعار نمو -->
    <a href="#/home" class="row">
      <svg viewBox="0 0 220 60" style="height:36px;width:auto"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stop-color="#059669" stop-opacity=".35"/><stop offset="100%" stop-color="#059669" stop-opacity=".9"/></linearGradient></defs>
        <circle cx="18" cy="16" r="6" fill="url(#g)"></circle>
        <path d="M10 46 Q18 28 28 36 T48 46" fill="none" stroke="#059669" stroke-width="6" stroke-linecap="round"></path>
        <path d="M75 28 q14-10 24 0 t24 0" fill="none" stroke="#059669" stroke-width="6" stroke-linecap="round"></path>
        <path d="M73 44 q14 12 24 0 t24 0" fill="none" stroke="#059669" stroke-width="6" stroke-linecap="round"></path>
        <line x1="10" y1="52" x2="200" y2="52" stroke="#059669" stroke-width="2" stroke-linecap="round" opacity=".2"></line>
      </svg>
      <span class="text-xl title" style="color:var(--nomu)">منصة نمو</span>
    </a>

    <!-- وسط: روابط -->
    <nav id="nav" class="row text-sm">
      <a class="navlink" href="#/home">الرئيسية</a>
      <a class="navlink" href="#/journey">رحلة الطفل</a>
      <a class="navlink" href="#/kpis">مؤشرات الأداء</a>
      <a class="navlink" href="#/directory">الدليل الوطني للشركاء</a>
      <a class="navlink" href="#/referrals">الإحالات</a>
      <a class="navlink" href="#/health">الصحة</a>
      <a class="navlink" href="#/education">التعليم</a>
      <a class="navlink" href="#/ngo">الجمعيات</a>
      <a class="navlink" href="#/wallet">الرعايات/المحفظة</a>
      <a class="navlink" href="#/govern">الحوكمة</a>
      <a class="navlink" href="#/support">الدعم</a>
      <a class="navlink" href="#/settings">الإعدادات</a>
      <a class="navlink" href="#/admin">الإدارة</a>
    </nav>

    <!-- يسار: شعارات + أدوات -->
    <div class="left-logos">
      <div class="svg-txt" title="رؤية 2030"><svg viewBox="0 0 200 60" style="height:32px;width:auto"><text x="0" y="38" font-size="28" font-weight="700" fill="currentColor">رؤية 2030</text></svg></div>
      <div class="svg-txt" style="color:#0369a1" title="تلبية"><svg viewBox="0 0 200 60" style="height:32px;width:auto"><text x="0" y="38" font-size="28" font-weight="700" fill="currentColor">تلبية</text></svg></div>
      <span id="roleChip" class="chip"></span>
      <select id="regionSel" class="text-sm"></select>
      <button id="switchRoleBtn" class="btn text-sm">تبديل الدور</button>
    </div>

    <!-- جوال: زر قائمة -->
    <div class="mobile">
      <div class="svg-txt" title="رؤية 2030"><svg viewBox="0 0 200 60" style="height:24px;width:auto"><text x="0" y="28" font-size="20" font-weight="700" fill="currentColor">رؤية</text></svg></div>
      <div class="svg-txt" style="color:#0369a1" title="تلبية"><svg viewBox="0 0 200 60" style="height:24px;width:auto"><text x="0" y="28" font-size="20" font-weight="700" fill="currentColor">تلبية</text></svg></div>
      <button id="menuBtn" class="btn" aria-label="فتح القائمة">☰</button>
    </div>
  </div>

  <div id="mobileMenu" class="hidden">
    <div class="container p-3 grid" style="border-top:1px solid var(--brd);background:#fff">
      <a class="navlink" href="#/home">الرئيسية</a>
      <a class="navlink" href="#/journey">رحلة الطفل</a>
      <a class="navlink" href="#/kpis">مؤشرات الأداء</a>
      <a class="navlink" href="#/directory">الدليل الوطني للشركاء</a>
      <a class="navlink" href="#/referrals">الإحالات</a>
      <a class="navlink" href="#/health">الصحة</a>
      <a class="navlink" href="#/education">التعليم</a>
      <a class="navlink" href="#/ngo">الجمعيات</a>
      <a class="navlink" href="#/wallet">الرعايات/المحفظة</a>
      <a class="navlink" href="#/govern">الحوكمة</a>
      <a class="navlink" href="#/support">الدعم</a>
      <a class="navlink" href="#/settings">الإعدادات</a>
      <a class="navlink" href="#/admin">الإدارة</a>
      <div class="row mt-2">
        <span id="mRoleChip" class="chip"></span>
        <select id="mRegionSel" class="text-sm"></select>
        <button id="mSwitchRoleBtn" class="btn text-sm">تبديل الدور</button>
      </div>
    </div>
  </div>
</header>

<main id="root"></main>

<footer class="mt-8 p-6">
  <div class="container row" style="justify-content:space-between;align-items:center">
    <div class="row">
      <svg viewBox="0 0 220 60" style="height:28px;width:auto"><circle cx="18" cy="16" r="6" fill="#a7f3d0"></circle><path d="M10 46 Q18 28 28 36 T48 46" fill="none" stroke="#059669" stroke-width="4" stroke-linecap="round"></path></svg>
      <span class="muted">© <span id="y"></span> — منصة نمو</span>
    </div>
    <div class="muted text-center">بمواءمة رؤية 2030 وبدعم تلبية</div>
    <div class="muted">جميع الحقوق محفوظة لشركة تلبية للبحث والتطوير</div>
  </div>
</footer>

<script>
/* ====== حماية من الصفحة البيضاء ====== */
function fatal(msg){var f=document.getElementById('fatal');f.textContent=msg;f.style.display='block';}

/* ====== مخزن بسيط ====== */
const store={
  get:(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}},
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  del:(k)=>localStorage.removeItem(k)
};

/* ====== بيانات أساسية ====== */
const REGIONS=["الرياض","مكة المكرمة","الشرقية","المدينة","عسير","حائل","تبوك","القصيم","نجران","جازان","الجوف","الباحة","الحدود الشمالية"];
const ROLES=[
  {id:"family",label:"الأسرة/الأفراد"},
  {id:"health",label:"الصحة"},
  {id:"edu",label:"التعليم"},
  {id:"ngo",label:"الجمعيات"},
  {id:"csr",label:"القطاع الخاص (CSR)"},
  {id:"national",label:"اللجنة الوطنية"},
  {id:"admin",label:"إدارة المنصة"}
];
const CONTACT={ email:"info@talbiya.sa", whatsapp:"966556083172" };

/* ====== تهيئة بيانات تجريبية ====== */
function seed(){
  if(!store.get("nomu_initialized",false)){
    store.set("user",{role:"family",region:"الرياض",name:"مستخدم"});
    store.set("kpis",{period:"آخر 30 يومًا",byRegion:{
      "الرياض":{coverage:82,immunization:91,readiness:76,referralsMedianHrs:18,kgEnroll:88,completeness:96},
      "مكة المكرمة":{coverage:78,immunization:89,readiness:72,referralsMedianHrs:22,kgEnroll:84,completeness:94}
    }});
    store.set("children",[
      {id:"CH-001",familyId:"F-001",name:"سعود",gender:"M",birthDate:"2021-06-10",region:"الرياض"},
      {id:"CH-002",familyId:"F-001",name:"نورة",gender:"F",birthDate:"2023-02-02",region:"الرياض"}
    ]);
    store.set("screenings",[
      {id:"SC-100",childId:"CH-002",type:"newborn_hearing",date:"2023-02-05",result:"PASS"},
      {id:"SC-101",childId:"CH-001",type:"developmental",date:"2024-10-01",result:"Needs follow-up"}
    ]);
    store.set("referrals",[
      {id:"RF-1001",child:"سعود",type:"تعليمي",status:"قيد المعالجة",created:"2025-09-22",region:"الرياض",notes:"تقييم جاهزية",meta:{}},
      {id:"RF-1002",child:"نورة",type:"صحي",status:"مفتوحة",created:"2025-09-28",region:"الرياض",notes:"متابعة سمع",meta:{}}
    ]);
    store.set("wallet",{total:35000,entries:[
      {id:"TRX-01",source:"شركة ألف — رعاية روضة",amount:20000,date:"2025-09-05",tag:"CSR",meta:{}},
      {id:"TRX-02",source:"منحة تعليم مبكر",amount:10000,date:"2025-09-18",tag:"Grant",meta:{}},
      {id:"TRX-03",source:"متبرع فردي",amount:5000,date:"2025-10-01",tag:"Donation",meta:{}}
    ]});
    store.set("notifications",[
      {id:"NT-01",level:"info",text:"تذكير: موعد تقييم نمائي بعد 3 أيام."},
      {id:"NT-02",level:"warn",text:"إحالة RF-1002 تجاوزت 48 ساعة دون تحديث."}
    ]);

    /* دليل الشركاء — بيانات مع الاعتماد والترخيص وتاريخ الانتهاء */
    store.set("partners", [
      {
        id:"H-001", type:"health", name:"مركز رعاية الطفل الأولية - العليا",
        region:"الرياض", city:"الرياض", district:"العليا",
        accredited:true, licenseRef:"MOH-12345", licenseExpiry:"2026-03-31",
        acceptsDigital:true,
        address:"شارع رقم 10، العليا",
        coords:{lat:24.7136, lng:46.6753},
        public:{ phone:"011-100-1000", email:"info@h1.sa", website:"https://h1.sa" },
        op:{ contact:"ops@h1.sa", capacity:"متوسط", sla:"≤ 24 س", referral:"API" },
        updated:"2025-10-01"
      },
      {
        id:"E-002", type:"education", name:"روضة براعم الغد",
        region:"مكة المكرمة", city:"جدة", district:"الروضة",
        accredited:true, licenseRef:"MOE-77821", licenseExpiry:"2027-01-15",
        acceptsDigital:false,
        address:"شارع الروضة العام",
        coords:{lat:21.5433, lng:39.1728},
        public:{ phone:"012-200-2000", email:"hello@kg2.sa", website:"https://kg2.sa" },
        op:{ contact:"ops@kg2.sa", capacity:"مرتفع", sla:"≤ 3 أيام", referral:"بوابة" },
        updated:"2025-09-20"
      },
      {
        id:"N-003", type:"ngo", name:"جمعية النمو المبكر",
        region:"الشرقية", city:"الدمام", district:"الشاطئ",
        accredited:false, licenseRef:"MHRSD-5566", licenseExpiry:"2025-12-31",
        acceptsDigital:true,
        address:"طريق الخليج",
        coords:{lat:26.4207, lng:50.0888},
        public:{ phone:"013-300-3000", email:"contact@ngo3.sa", website:"https://ngo3.sa" },
        op:{ contact:"ops@ngo3.sa", capacity:"محدود", sla:"≤ 5 أيام", referral:"بريد" },
        updated:"2025-09-28"
      }
    ]);

    store.set("nomu_initialized",true);
  }
}

/* ====== أدوات UI ====== */
const $ = (sel,root=document)=>root.querySelector(sel);
function el(tag, attrs={}, children=[]){
  const e=document.createElement(tag);
  for(const k in attrs){
    if(k==="class") e.className=attrs[k];
    else if(k==="style") e.setAttribute("style",attrs[k]);
    else if(k.startsWith("on") && typeof attrs[k]==="function") e.addEventListener(k.substring(2).toLowerCase(),attrs[k]);
    else e.setAttribute(k,attrs[k]);
  }
  if(!Array.isArray(children)) children=[children];
  children.filter(Boolean).forEach(c=>{
    if(typeof c==="string") e.appendChild(document.createTextNode(c));
    else e.appendChild(c);
  });
  return e;
}
function chip(text,cls='chip'){return el('span',{class:cls},text)}
function stat(label,val,ok=true){
  const cls=ok?'badge-ok':'badge-warn';
  return el('div',{class:'card p-5'},[
    el('div',{class:'text-sm muted'},label),
    el('div',{class:'mt-2 text-3xl title'},String(val)),
    el('span',{class:`chip mt-2 ${cls}`}, ok?'جيد':'يتطلب تحسين')
  ]);
}
function table(headings,rows){
  const t=el('table',{class:'table'});
  const thead=el('thead',{},[el('tr',{},headings.map(h=>el('th',{},h)))]);
  const tbody=el('tbody',{},rows.map(r=>el('tr',{},r.map(c=>el('td',{},c)))));
  t.appendChild(thead);t.appendChild(tbody);return t;
}
function inputField(f,data,onChange){
  const wrap=el('div',{},[]);
  const label=el('label',{class:'text-xs muted'},f.label+(f.required?' *':''));
  let visible=true;
  if(f.dependsOn){ const v=data[f.dependsOn.key]; visible = v===f.dependsOn.value; }
  if(!visible) return el('div',{class:'hidden'});
  let input;
  if(f.type==='textarea'){
    input=el('textarea',{rows:3,placeholder:f.placeholder||''});
    input.value=data[f.key]||'';
    input.addEventListener('input',()=>onChange(f.key,input.value));
  }else if(f.type==='select'){
    input=el('select',{},[el('option',{value:''},'— اختر —'),...(f.options||[]).map(o=>el('option',{value:o},o))]);
    input.value=data[f.key]||'';
    input.addEventListener('change',()=>onChange(f.key,input.value));
  }else if(f.type==='checkbox'){
    input=el('input',{type:'checkbox'});
    input.checked=!!data[f.key];
    input.addEventListener('change',()=>onChange(f.key,input.checked));
    return el('label',{class:'row text-sm mt-2'},[input, ' ', f.label+(f.required?' *':'')]);
  }else{
    const typeMap=['text','number','tel','email','date'].includes(f.type)?f.type:'text';
    input=el('input',{type:typeMap,placeholder:f.placeholder||''});
    if(data[f.key]!==undefined) input.value=data[f.key];
    input.addEventListener('input',()=>onChange(f.key,typeMap==='number'?Number(input.value):input.value));
  }
  wrap.appendChild(label);wrap.appendChild(el('div',{class:'mt-1'},[input]));return wrap;
}
function validateRequired(fields,data){
  for(const f of fields.filter(x=>x.required)){
    if(f.dependsOn){const v=data[f.dependsOn.key]; if(v!==f.dependsOn.value) continue;}
    const val=data[f.key];
    if(f.type==='checkbox'){ if(!val) return f.label; }
    else if(val===undefined||val===null||val==='') return f.label;
  }
  return null;
}

/* ====== مخططات النماذج ====== */
const SCHEMAS={
  referral:{
    common:[
      {key:"childName",label:"اسم الطفل",type:"text",required:true},
      {key:"childNid",label:"هوية/سجل الأسرة (اختياري)",type:"text"},
      {key:"refType",label:"نوع الإحالة",type:"select",required:true,options:["صحي","نمائي 0–3","تعليمي","دعم أسري"]},
      {key:"region",label:"المنطقة",type:"select",required:true,options:REGIONS},
      {key:"receiverOrg",label:"جهة الاستقبال (اختياري)",type:"text"},
      {key:"receiverId",label:"معرف الجهة (اختياري)",type:"text"},
      {key:"geo",label:"الموقع (رابط خرائط)",type:"text"},
      {key:"summary",label:"وصف مختصر",type:"textarea"},
      {key:"attachments",label:"روابط مرفقات (URL مفصول بفواصل)",type:"text"}
    ],
    byRole:{
      family:[
        {key:"guardianPhone",label:"هاتف ولي الأمر",type:"tel",required:true},
        {key:"preferredContact",label:"طريقة التواصل",type:"select",options:["الهاتف","واتساب","البريد"],required:true},
        {key:"consent",label:"موافقة مشاركة البيانات",type:"checkbox",required:true},
        {key:"consentAt",label:"تاريخ/وقت الموافقة",type:"date"}
      ],
      health:[
        {key:"diagnosis",label:"تشخيص/ملاحظة أولية",type:"textarea",required:true},
        {key:"icd10",label:"ترميز ICD-10",type:"text"},
        {key:"priority",label:"الأولوية",type:"select",options:["عاجلة","مرتفعة","عادية"],required:true},
        {key:"slaHours",label:"SLA مستهدف (ساعات)",type:"number"}
      ],
      edu:[
        {key:"schoolId",label:"رقم المنشأة التعليمية",type:"text"},
        {key:"iep",label:"حالة IEP",type:"select",options:["غير مطبق","قيد الإعداد","مطبّق"],required:true},
        {key:"eduCode",label:"رمز برنامج/مسار",type:"text"}
      ],
      ngo:[
        {key:"program",label:"البرنامج/المبادرة",type:"select",options:["تدخل مبكر","إرشاد أسري","دعم مجتمعي"],required:true},
        {key:"capacity",label:"الطاقة الاستيعابية",type:"number"},
        {key:"outcomeMetric",label:"مؤشر ناتج",type:"select",options:["جلسات منجزة","أسر مخدومة","زيارات منزلية"]}
      ],
      csr:[
        {key:"sponsor",label:"اسم الجهة الراعية",type:"text",required:true},
        {key:"contractNo",label:"رقم العقد/الاتفاق",type:"text"},
        {key:"fundingRef",label:"مرجع التزام مالي/منحة",type:"text"},
        {key:"reportingFreq",label:"دورية التقارير",type:"select",options:["شهري","ربع سنوي","سنوي"],required:true}
      ],
      national:[
        {key:"policyRef",label:"مرجع السياسة/الإجراء",type:"text"},
        {key:"regionScope",label:"النطاق الجغرافي",type:"select",options:["وطني","منطقة","محافظة"],required:true},
        {key:"auditFlag",label:"علامة للمراجعة الوطنية",type:"select",options:["نعم","لا"]}
      ],
      admin:[
        {key:"internalNote",label:"ملاحظة داخلية",type:"textarea"},
        {key:"sla",label:"مستوى الخدمة SLA",type:"select",options:["≤2س","≤8س","≤1يوم"],required:true},
        {key:"owner",label:"مسؤول الحالة",type:"text"}
      ]
    }
  },
  health:{
    common:[
      {key:"childId",label:"معرّف/اسم الطفل",type:"text",required:true},
      {key:"screenType",label:"نوع الفحص",type:"select",required:true,options:["newborn_hearing","metabolic","developmental","vision"]},
      {key:"date",label:"تاريخ الفحص",type:"date",required:true},
      {key:"result",label:"النتيجة",type:"select",required:true,options:["PASS","Needs follow-up","FAIL"]},
      {key:"attachments",label:"روابط تقارير (URL)",type:"text"}
    ],
    byRole:{
      family:[{key:"fasting",label:"هل الطفل صائم؟",type:"select",options:["نعم","لا"],dependsOn:{key:"screenType",value:"metabolic"}}],
      health:[
        {key:"facility",label:"المنشأة الصحية",type:"text",required:true},
        {key:"practitionerId",label:"رقم الممارس",type:"text",required:true},
        {key:"icd10",label:"ترميز ICD-10",type:"text"},
        {key:"vitals",label:"قراءات أساسية",type:"text",placeholder:"حرارة/وزن/طول..."},
        {key:"nextAppointment",label:"موعد المتابعة",type:"date"},
        {key:"notes",label:"ملاحظات",type:"textarea"}
      ],
      edu:[{key:"impactOnLearning",label:"أثر على التعلم",type:"select",options:["لا","محتمل","مؤكد"]}],
      ngo:[{key:"supportNeeded",label:"دعم بعد الفحص",type:"select",options:["جلسة إرشاد","زيارة منزلية","إحالة جمعية"]}],
      csr:[{key:"sponsorCovered",label:"مغطّى ضمن رعاية؟",type:"select",options:["نعم","لا"]}],
      national:[
        {key:"regionScope",label:"نطاق التقرير",type:"select",options:["وطني","منطقة","محافظة"]},
        {key:"qualityFlag",label:"مؤشر جودة بلاغ",type:"select",options:["S1","S2","S3"]}
      ],
      admin:[{key:"qaCheck",label:"جودة البيانات (QA)",type:"select",options:["S1","S2","S3"],required:true}]
    }
  },
  education:{
    common:[
      {key:"childName",label:"اسم الطفل",type:"text",required:true},
      {key:"childNid",label:"رقم الهوية (اختياري)",type:"text"},
      {key:"applicationType",label:"نوع الطلب",type:"select",required:true,options:["رياض أطفال","دعم جاهزية","خطة فردية IEP"]},
      {key:"date",label:"تاريخ التقديم",type:"date",required:true},
      {key:"region",label:"المنطقة",type:"select",options:REGIONS,required:true},
      {key:"attachments",label:"مرفقات (URL)",type:"text"}
    ],
    byRole:{
      family:[
        {key:"preferredKG",label:"الروضة المفضلة",type:"text"},
        {key:"transport",label:"حاجة للنقل المدرسي",type:"select",options:["نعم","لا"]},
        {key:"disabilityCat",label:"فئة إعاقة (إن وجدت)",type:"select",options:["لا يوجد","سمعي","بصري","طيف توحد","تعلمية","حركية"]}
      ],
      edu:[
        {key:"schoolId",label:"رقم المنشأة التعليمية",type:"text",required:true},
        {key:"readinessScore",label:"درجة الجاهزية (0–100)",type:"number"},
        {key:"placement",label:"المسار/المستوى",type:"text"},
        {key:"seatAvailability",label:"توفر مقاعد",type:"select",options:["متاح","محدود","ممتلئ"],required:true}
      ],
      health:[{key:"medicalNote",label:"ملاحظة طبية مؤثرة",type:"textarea"}],
      ngo:[{key:"supportProgram",label:"برنامج دعم مرافق",type:"select",options:["تدخل مبكر","علاج وظيفي","تخاطب"]}],
      csr:[
        {key:"scholarship",label:"منحة/رعاية للرسوم",type:"select",options:["نعم","لا"]},
        {key:"schAmount",label:"مبلغ المنحة (ر.س)",type:"number",dependsOn:{key:"scholarship",value:"نعم"}}
      ],
      national:[
        {key:"policyRef",label:"مرجع سياسة القبول",type:"text"},
        {key:"reportingFreq",label:"دورية التقارير",type:"select",options:["شهري","ربع سنوي","سنوي"]}
      ],
      admin:[{key:"sla",label:"SLA لمعالجة الطلب",type:"select",options:["≤2يوم","≤5أيام"],required:true}]
    }
  },
  ngo:{
    common:[
      {key:"caseTitle",label:"عنوان الحالة/النشاط",type:"text",required:true},
      {key:"program",label:"البرنامج",type:"select",required:true,options:["تدخل مبكر","إرشاد أسري","دعم مجتمعي"]},
      {key:"region",label:"المنطقة",type:"select",options:REGIONS,required:true},
      {key:"status",label:"الحالة",type:"select",options:["مجدولة","قيد التنفيذ","منفذة"]},
      {key:"attachments",label:"مرفقات (URL)",type:"text"}
    ],
    byRole:{
      ngo:[
        {key:"capacity",label:"الطاقة الاستيعابية",type:"number",required:true},
        {key:"beneficiaries",label:"عدد المستفيدين المتوقع",type:"number"},
        {key:"outcomeMetric",label:"مؤشر ناتج",type:"select",options:["جلسات","أسر","زيارات"]}
      ],
      family:[{key:"preferredTime",label:"الوقت المفضل",type:"select",options:["صباح","مساء"]}],
      health:[{key:"clinicalCoord",label:"منسق صحي",type:"text"}],
      edu:[{key:"schoolPartner",label:"شريك تعليمي",type:"text"}],
      csr:[{key:"sponsor",label:"الراعي",type:"text"},{key:"budget",label:"ميزانية مرصودة (ر.س)",type:"number"}],
      national:[{key:"policyRef",label:"مرجع توجيه",type:"text"}],
      admin:[{key:"qaCheck",label:"مراجعة جودة",type:"select",options:["S1","S2","S3"]}]
    }
  },
  wallet:{
    common:[
      {key:"source",label:"المصدر",type:"text",required:true},
      {key:"amount",label:"المبلغ (ر.س)",type:"number",required:true},
      {key:"date",label:"التاريخ",type:"date",required:true},
      {key:"tag",label:"التصنيف",type:"select",required:true,options:["CSR","Grant","Donation","Other"]},
      {key:"attachments",label:"روابط اتفاقيات/محاضر (URL)",type:"text"}
    ],
    byRole:{
      csr:[
        {key:"contractNo",label:"رقم العقد",type:"text"},
        {key:"MoU",label:"مرجع مذكرة تفاهم",type:"text"},
        {key:"impactKPI",label:"مؤشر أثر مستهدف",type:"select",options:["التغطية 0–6","التحصين","الجاهزية","زمن الإغلاق"],required:true},
        {key:"kpiTarget",label:"قيمة مستهدفة",type:"number"},
        {key:"period",label:"فترة الالتزام",type:"select",options:["شهري","ربع سنوي","سنوي"],required:true},
        {key:"escrow",label:"حساب ضمان (Escrow)",type:"select",options:["نعم","لا"]}
      ],
      ngo:[{key:"program",label:"البرنامج المستفيد",type:"select",options:["تدخل مبكر","إرشاد أسري","دعم مجتمعي"],required:true}],
      national:[
        {key:"regionScope",label:"نطاق الصرف",type:"select",options:["وطني","منطقة","محافظة"]},
        {key:"reportingFreq",label:"دورية التقارير",type:"select",options:["شهري","ربع سنوي","سنوي"]}
      ],
      admin:[{key:"internalNote",label:"ملاحظة داخلية",type:"textarea"}]
    }
  }
};

/* ====== عناصر مساعدة ====== */
function box(title,desc){return el('div',{class:'card p-5'},[el('div',{class:'title'},title),el('p',{class:'mt-2 text-sm muted'},desc)])}
function cardStat(big,label,bg){return el('div',{class:'card p-4',style:'background:'+bg},[el('div',{class:'text-3xl title'},big),el('div',{class:'text-xs mt-1 muted'},label)])}
function sectionTitle(title,actions=[]){
  return el('div',{class:'row',style:'justify-content:space-between;align-items:center'},[
    el('h2',{class:'text-xl title'},title),
    el('div',{class:'row'},actions)
  ]);
}
function sectionWrap(title,children){ return sectionContainer([sectionTitle(title), ...children]); }
function sectionContainer(children){ return el('section',{},[el('div',{class:'container p-6'},Array.isArray(children)?children:[children])]); }
function searchBox(on){ const i=el('input',{placeholder:'بحث...',class:'text-sm'}); i.addEventListener('input',()=>on(i.value)); return i; }
function dialog(title, build){
  const back=el('div',{style:'position:fixed;inset:0;background:rgba(0,0,0,.5);display:grid;place-items:center;z-index:50'});
  const box=el('div',{class:'card',style:'width:min(720px,92vw);max-height:90vh;overflow:auto'});
  const head=el('div',{class:'row p-3',style:'border-bottom:1px solid var(--brd);justify-content:space-between;align-items:center'},[
    el('div',{},[el('div',{class:'title'},title)]),
    el('button',{class:'btn',onClick:close},'✕')
  ]);
  const body=el('div',{class:'p-4'});
  box.appendChild(head); box.appendChild(body); back.appendChild(box);
  function close(){back.remove();}
  build(body,close);
  return back;
}

/* ====== الصفحات ====== */
function Home(){
  const notes=store.get("notifications",[]);
  const heroCards=el('div',{class:'grid cols-4 mt-4'},[
    cardStat('+90%','تحصين أساسي','#dcfce7'),
    cardStat('≤24س','وسيط إغلاق الإحالات','#e0f2fe'),
    cardStat('+85%','التحاق رياض الأطفال','#fef3c7'),
    cardStat('+95%','اكتمال السجل الأسري','#fae8ff')
  ]);
  return el('div',{},[
    el('section',{class:'hero'},[
      el('div',{class:'container p-6'},[
        el('div',{class:'card p-6 row',style:'align-items:center;justify-content:space-between;gap:1.25rem'},[
          el('div',{style:'flex:1'},[
            el('div',{class:'text-2xl title'},'منصة وطنية تربط رحلة الطفل (0–6) بكل الشركاء'),
            el('p',{class:'mt-3 muted'},'تحوّل نمو الإحالات إلى نتائج، وتعرض مؤشرات أثر متوائمة مع رؤية 2030، وبدعم تقني من تلبية. النماذج ديناميكية حسب الدور لضمان اكتمال دورة الحياة.'),
            el('div',{class:'row mt-3'},[
              el('a',{href:'#/journey',class:'btn btn-primary'},'ابدأ رحلة الطفل'),
              el('a',{href:'#/referrals',class:'btn'},'فتح إحالة'),
              el('a',{href:'#/kpis',class:'btn'},'عرض المؤشرات'),
              el('a',{href:'#/directory',class:'btn'},'الدليل')
            ])
          ]),
          heroCards
        ])
      ])
    ]),
    el('section',{},[
      el('div',{class:'container p-6'},[
        el('div',{class:'grid cols-3'},[
          box('سير عمل مُحكم','SLA وتنبيهات ومرفقات وتعليقات على كل حالة.'),
          box('تكامل وطني','نفاذ، NPHIES، نور، والدفع المحلي عند الحاجة.'),
          box('قياس أثر','لوحات KPIs مرتبطة بالمحفظة والبرامج.')
        ])
      ])
    ]),
    el('section',{},[
      el('div',{class:'container p-6'},[
        el('div',{class:'grid cols-3'}, notes.map(n => el('div',{class:'card p-4'},[
          el('div',{class:(n.level==='warn'?'badge-warn':'badge-ok')+' chip'}, n.level==='warn'?'تنبيه':'تذكير'),
          el('div',{class:'mt-2 text-sm'},n.text)
        ])))
      ])
    ])
  ]);
}

function KPIs(){
  const user=store.get("user",{});
  const k=store.get("kpis",{byRegion:{}}); const current=k.byRegion[user.region] || Object.values(k.byRegion)[0] || {coverage:0,immunization:0,readiness:0,referralsMedianHrs:0,kgEnroll:0,completeness:0};
  const periodSel = el('select',{},["آخر 7 أيام","آخر 30 يومًا","آخر 90 يومًا","سنة كاملة"].map(p=>el('option',{value:p},p)));
  periodSel.value=k.period||"آخر 30 يومًا";
  periodSel.addEventListener('change',()=>{k.period=periodSel.value;store.set('kpis',k);});
  return sectionWrap('مؤشرات الأداء — '+user.region,[
    el('div',{class:'row',style:'justify-content:space-between'},[
      el('div',{class:'title'},''),
      el('div',{},[periodSel])
    ]),
    el('div',{class:'grid cols-3 mt-4'},[
      stat('التغطية 0–6', current.coverage+'%', current.coverage>=80),
      stat('اكتمال التحصين', current.immunization+'%', current.immunization>=90),
      stat('جاهزية التعليم', current.readiness+'%', current.readiness>=75),
      el('div',{class:'card p-5'},[
        el('div',{class:'text-sm muted'},'وسيط إغلاق الإحالات'),
        el('div',{class:'mt-2 text-3xl title'}, current.referralsMedianHrs+'س'),
        chip('≤ 24 ساعة مستهدف','chip')
      ]),
      stat('التحاق رياض الأطفال', current.kgEnroll+'%', current.kgEnroll>=85),
      stat('اكتمال السجل الأسري', current.completeness+'%', current.completeness>=95)
    ])
  ]);
}

function Journey(){
  const children=store.get("children",[]);
  const screenings=store.get("screenings",[]);
  return sectionWrap('رحلة الطفل (0–6)',[
    el('div',{class:'grid cols-2 mt-4'},[
      el('div',{class:'card p-5'},[
        el('div',{class:'title text-lg'},'أطفال الأسرة'),
        el('ul',{class:'mt-3'}, children.map(c=>el('li',{class:'mt-2',style:'border-top:1px solid var(--brd);padding-top:.6rem'},[
          el('div',{class:'row',style:'justify-content:space-between'},[
            el('div',{},[el('b',{},c.name),' — ', (c.gender==='M'?'ذكر':'أنثى'),' — مولود ',c.birthDate]),
            chip(c.region)
          ])
        ])))
      ]),
      el('div',{class:'card p-5'},[
        el('div',{class:'title text-lg'},'الفحوص/التقييمات'),
        el('ul',{class:'mt-3'}, screenings.map(s=>el('li',{class:'mt-2',style:'border-top:1px solid var(--brd);padding-top:.6rem'},[
          el('div',{class:'row',style:'justify-content:space-between'},[
            el('div',{},[el('b',{},s.type),' — ',s.date]),
            chip(s.result==='PASS'?'سليم':'متابعة', s.result==='PASS'?'chip badge-ok':'chip badge-warn')
          ])
        ])))
      ])
    ])
  ]);
}

/* ====== Form Utilities ====== */
function dynamicForm(schemaCommon, schemaRole, onSave, prefill={}){
  const data={...prefill};
  const wrap=el('div',{class:'grid',style:'gap:.75rem'});
  const all=[...schemaCommon, ...schemaRole];
  function set(k,v){data[k]=v; render();}
  function render(){
    wrap.innerHTML='';
    all.forEach(f=>wrap.appendChild(inputField(f,data,set)));
  }
  render();
  const saveBtn=el('button',{class:'btn btn-primary'},'حفظ');
  saveBtn.addEventListener('click',()=>{
    const missing=validateRequired(all,data);
    if(missing){alert('الرجاء تعبئة: '+missing);return;}
    onSave(data,()=>{for(const k in data) delete data[k]; render();});
  });
  return [wrap, saveBtn];
}

/* ====== الإحالات ====== */
function Referrals(){
  const user=store.get("user",{role:"family",region:"الرياض"});
  const list=store.get("referrals",[]);
  let q='';
  const root=el('div',{});
  const header = sectionTitle('الإحالات',[
    searchBox(v=>{q=v;renderTable();}),
    el('button',{class:'btn btn-primary',onClick:()=>openModal()},'فتح إحالة')
  ]);
  const hintSelected = store.get('prefill_referral',null) ? el('div',{class:'notice mt-3'},`سيتم تعبئة جهة الاستقبال تلقائيًا: ${store.get('prefill_referral',{}).receiverOrg||''}`) : null;
  const tableWrap=el('div',{class:'card p-4 mt-4',style:'overflow:auto'});

  function renderTable(){
    const filtered=list.filter(r=>JSON.stringify(r).includes(q));
    tableWrap.innerHTML='';
    if(filtered.length===0){tableWrap.appendChild(el('div',{class:'text-center muted p-4'},'لا نتائج.'));return;}
    const rows=filtered.map(r=>[
      r.id, r.child, r.type, r.status, r.created, r.region,
      el('div',{class:'text-xs'}, Object.entries(r.meta||{}).map(([k,v])=>el('div',{},[el('b',{},k+': '), String(v)]) )),
      el('div',{},[
        el('button',{class:'btn text-xs',onClick:()=>setStatus(r.id,'قيد المعالجة')},'بدء'),
        ' ',
        el('button',{class:'btn text-xs',onClick:()=>setStatus(r.id,'مغلقة')},'إغلاق')
      ])
    ]);
    tableWrap.appendChild(table(['المعرف','الطفل','النوع','الحالة','التاريخ','المنطقة','تفاصيل',''],rows));
  }
  function setStatus(id,status){
    const idx=list.findIndex(x=>x.id===id); if(idx>-1){list[idx].status=status; store.set('referrals',list); renderTable();}
  }

  function openModal(){
    const prefill = store.get('prefill_referral', null) || {};
    const modal = dialog('فتح إحالة جديدة', (body,close)=>{
      const banner = prefill.receiverOrg ? el('div',{class:'notice mb-2'},`سيتم إرسال الإحالة إلى: ${prefill.receiverOrg} (${prefill.receiverId||'—'})`) : null;
      if(banner) body.appendChild(banner);
      const common=SCHEMAS.referral.common;
      const roleFields=SCHEMAS.referral.byRole[user.role]||[];
      const [form,saveBtn]=dynamicForm(common,roleFields,(data,reset)=>{
        const id="RF-"+Math.random().toString(36).slice(2,6).toUpperCase();
        const rec={
          id, child:data.childName, type:data.refType, status:"مفتوحة",
          created:new Date().toISOString().slice(0,10), region:data.region, notes:data.summary,
          meta: Object.fromEntries(Object.entries(data).filter(([k])=>!['childName','refType','region','summary'].includes(k)))
        };
        list.unshift(rec); store.set('referrals',list);
        store.del('prefill_referral');
        renderTable(); reset(); close();
      }, prefill);
      body.appendChild(form);
      body.appendChild(el('div',{class:'row mt-2',style:'justify-content:flex-end'},[
        el('button',{class:'btn',onClick:()=>{store.del('prefill_referral');close();}},'إلغاء'), saveBtn
      ]));
    });
    document.body.appendChild(modal);
  }

  renderTable();
  root.appendChild(header);
  if(hintSelected) root.appendChild(hintSelected);
  root.appendChild(tableWrap);
  return sectionContainer(root);
}

/* ====== الصحة ====== */
function Health(){
  const user=store.get("user",{role:"family"});
  const list=store.get("screenings",[]);
  let q='';
  const root=el('div',{});
  const header = sectionTitle('الصحة — الفحوص والتتبّع',[
    searchBox(v=>{q=v;renderTable();}),
    el('button',{class:'btn btn-primary',onClick:()=>openModal()},'تسجيل فحص')
  ]);
  const tableWrap=el('div',{class:'card p-4 mt-4',style:'overflow:auto'});

  function renderTable(){
    const filtered=list.filter(s=>JSON.stringify(s).includes(q));
    tableWrap.innerHTML='';
    if(filtered.length===0){tableWrap.appendChild(el('div',{class:'text-center muted p-4'},'لا سجلات.'));return;}
    const rows=filtered.map(s=>[
      s.id,
      (store.get('children',[]).find(c=>c.id===s.childId)?.name || s.childId),
      s.type, s.date, s.result,
      el('div',{class:'text-xs'}, Object.entries(s.meta||{}).map(([k,v])=>el('div',{},[el('b',{},k+': '), String(v)])))
    ]);
    tableWrap.appendChild(table(['المعرف','الطفل','النوع','التاريخ','النتيجة','تفاصيل'],rows));
  }
  function openModal(){
    const modal = dialog('تسجيل فحص', (body,close)=>{
      const [form,saveBtn]=dynamicForm(SCHEMAS.health.common, SCHEMAS.health.byRole[user.role]||[], (data,reset)=>{
        const id="SC-"+Math.random().toString(36).slice(2,6).toUpperCase();
        const rec={id,childId:data.childId,type:data.screenType,date:data.date,result:data.result,
          meta:Object.fromEntries(Object.entries(data).filter(([k])=>!['childId','screenType','date','result'].includes(k)) )};
        list.unshift(rec); store.set('screenings',list); renderTable(); reset(); close();
      });
      body.appendChild(form);
      body.appendChild(el('div',{class:'row mt-2',style:'justify-content:flex-end'},[
        el('button',{class:'btn',onClick:close},'إلغاء'), saveBtn
      ]));
    });
    document.body.appendChild(modal);
  }
  renderTable();
  return sectionContainer([header,tableWrap]);
}

/* ====== التعليم ====== */
function Education(){
  const user=store.get("user",{role:"family"});
  let apps = store.get("edu_apps",[
    {id:"KG-01",child:"سعود",status:"قيد المراجعة",region:"الرياض",date:"2025-09-15",meta:{}},
    {id:"KG-02",child:"نورة",status:"مقبول",region:"الرياض",date:"2025-10-03",meta:{}}
  ]);
  let q='';
  const header = sectionTitle('التعليم — طلبات رياض الأطفال/الجاهزية',[
    searchBox(v=>{q=v;render();}),
    el('button',{class:'btn btn-primary',onClick:()=>openModal()},'تقديم طلب')
  ]);
  const wrap=el('div',{class:'card p-4 mt-4',style:'overflow:auto'});

  function render(){
    wrap.innerHTML='';
    const filtered=apps.filter(a=>JSON.stringify(a).includes(q));
    if(filtered.length===0){wrap.appendChild(el('div',{class:'text-center muted p-4'},'لا سجلات.'));return;}
    const rows=filtered.map(a=>[
      a.id,a.child,a.status,a.date,a.region,
      el('div',{class:'text-xs'}, Object.entries(a.meta||{}).map(([k,v])=>el('div',{},[el('b',{},k+': '), String(v)]))),
      el('div',{}, a.status!=='مقبول' ? el('button',{class:'btn text-xs',onClick:()=>approve(a.id)},'قبول') : '')
    ]);
    wrap.appendChild(table(['المعرف','الطفل','الحالة','التاريخ','المنطقة','تفاصيل',''],rows));
  }
  function approve(id){apps=apps.map(a=>a.id===id?{...a,status:'مقبول'}:a); store.set('edu_apps',apps); render();}
  function openModal(){
    const modal = dialog('تقديم طلب تعليمي', (body,close)=>{
      const [form,saveBtn]=dynamicForm(SCHEMAS.education.common, SCHEMAS.education.byRole[user.role]||[], (data,reset)=>{
        const id="KG-"+Math.random().toString(36).slice(2,6).toUpperCase();
        const rec={id,child:data.childName,status:"قيد المراجعة",region:data.region,date:data.date,
          meta:Object.fromEntries(Object.entries(data).filter(([k])=>!['childName','applicationType','date','region'].includes(k)))};
        apps.unshift(rec); store.set('edu_apps',apps); render(); reset(); close();
      });
      body.appendChild(form);
      body.appendChild(el('div',{class:'row mt-2',style:'justify-content:flex-end'},[
        el('button',{class:'btn',onClick:close},'إلغاء'), saveBtn
      ]));
    });
    document.body.appendChild(modal);
  }
  render();
  return sectionContainer([header,wrap]);
}

/* ====== الجمعيات ====== */
function NGO(){
  const user=store.get("user",{role:"ngo"});
  let cases = store.get("ngo_cases",[
    {id:"NGO-11",title:"جلسة إرشاد أسري",status:"مجدولة",region:"الرياض",meta:{}},
    {id:"NGO-12",title:"دعم تدخل مبكر",status:"منفذة",region:"الرياض",meta:{}}
  ]);
  let q='';
  const header = sectionTitle('الجمعيات — إدارة البرامج',[
    searchBox(v=>{q=v;render();}),
    el('button',{class:'btn btn-primary',onClick:()=>openModal()},'إضافة نشاط')
  ]);
  const grid=el('div',{class:'grid cols-2 mt-4'});

  function render(){
    grid.innerHTML='';
    const filtered=cases.filter(c=>JSON.stringify(c).includes(q));
    if(filtered.length===0){grid.appendChild(el('div',{class:'muted'},'لا نتائج.'));return;}
    filtered.forEach(c=>{
      grid.appendChild(el('div',{class:'card p-5'},[
        el('div',{class:'row',style:'justify-content:space-between'},[
          el('b',{},c.title),
          chip(c.status, c.status==='منفذة'?'chip badge-ok':'chip')
        ]),
        el('div',{class:'text-sm muted mt-2'},`المعرف: ${c.id} — المنطقة: ${c.region}`),
        el('div',{class:'text-xs mt-2'}, Object.entries(c.meta||{}).map(([k,v])=>el('div',{},[el('b',{},k+': '), String(v)])))
      ]));
    });
  }
  function openModal(){
    const modal = dialog('إنشاء نشاط/حالة', (body,close)=>{
      const [form,saveBtn]=dynamicForm(SCHEMAS.ngo.common, SCHEMAS.ngo.byRole[user.role]||[], (data,reset)=>{
        const id="NGO-"+Math.random().toString(36).slice(2,6).toUpperCase();
        const rec={id,title:data.caseTitle,status:data.status,region:data.region,
          meta:Object.fromEntries(Object.entries(data).filter(([k])=>!['caseTitle','program','status','region'].includes(k)) )};
        cases.unshift(rec); store.set('ngo_cases',cases); render(); reset(); close();
      });
      body.appendChild(form);
      body.appendChild(el('div',{class:'row mt-2',style:'justify-content:flex-end'},[
        el('button',{class:'btn',onClick:close},'إلغاء'), saveBtn
      ]));
    });
    document.body.appendChild(modal);
  }
  render();
  return sectionContainer([header,grid]);
}

/* ====== المحفظة ====== */
function Wallet(){
  const user=store.get("user",{role:"csr"});
  const state=store.get("wallet",{total:0,entries:[]});
  let q='';
  const top=sectionTitle('سوق الرعايات/المحفظة',[
    searchBox(v=>{q=v;render();}),
    chip('الإجمالي: '+state.total.toLocaleString()+' ر.س','chip'),
    el('button',{class:'btn btn-primary',onClick:()=>openModal()},'إضافة مساهمة')
  ]);
  const wrap=el('div',{class:'grid',style:'gap:1.5rem'});
  const tableWrap=el('div',{class:'card p-4',style:'overflow:auto'});
  const aside=el('div',{class:'card p-4'},[
    el('div',{class:'title'},'ملخّص'),
    el('ul',{class:'mt-2 text-sm muted'},[
      el('li',{},'إدارة رعايات CSR والمنح والتبرعات وربطها بمؤشرات أثر مستهدفة.'),
      el('li',{},'حقول العقد/مذكرة التفاهم ودورية التقارير وEscrow لشفافية التمويل.')
    ])
  ]);

  function render(){
    const filtered=state.entries.filter(e=>JSON.stringify(e).includes(q));
    tableWrap.innerHTML='';
    const rows = filtered.map(e=>[
      e.id, e.source, chip(e.tag).outerHTML, e.amount.toLocaleString()+' ر.س', e.date,
      el('div',{class:'text-xs'}, Object.entries(e.meta||{}).map(([k,v])=>el('div',{},[el('b',{},k+': '), String(v)])))
    ]);
    if(rows.length===0) tableWrap.appendChild(el('div',{class:'text-center muted p-4'},'لا توجد عمليات بعد.'));
    else {
      const t=table(['المعرف','المصدر','التصنيف','المبلغ','التاريخ','تفاصيل'], rows.map(r=>r.map(c=> (typeof c==='string' && c.startsWith('<')) ? html(c) : c )));
      tableWrap.appendChild(t);
    }
  }
  function html(str){const d=document.createElement('div');d.innerHTML=str;return d.firstChild}
  function openModal(){
    const modal = dialog('إضافة مساهمة', (body,close)=>{
      const [form,saveBtn]=dynamicForm(SCHEMAS.wallet.common, SCHEMAS.wallet.byRole[user.role]||[], (data,reset)=>{
        const id="TRX-"+Math.random().toString(36).slice(2,6).toUpperCase();
        const entry={ id, source:data.source, amount:Number(data.amount), date:data.date, tag=data.tag,
          meta:Object.fromEntries(Object.entries(data).filter(([k])=>!['source','amount','date','tag'].includes(k)))};
        state.total+=entry.amount; state.entries.unshift(entry); store.set('wallet',state); render(); reset(); close();
      });
      body.appendChild(form);
      body.appendChild(el('div',{class:'row mt-2',style:'justify-content:flex-end'},[
        el('button',{class:'btn',onClick:close},'إلغاء'), saveBtn
      ]));
    });
    document.body.appendChild(modal);
  }

  render();
  wrap.appendChild(tableWrap); wrap.appendChild(aside);
  return sectionContainer([top, wrap]);
}

/* ====== الحوكمة ====== */
function Govern(){
  const policies=[
    "الامتثال لنظام حماية البيانات الشخصية (PDPL).",
    "سجل تدقيق (Audit Log) على كل العمليات.",
    "نموذج صلاحيات RBAC حسب الدور والجهة والمنطقة.",
    "سياسة احتفاظ بيانات ونسخ احتياطي واستعادة."
  ];
  return sectionWrap('الحوكمة والامتثال',[
    el('div',{class:'grid cols-2 mt-4'}, policies.map((p,i)=>el('div',{class:'card p-5'},[
      el('div',{class:'title'},'سياسة #'+(i+1)),
      el('div',{class:'mt-2 text-sm muted'},p)
    ])))
  ]);
}

/* ====== الدعم ====== */
function Support(){
  const pref=store.get('support_prefill',null)||{};
  const name=input('الاسم*','text',true);
  const email=input('البريد الإلكتروني*','email',true);
  const msg=textarea('وصف الطلب/المشكلة*',true);

  if(pref.name) name.el.value = pref.name;
  if(pref.email) email.el.value = pref.email;
  if(pref.message) msg.el.value = pref.message;

  function sendMail(){
    const s=encodeURIComponent(pref.subject || 'تواصل — منصة نمو');
    const b=encodeURIComponent(`الاسم: ${name.el.value}\nالبريد: ${email.el.value}\n\n${msg.el.value}\n`);
    location.href=`mailto:${CONTACT.email}?subject=${s}&body=${b}`;
    store.del('support_prefill');
  }
  function sendWA(){
    const t=encodeURIComponent(`مرحبًا فريق نمو/تلبية\nاسمي: ${name.el.value}\nبريدي: ${email.el.value}\n\n${msg.el.value}`);
    window.open(`https://wa.me/${CONTACT.whatsapp}?text=${t}`,'_blank');
    store.del('support_prefill');
  }
  return sectionWrap('الدعم الفني والتواصل',[
    el('div',{class:'grid cols-2 mt-4'},[
      el('div',{class:'card p-5'},[
        el('div',{class:'title'},'قنوات التواصل'),
        el('ul',{class:'mt-2 text-sm muted'},[
          el('li',{},['البريد: ', el('a',{href:`mailto:${CONTACT.email}`,style:'text-decoration:underline;color:var(--nomu)'},CONTACT.email)]),
          el('li',{},['واتساب: ', el('a',{href:`https://wa.me/${CONTACT.whatsapp}`,target:'_blank',style:'text-decoration:underline;color:var(--nomu)'},'+966 55 608 3172')])
        ])
      ]),
      el('div',{class:'card p-5'},[
        el('div',{class:'title'}, pref.subject ? 'نموذج تواصل — مُعبّأ بسبب الإبلاغ' : 'نموذج تواصل سريع'),
        el('form',{class:'grid mt-3',style:'gap:.75rem'},[
          name.wrap, email.wrap, msg.wrap,
          el('div',{class:'row'},[
            el('button',{type:'button',class:'btn btn-primary',onClick:sendMail},'إرسال عبر البريد'),
            el('button',{type:'button',class:'btn',onClick:sendWA},'إرسال عبر واتساب')
          ])
        ])
      ])
    ])
  ]);
}
function input(label,type='text',req=false){const elIn=el('input',{type});const w=el('div',{},[el('label',{class:'text-sm muted'},label),el('div',{class:'mt-1'},[elIn])]);return {el:elIn,wrap:w}}
function textarea(label,req=false){const elIn=el('textarea',{rows:5});const w=el('div',{},[el('label',{class:'text-sm muted'},label),el('div',{class:'mt-1'},[elIn])]);return {el:elIn,wrap:w}}

/* ====== الإعدادات ====== */
function Settings(){
  const u=store.get("user",{role:"family",region:"الرياض",name:""});
  const name=input('الاسم', 'text'); name.el.value=u.name||'';
  const roleSel=el('select',{}, ROLES.map(r=>el('option',{value:r.id},r.label))); roleSel.value=u.role;
  const regionSel=el('select',{}, REGIONS.map(r=>el('option',{value:r},r))); regionSel.value=u.region;
  function save(){
    const nu={role:roleSel.value,region:regionSel.value,name:name.el.value};
    store.set('user',nu); syncHeader(); alert('تم الحفظ'); location.hash='#/home';
  }
  function reset(){
    ["kpis","children","screenings","referrals","wallet","notifications","edu_apps","ngo_cases","partners","user","support_prefill","prefill_referral","nomu_initialized"].forEach(store.del);
    seed(); location.reload();
  }
  return sectionWrap('الإعدادات',[
    el('div',{class:'grid cols-3 mt-4'},[
      el('div',{class:'card p-5'},[
        el('div',{class:'title'},'الحساب'),
        el('div',{class:'grid mt-3',style:'gap:.5rem'},[
          labelWrap('الاسم', name.wrap),
          labelWrap('الدور', el('div',{},[roleSel])),
          labelWrap('المنطقة', el('div',{},[regionSel])),
          el('div',{class:'row mt-2'},[
            el('button',{class:'btn btn-primary',onClick:save},'حفظ')
          ])
        ])
      ]),
      el('div',{class:'card p-5'},[
        el('div',{class:'title'},'البيانات'),
        el('button',{class:'btn mt-2',onClick:reset},'تصفير جميع البيانات'),
        el('p',{class:'text-xs muted mt-2'},'سيتم إعادة توليد بيانات تجريبية.')
      ]),
      el('div',{class:'card p-5'},[
        el('div',{class:'title'},'عن النماذج الديناميكية'),
        el('ul',{class:'mt-2 text-sm muted'},[
          el('li',{},'النماذج تُبنى من مخططات لكل وحدة ودور.'),
          el('li',{},'الحقول تتغير تلقائيًا عند تبديل الدور لضمان اكتمال دورة الحياة.'),
          el('li',{},'يمكن ربط هذه المخططات لاحقًا بواجهات APIs للتخزين المركزي.')
        ])
      ])
    ])
  ]);
}
function labelWrap(lbl,child){return el('div',{},[el('label',{class:'text-sm muted'},lbl),el('div',{class:'mt-1'},[child])])}

/* ====== الإدارة ====== */
function Admin(){
  const rows=[
    {entity:"الإحالات", family:"R", health:"RW", edu:"RW", ngo:"RW", csr:"R", national:"R", admin:"RW"},
    {entity:"الفحوص",  family:"R", health:"RW", edu:"R",  ngo:"R",  csr:"-", national:"R", admin:"RW"},
    {entity:"التعليم",  family:"R", health:"-",  edu:"RW", ngo:"R",  csr:"-", national:"R", admin:"RW"},
    {entity:"المحفظة",  family:"-", health:"-",  edu:"-",  ngo:"R",  csr:"RW", national:"R", admin:"RW"},
    {entity:"المؤشرات", family:"R", health:"R",  edu:"R",  ngo:"R",  csr:"R",  national:"RW", admin:"RW"}
  ];
  const head=['الكيان',...ROLES.map(r=>r.label)];
  const body=rows.map(r=>[r.entity, r.family, r.health, r.edu, r.ngo, r.csr, r.national, r.admin]);
  return sectionWrap('إدارة المنصة — مصفوفة الصلاحيات (تجريبي)',[
    el('div',{class:'card p-4 mt-4',style:'overflow:auto'},[table(head,body)])
  ]);
}

/* ====== الدليل الوطني للشركاء ====== */
function Directory(){
  const user = store.get("user",{role:"family",region:"الرياض"});
  let list = store.get("partners",[]);

  // فلاتر
  const typeSel = el('select',{},[
    el('option',{value:''},'كل الأنواع'),
    el('option',{value:'health'},'صحي'),
    el('option',{value:'education'},'تعليمي'),
    el('option',{value:'ngo'},'جمعيات')
  ]);
  const regionSel = el('select',{},[el('option',{value:''},'كل المناطق'), ...REGIONS.map(r=>el('option',{value:r},r))]);
  const accSel = el('select',{},[
    el('option',{value:''},'الاعتماد: الكل'),
    el('option',{value:'1'},'معتمد'),
    el('option',{value:'0'},'غير معتمد')
  ]);
  const digiSel = el('select',{},[
    el('option',{value:''},'الإحالات الرقمية: الكل'),
    el('option',{value:'1'},'يقبل إحالة رقمية'),
    el('option',{value:'0'},'لا يقبل إحالة رقمية')
  ]);
  const qInput = el('input',{placeholder:'بحث بالاسم/المدينة/الحي...',class:'text-sm'});

  const header = sectionTitle('الدليل الوطني للشركاء',[
    qInput,
    typeSel, regionSel, accSel, digiSel
  ]);

  const mapBox = el('div',{class:'card p-4'},[
    el('div',{class:'title'},'خريطة مبسطة'),
    el('div',{class:'text-xs muted mt-1'},'عرض توضيحي (SVG) — للاستبدال لاحقًا بتكامل خرائط.'),
    simpleMap()
  ]);

  const listWrap = el('div',{class:'grid cols-2 mt-4'});

  function matches(p){
    if(typeSel.value && p.type!==typeSel.value) return false;
    if(regionSel.value && p.region!==regionSel.value) return false;
    if(accSel.value!=='' && p.accredited !== (accSel.value==='1')) return false;
    if(digiSel.value!=='' && p.acceptsDigital !== (digiSel.value==='1')) return false;
    const q=(qInput.value||'').trim();
    if(q){
      const hay=[p.name,p.city,p.district,p.address,(p.licenseRef||'')].join(' ').toLowerCase();
      if(!hay.includes(q.toLowerCase())) return false;
    }
    return true;
  }

  function badge(text, cls){ return chip(text, cls||'chip'); }
  function typeLabel(t){ return t==='health'?'صحي': t==='education'?'تعليمي': t==='ngo'?'جمعيات':t; }

  function reportOutdated(p){
    const subject = `الإبلاغ عن بيانات قديمة — ${p.name} (${p.id})`;
    const message = `أبلغ بأن بيانات هذا الشريك قد تكون بحاجة تحديث:\n\nالاسم: ${p.name}\nالمعرف: ${p.id}\nالنوع: ${typeLabel(p.type)}\nالمنطقة: ${p.region}\nآخر تحديث مسجل: ${p.updated||'—'}\n\nتفاصيل التعديل المقترحة:\n- `;
    store.set('support_prefill',{
      subject, name: store.get('user',{}).name || '', email:'', message
    });
    location.hash = '#/support';
  }

  function sendReferral(p){
    // تعبئة مُسبقة لنموذج الإحالات
    store.set('prefill_referral',{
      receiverOrg: p.name,
      receiverId: p.id,
      region: p.region
    });
    location.hash = '#/referrals';
  }

  function card(p){
    const pub=p.public||{}, op=p.op||{};
    const isPublicView = (user.role==='family');
    const headRow = el('div',{class:'row',style:'justify-content:space-between;align-items:center'},[
      el('div',{},[el('b',{},p.name), ' — ', typeLabel(p.type)]),
      el('div',{class:'row'},[
        badge(p.accredited?'معتمد':'غير معتمد', p.accredited?'chip badge-accred':'chip badge-warn'),
        p.licenseRef ? badge('ترخيص: '+p.licenseRef,'chip') : null,
        p.licenseExpiry ? badge('ينتهي: '+p.licenseExpiry,'chip') : null,
        p.acceptsDigital? badge('يقبل إحالة رقمية','chip badge-ok') : badge('إحالة يدوية','chip')
      ].filter(Boolean))
    ]);
    const addr = el('div',{class:'text-sm muted mt-1'}, `${p.city||''} — ${p.district||''} — ${p.address||''}`);
    const contacts = el('div',{class:'text-sm mt-2'},[
      el('div',{},['هاتف: ', pub.phone || '—']),
      el('div',{},['بريد: ', pub.email ? el('a',{href:`mailto:${pub.email}`,style:'text-decoration:underline;color:var(--nomu)'},pub.email) : '—']),
      el('div',{},['موقع: ', pub.website ? el('a',{href:pub.website,target:'_blank',style:'text-decoration:underline;color:var(--nomu)'},pub.website) : '—'])
    ]);

    const ops = isPublicView ? null : el('div',{class:'mt-3 text-sm'},[
      el('div',{class:'title text-sm'},'تفاصيل تشغيلية (داخلي)'),
      el('div',{class:'mt-1'},[
        el('div',{},['نقطة اتصال تشغيلية: ', op.contact || '—']),
        el('div',{},['الطاقة الاستيعابية: ', op.capacity || '—']),
        el('div',{},['SLA: ', op.sla || '—']),
        el('div',{},['قناة الإحالة: ', op.referral || '—'])
      ])
    ]);

    const actions = el('div',{class:'row mt-2'},[
      el('button',{class:'btn btn-primary',onClick:()=>sendReferral(p)}, p.acceptsDigital?'إرسال إحالة الآن':'فتح نموذج إحالة'),
      el('button',{class:'btn',onClick:()=>reportOutdated(p)}, 'الإبلاغ عن بيانات قديمة')
    ]);

    const updated = el('div',{class:'text-xs muted mt-2'}, 'آخر تحديث: '+(p.updated||'—'));
    return el('div',{class:'card p-5'},[headRow, addr, contacts, ops, actions, updated]);
  }

  function render(){
    listWrap.innerHTML='';
    const filtered = list.filter(matches);
    if(filtered.length===0){ listWrap.appendChild(el('div',{class:'muted'},'لا نتائج مطابقة.')); return; }
    filtered.forEach(p=> listWrap.appendChild(card(p)));
    // تحديث الخريطة
    const svg = mapBox.querySelector('svg'); if(svg && svg.updatePins) svg.updatePins(filtered);
  }

  [qInput,typeSel,regionSel,accSel,digiSel].forEach(c=>c.addEventListener('input',render));
  [typeSel,regionSel,accSel,digiSel].forEach(c=>c.addEventListener('change',render));

  render();
  return sectionContainer([header, el('div',{class:'grid cols-2 mt-4'},[mapBox, el('div',{},[listWrap])])]);
}

function simpleMap(){
  // خريطة سعودية مبسطة جدًا كـ SVG مع “دبابيس” افتراضية
  const w=el('div',{style:'width:100%;height:320px'});
  const svgNS="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(svgNS,'svg');
  svg.setAttribute('viewBox','0 0 400 220');
  svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
  const bg=document.createElementNS(svgNS,'rect'); bg.setAttribute('x','0'); bg.setAttribute('y','0'); bg.setAttribute('width','400'); bg.setAttribute('height','220'); bg.setAttribute('fill','#eef2ff');
  const shape=document.createElementNS(svgNS,'rect'); shape.setAttribute('x','60'); shape.setAttribute('y','20'); shape.setAttribute('width','280'); shape.setAttribute('height','180'); shape.setAttribute('rx','16'); shape.setAttribute('fill','#e2e8f0'); // إطار رمزي
  svg.appendChild(bg); svg.appendChild(shape);
  const pinsGroup=document.createElementNS(svgNS,'g'); svg.appendChild(pinsGroup);

  function pin(x,y,color,label){
    const g=document.createElementNS(svgNS,'g');
    const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r','6'); c.setAttribute('fill',color||'#059669');
    const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',x+8); t.setAttribute('y',y+4); t.setAttribute('font-size','10'); t.setAttribute('fill','#0f172a'); t.textContent=label||'';
    g.appendChild(c); g.appendChild(t); pinsGroup.appendChild(g);
  }

  function project(p){
    const mapRegion={
      "الرياض":[200,90],"مكة المكرمة":[160,120],"الشرقية":[270,100],"المدينة":[120,90],
      "عسير":[140,160],"حائل":[160,70],"تبوك":[110,50],"القصيم":[180,70],
      "نجران":[190,175],"جازان":[150,185],"الجوف":[140,45],"الباحة":[150,150],"الحدود الشمالية":[200,40]
    };
    return mapRegion[p.region] || [200,110];
  }

  svg.updatePins = (items)=>{
    pinsGroup.innerHTML='';
    items.slice(0,30).forEach(p=>{
      const [x,y]=project(p);
      const color = p.type==='health'?'#059669': (p.type==='education'?'#0ea5e9':'#7c3aed');
      pin(x,y,color, p.name.slice(0,14));
    });
  };

  w.appendChild(svg);
  return w;
}

/* ====== الراوتر ====== */
const routes={
  '/home': Home,
  '/kpis': KPIs,
  '/journey': Journey,
  '/directory': Directory,
  '/referrals': Referrals,
  '/health': Health,
  '/education': Education,
  '/ngo': NGO,
  '/wallet': Wallet,
  '/govern': Govern,
  '/support': Support,
  '/settings': Settings,
  '/admin': Admin
};
function render(){
  try{
    const root=$("#root"); root.innerHTML='';
    const hash=location.hash || '#/home';
    const path=hash.replace('#','');
    const view = routes[path] || Home;
    root.appendChild(view());
  }catch(e){fatal('حدث خطأ غير متوقع أثناء العرض: '+e.message);}
}
window.addEventListener('hashchange',render);

/* ====== تزامن الهيدر (الدور/المنطقة) ====== */
function syncHeader(){
  const user=store.get('user',{role:'family',region:'الرياض'});
  const role=ROLES.find(r=>r.id===user.role);
  $('#roleChip').textContent=role?role.label:'—';
  $('#mRoleChip').textContent=role?role.label:'—';
  const regionSel=$('#regionSel'), mRegionSel=$('#mRegionSel');
  regionSel.innerHTML=''; mRegionSel.innerHTML='';
  REGIONS.forEach(r=>{regionSel.appendChild(el('option',{value:r},r)); mRegionSel.appendChild(el('option',{value:r},r));});
  regionSel.value=user.region; mRegionSel.value=user.region;
  regionSel.onchange = mRegionSel.onchange = (e)=>{store.set('user',{...user,region:e.target.value}); render();};
  $('#switchRoleBtn').onclick = $('#mSwitchRoleBtn').onclick = ()=>{
    const i = ROLES.findIndex(r=>r.id===user.role);
    const next = ROLES[(i+1)%ROLES.length].id;
    store.set('user',{...user,role:next}); syncHeader(); render();
  };
}

/* ====== قائمة الجوال ====== */
$('#menuBtn').addEventListener('click',()=>$('#mobileMenu').classList.toggle('hidden'));

/* ====== بدء التشغيل ====== */
document.getElementById('y').textContent=new Date().getFullYear();
seed(); syncHeader(); if(!location.hash) location.hash='/home'; render();
</script>
</body>
</html>
