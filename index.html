<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>منصة نمو NOMU — v3.4 (شعارات + تبويبات حسابات + المراكز)</title>
<style>
  :root{
    --bg:#f7fbff; --paper:#ffffff; --brand:#16a34a; --accent:#f59e0b; --ink:#0f172a; --sub:#475569;
    --muted:#f1f5f9; --border:#e2e8f0; --radius:18px; --pad:18px; --gap:14px; --gap-lg:22px;
    --shadow:0 10px 30px rgba(2,12,27,.06); --font:"Tajawal","Noto Kufi Arabic",system-ui,-apple-system,"Segoe UI",Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.7 var(--font)}
  a{color:#0ea5e9;text-decoration:none}
  header{position:sticky;top:0;z-index:40;background:#ffffffd9;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .topbar{max-width:1240px;margin:auto;padding:10px var(--pad);display:flex;align-items:center;gap:12px}
  .nomu-logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 180deg, #22c55e, #86efac, #34d399, #22c55e); box-shadow:0 6px 16px rgba(16,185,129,.25)}
  .nomu-badge b{font-size:18px}
  .left-logos{margin-inline-start:auto;display:flex;align-items:center;gap:8px}
  .pill-logo{display:flex;align-items:center;gap:8px;background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  .pill-logo img{height:28px;display:block}
  .main{max-width:1240px;margin:22px auto;display:grid;grid-template-columns:280px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
  nav .side{position:sticky;top:70px;background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
  .group h4{margin:10px 8px;color:var(--sub);font-size:13px}
  .link{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:var(--ink);border:1px solid transparent}
  .link:hover{background:var(--muted);border-color:var(--border)}
  .link.active{background:linear-gradient(180deg,#ecfdf5,#e7f9f0);border-color:#befae0}
  .content{display:grid;gap:var(--gap-lg)}
  .card{background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
  .toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#f0fdf4;color:#14532d;padding:6px 10px;border-radius:999px;font-size:12px}
  button,.btn{background:var(--brand);color:#052e1d;border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(34,197,94,.25)}
  .ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
  .grid{display:grid;gap:var(--gap)} .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:repeat(3,1fr)} .four{grid-template-columns:repeat(4,1fr)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px} th,td{text-align:right;padding:10px;background:#fcfdff} th{color:#64748b;font-size:12px}
  .pill{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;font-size:12px;margin:2px}
  .note{font-size:12px;color:#64748b}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:8px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer}
  .tab.active{background:#fff;border-color:#22c55e}
  .tabpanel{border:1px solid var(--border);border-radius:0 12px 12px 12px;padding:12px;background:#fff}
  .form label{display:block;margin:6px 0 4px}
  .form input,.form select,.form textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .callout{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:10px}
  footer{max-width:1240px;margin:24px auto 40px;color:#64748b;text-align:center;padding:0 var(--pad)}
  @media (max-width:980px){ .main{grid-template-columns:1fr} .four{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="nomu-badge">
      <div class="nomu-logo" aria-hidden="true"></div>
      <div><b>NOMU — منصة نمو</b><div style="font-size:12px;color:#0f766e">منصة وطنية للطفولة المبكرة</div></div>
    </div>
    <div class="left-logos">
      <!-- استبدل المسارات التالية بمسارات صورك الفعلية -->
      <span class="pill-logo" title="Vision 2030"><img src="Vision2030.png" alt="Vision 2030"/></span>
      <span class="pill-logo" title="مبادرة تلبية"><img src="Talbiya.png" alt="مبادرة تلبية"/></span>
    </div>
  </div>
</header>

<main class="main">
  <nav>
    <div class="side">
      <div class="group">
        <h4>التعاريف</h4>
        <a class="link" href="#/intro">عن المنصة</a>
        <a class="link" href="#/kpi-registry">سجل تعريفات KPI</a>
      </div>
      <div class="group">
        <h4>الحسابات</h4>
        <a class="link" href="#/acc/health">وزارة الصحة</a>
        <a class="link" href="#/acc/clinic">المراكز الصحية</a>
        <a class="link" href="#/acc/education">وزارة التعليم</a>
        <a class="link" href="#/acc/neighborhood">مراكز الأحياء</a>
        <a class="link" href="#/acc/nonprofit">الجمعيات</a>
        <a class="link" href="#/acc/hr">الموارد البشرية</a>
        <a class="link" href="#/acc/csr">القطاع الخاص</a>
        <a class="link" href="#/acc/family">الأسرة</a>
        <a class="link" href="#/acc/admin">اللجنة الوطنية</a>
      </div>
      <div class="group">
        <h4>الاستدامة</h4>
        <a class="link" href="#/sponsors">بوابة الرعاة</a>
      </div>
      <div class="group">
        <h4>الأمن والربط</h4>
        <a class="link" href="#/sso">SSO نفاذ</a>
        <a class="link" href="#/rbac">RBAC</a>
        <a class="link" href="#/config">مركز الإعدادات (Config)</a>
      </div>
      <div class="group">
        <h4>السياسات والمساعدة</h4>
        <a class="link" href="#/privacy">سياسة الخصوصية</a>
        <a class="link" href="#/child-protect">حماية الطفل والإبلاغ</a>
        <a class="link" href="#/help">مركز المساعدة</a>
      </div>
      <div class="group">
        <h4>أدوات</h4>
        <a class="link" href="#/export">تصدير</a>
      </div>
    </div>
  </nav>

  <section class="content" id="view"></section>
</main>

<footer>نمو NOMU — v3.4 (شعارات + تبويبات + حساب المراكز الصحية ومراكز الأحياء)</footer>

<script>
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
function route(){ const p=location.hash.slice(1)||'/intro'; $$('a.link').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===`#${p}`)); (routes[p]||intro)(); }
window.addEventListener('hashchange',route);

/* ========== 1) عن المنصة (مختصر هنا للحجم) ========= */
function intro(){ const v=$('#view'); v.innerHTML = `
  <div class="card">
    <div class="toolbar"><h2>عن منصة نمو (NOMU)</h2><span class="tag">منصة وطنية للطفولة المبكرة</span></div>
    <p>منصة وطنية رقمية متكاملة تمكّن التكامل بين الصحة والتعليم والدعم الاجتماعي عبر منظومة بيانات موحّدة، ونماذج تدخل مبكر، ولوحات مؤشرات وطنية.</p>
    <div class="grid two">
      <div class="callout"><b>الرؤية:</b> أن تكون المنصة الوطنية الأولى لتنمية الطفولة المبكرة وجودة حياة الطفل والأسرة.</div>
      <div class="callout"><b>الرسالة:</b> تمكين منظومة مترابطة تسهّل تقديم الخدمات وتتابع المؤشرات وتعزّز الشفافية والاستدامة.</div>
    </div>
    <ul>
      <li>نظام إحالات وطني، قياس أثر، تكامل نفاذ/NPHIES/نور.</li>
      <li>بوابة رعاة، وواجهات للحكومة والجمعيات والقطاع الخاص والأسرة.</li>
    </ul>
  </div>`; }

/* ========== 2) KPI Registry ========= */
const KPI_REGISTRY=[
  { id:'DEV_SCREEN', name:'نسبة تغطية الفحص النمائي', owner:'وزارة الصحة — الإدارة العامة لصحة الأم والطفل', formula:'المفحوصون ÷ المستهدفون (0–6) × 100', period:'شهري', source:'HealthAssessment' },
  { id:'SCHOOL_READY', name:'نسبة الجاهزية المدرسية', owner:'وزارة التعليم — الإدارة العامة للطفولة المبكرة', formula:'جاهزون ÷ إجمالي 5–6 × 100', period:'فصلي', source:'EducationPlan' },
  { id:'REF_TTR', name:'زمن الإحالة (يوم)', owner:'اللجنة الوطنية — الأمانة العامة', formula:'متوسط (تاريخ القبول − تاريخ الفتح)', period:'شهري', source:'Referral' },
  { id:'WAIT', name:'متوسط انتظار الخدمة (يوم)', owner:'الجهة المقدِّمة بإشراف اللجنة', formula:'متوسط (أول جلسة − قبول الإحالة)', period:'شهري', source:'ServiceSession' },
  { id:'CSR_FUNDS', name:'تمويل CSR (ر.س)', owner:'القطاع الخاص + إشراف المنصة', formula:'التعهدات المؤكدة + المحوّلة', period:'ربع سنوي', source:'CSRCommitment' },
  { id:'ACTIVE_REF', name:'الإحالات النشطة', owner:'اللجنة الوطنية — وحدة البيانات', formula:'الحالات المفتوحة − المغلقة', period:'يومي', source:'Referral' }
];
function kpiRegistryPage(){
  const v=$('#view');
  v.innerHTML=`
  <div class="card">
    <div class="toolbar"><h2>سجل تعريفات المؤشرات الوطنية (KPI)</h2><button class="ghost" id="dl">تنزيل JSON</button></div>
    <table>
      <thead><tr><th>المؤشر</th><th>المالك</th><th>الصيغة</th><th>الفترة</th><th>المصدر</th></tr></thead>
      <tbody>${KPI_REGISTRY.map(k=>`
        <tr><td><b>${k.name}</b><div class='note'>${k.id}</div></td>
            <td>${k.owner}</td><td>${k.formula}</td><td>${k.period}</td><td>${k.source}</td></tr>`).join('')}
      </tbody>
    </table>
  </div>`;
  $('#dl').onclick=()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(KPI_REGISTRY,null,2)],{type:'application/json'})); a.download='kpi_registry.json'; a.click(); };
}

/* ========== 3) الحسابات مع تبويبات تفاعلية ========= */
const ACCOUNTS={
  health:{ title:'وزارة الصحة', menus:['سجل الفحوص','التدخل المبكر','الإحالات','مطالبات NPHIES','تقارير'], fieldsByTab:{
      'سجل الفحوص':[
        {label:'رقم الملف الصحي (MRN)',key:'mrn'},{label:'نتيجة الفحص النمائي',key:'dev_result'},{label:'PHQ-2/9',key:'phq_score'},{label:'تشخيص ICD-10',key:'icd10'}
      ],
      'التدخل المبكر':[
        {label:'نوع التدخل',key:'intervention_type'},{label:'عدد الجلسات',key:'sessions'},{label:'موعد المتابعة',key:'followup_date'}
      ],
      'الإحالات':[
        {label:'جهة الإحالة',key:'ref_to'},{label:'أولوية الحالة',key:'priority'},{label:'مرفقات (رابط)',key:'attachments'}
      ],
      'مطالبات NPHIES':[
        {label:'رقم المطالبة',key:'claim_id'},{label:'الحالة',key:'claim_status'}
      ],
      'تقارير':[]
    ], adapter:'/api/health' },
  clinic:{ title:'المراكز الصحية', menus:['المواعيد','الإحالات','الخدمات','التقارير'], fieldsByTab:{
      'المواعيد':[
        {label:'رقم السجل',key:'mrn'},{label:'التخصص',key:'specialty'},{label:'موعد (تاريخ/ساعة)',key:'appt_datetime'}
      ],
      'الإحالات':[
        {label:'من جهة',key:'ref_from'},{label:'حالة الإحالة',key:'ref_status'}
      ],
      'الخدمات':[
        {label:'اسم الخدمة',key:'service'},{label:'SLA أيام',key:'sla_days'}
      ],
      'التقارير':[]
    ], adapter:'/api/clinic' },
  education:{ title:'وزارة التعليم', menus:['جاهزية المدرسة','IEP/دمج','الإحالات','تواصل الأسرة','تقارير نور'], fieldsByTab:{
      'جاهزية المدرسة':[
        {label:'درجة الجاهزية',key:'readiness_score'},{label:'المستوى/المدرسة',key:'school_name'}
      ],
      'IEP/دمج':[
        {label:'خطة IEP (JSON)',key:'iep_json'},{label:'نوع الدمج',key:'inclusion_type'}
      ],
      'الإحالات':[
        {label:'إلى جهة',key:'ref_to'},{label:'مرفقات',key:'attachments'}
      ],
      'تواصل الأسرة':[
        {label:'رقم ولي الأمر',key:'guardian_id'},{label:'القناة',key:'channel'}
      ],
      'تقارير نور':[]
    ], adapter:'/api/education' },
  neighborhood:{ title:'مراكز الأحياء', menus:['البرامج المجتمعية','المتطوعون','الحجوزات','الإحالات','التقارير'], fieldsByTab:{
      'البرامج المجتمعية':[
        {label:'اسم البرنامج',key:'program'},{label:'الفئة العمرية',key:'age_band'},{label:'الطاقة الاستيعابية',key:'capacity'}
      ],
      'المتطوعون':[
        {label:'اسم المتطوع',key:'vol_name'},{label:'ساعات التطوع',key:'vol_hours'}
      ],
      'الحجوزات':[
        {label:'تاريخ',key:'date'},{label:'عدد المقاعد',key:'seats'}
      ],
      'الإحالات':[
        {label:'من/إلى',key:'ref_direction'},{label:'الحالة',key:'status'}
      ],
      'التقارير':[]
    ], adapter:'/api/neighborhood' },
  nonprofit:{ title:'الجمعيات', menus:['البرامج','المستفيدون','المتطوعون','الإحالات','قياس الأثر'], fieldsByTab:{
      'البرامج':[
        {label:'اسم البرنامج',key:'program'},{label:'عدد الجلسات',key:'sessions'}
      ],
      'المستفيدون':[
        {label:'هوية ولي الأمر',key:'guardian_id'},{label:'المنطقة',key:'region'}
      ],
      'المتطوعون':[
        {label:'اسم المتطوع',key:'vol_name'},{label:'ساعات التطوع',key:'hours'}
      ],
      'الإحالات':[
        {label:'إلى جهة',key:'ref_to'},{label:'الحالة',key:'status'}
      ],
      'قياس الأثر':[
        {label:'تحسن الطفل (%)',key:'improve_pct'}
      ]
    ], adapter:'/api/nonprofit' },
  hr:{ title:'الموارد البشرية', menus:['محفظة الدعم','التطوع الوطني','التقارير'], fieldsByTab:{
      'محفظة الدعم':[
        {label:'نوع الدعم',key:'support_type'},{label:'المبلغ/الشهر',key:'amount'},{label:'أهلية الأسرة',key:'eligibility'}
      ],
      'التطوع الوطني':[
        {label:'المبادرة',key:'initiative'},{label:'الساعات',key:'hours'}
      ],
      'التقارير':[]
    ], adapter:'/api/hr' },
  csr:{ title:'القطاع الخاص (CSR)', menus:['سوق الرعاية','تعهدات الشركة','تقارير الأثر','حوكمة CSR'], fieldsByTab:{
      'سوق الرعاية':[
        {label:'اسم الشركة',key:'company'},{label:'الفئة',key:'tier'},{label:'المنطقة',key:'region'}
      ],
      'تعهدات الشركة':[
        {label:'قيمة التعهد',key:'amount'},{label:'الغرض',key:'purpose'}
      ],
      'تقارير الأثر':[], 'حوكمة CSR':[]
    ], adapter:'/api/csr' },
  family:{ title:'حساب الأسرة', menus:['ملف الحمل والطفل','المواعيد','التوصيات','الخدمات المساندة'], fieldsByTab:{
      'ملف الحمل والطفل':[
        {label:'هوية ولي الأمر',key:'guardian_id'},{label:'المنطقة',key:'region'},{label:'موافقة مشاركة البيانات',key:'consent'}
      ],
      'المواعيد':[
        {label:'الخدمة',key:'service'},{label:'موعد',key:'date'}
      ],
      'التوصيات':[], 'الخدمات المساندة':[]
    ], adapter:'/api/family' },
  admin:{ title:'اللجنة الوطنية', menus:['لوحة وطنية','حوكمة البيانات','التكاملات','التقارير الوطنية'], fieldsByTab:{
      'لوحة وطنية':[],
      'حوكمة البيانات':[
        {label:'قرار سياسة',key:'policy_decision'}
      ],
      'التكاملات':[
        {label:'تعريف KPI',key:'kpi_def'}
      ],
      'التقارير الوطنية':[]
    ], adapter:'/api/admin' }
};

function accountPage(key){
  const A=ACCOUNTS[key]; const v=$('#view');
  const tabs = A.menus;
  const tabButtons = tabs.map((t,i)=>`<button class="tab ${i===0?'active':''}" data-tab="${t}">${t}</button>`).join('');
  v.innerHTML = `
    <div class="card">
      <div class="toolbar"><h2>${A.title}</h2><span class="tag">قوائم تبويبية تفاعلية</span></div>
      <div class="tabs">${tabButtons}</div>
      <div id="tabpanel" class="tabpanel"></div>
      <div style="margin-top:10px">
        <button class="btn" id="save">حفظ (توضيحي)</button>
        <button class="ghost" id="push">إرسال للواجهة البرمجية</button>
      </div>
      <div class="note" style="margin-top:8px">مسار الربط: <code>${A.adapter}</code></div>
    </div>`;
  const renderTab=(name)=>{
    const fields = A.fieldsByTab[name]||[];
    $('#tabpanel').innerHTML = fields.length
      ? `<div class="form grid two">${fields.map(f=>`<label>${f.label}<input data-key="${f.key}" placeholder="${f.key}"/></label>`).join('')}</div>`
      : `<div class="note">لا توجد حقول لهذا القسم حاليًا — يمكنك ربطه بتقارير ولوحات.</div>`;
  };
  renderTab(tabs[0]);
  $$('.tab',v).forEach(btn=>btn.onclick=(e)=>{ $$('.tab',v).forEach(b=>b.classList.remove('active')); e.currentTarget.classList.add('active'); renderTab(e.currentTarget.dataset.tab); });
  $('#save').onclick=()=>alert('تم الحفظ محليًا (توضيحي)');
  $('#push').onclick=()=>{ const inputs = $$('#tabpanel [data-key]'); const payload={entity:key, section:$('.tab.active').dataset.tab, data:Object.fromEntries(inputs.map(i=>[i.dataset.key,i.value]))}; alert('POST '+A.adapter+'\\n'+JSON.stringify(payload,null,2)); };
}

/* ========== 4) بوابة الرعاة ========= */
const SPONSOR_PLANS=[
  {tier:'ماسي (Diamond)', price:'— ر.س / سنة', perks:['الشعار في كل صفحات المنصة','تقرير أثر ربع سنوي','أولوية تسمية مبادرات','مقعد مجلس الرعاة']},
  {tier:'ذهبي (Gold)', price:'— ر.س / سنة', perks:['الشعار في الصفحات الرئيسية','تقارير نصف سنوية','دعوات الفعاليات']},
  {tier:'فضي (Silver)', price:'— ر.س / سنة', perks:['الشعار في صفحة الرعاة','شارة تقدير في التقارير']}
];
function sponsorsPage(){
  const v=$('#view'); v.innerHTML=`
  <div class="card">
    <div class="toolbar"><h2>بوابة الرعاة</h2><span class="tag">التسعير وحقوق استخدام الهوية</span></div>
    <div class="three grid">
      ${SPONSOR_PLANS.map(p=>`<div class='card'><h3>${p.tier}</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>${p.price}</div><ul>${p.perks.map(x=>`<li>${x}</li>`).join('')}</ul></div>`).join('')}
    </div>
    <h3>طلب رعاية</h3>
    <div class="grid two form">
      <label>اسم الجهة<input id="sp_org"/></label>
      <label>البريد الإلكتروني<input id="sp_mail"/></label>
      <label>فئة الرعاية<select id="sp_tier"><option>Diamond</option><option>Gold</option><option>Silver</option></select></label>
      <label>المنطقة<select id="sp_region"><option>على مستوى المملكة</option><option>الرياض</option><option>الشرقية</option><option>حائل</option></select></label>
    </div>
    <label style="display:block;margin-top:8px">ملاحظات<textarea id="sp_msg" class="form" style="width:100%;min-height:100px"></textarea></label>
    <div style="margin-top:10px"><button class="btn" id="gen">إنشاء اتفاقية رعاية قابلة للطباعة</button></div>
    <div class="card" id="agreement" style="display:none;margin-top:12px"></div>
  </div>`;
  $('#gen').onclick=()=>{ const org=$('#sp_org').value||'____'; const tier=$('#sp_tier').value; const region=$('#sp_region').value; const today=new Date().toLocaleDateString('ar-SA'); $('#agreement').style.display='block'; $('#agreement').innerHTML=`
    <h3 style='margin-top:0'>اتفاقية رعاية منصة نمو</h3>
    <p>تم في تاريخ <b>${today}</b> بين منصة <b>نمو NOMU</b> والجهة الراعية <b>${org}</b> بصفة <b>${tier}</b> لمنطقة <b>${region}</b>.</p>
    <ul><li>حقوق استخدام الهوية</li><li>التقارير الربع/نصف سنوية</li><li>الامتثال والشفافية</li></ul>
    <button class='ghost' onclick='window.print()'>طباعة / حفظ PDF</button>
  `; };
}

/* ========== 5) SSO + RBAC + Config (مختزل) ========= */
const DEFAULT_CONFIG={
  sso:{ issuer:'https://nafath.example.gov.sa', authorize_url:'https://nafath.example.gov.sa/authorize', token_url:'https://nafath.example.gov.sa/token', client_id:'NOMU-CLIENT-ID', redirect_uri:'https://nomu.gov.sa/callback' },
  apis:{ nphies_base:'https://api.nphies.sa/v1', noor_base:'https://api.noor.moe.sa/v1', csr_base:'https://api.csr.sa/v1',
    internal:{ health:'/api/health', clinic:'/api/clinic', education:'/api/education', neighborhood:'/api/neighborhood', nonprofit:'/api/nonprofit', hr:'/api/hr', csr:'/api/csr', family:'/api/family', admin:'/api/admin' } }
};
const loadConfig=()=>{ try{ return JSON.parse(localStorage.getItem('nomu_config')||'null') || DEFAULT_CONFIG }catch(e){ return DEFAULT_CONFIG } };
const saveConfig=(cfg)=>{ localStorage.setItem('nomu_config', JSON.stringify(cfg)); alert('تم حفظ الإعدادات'); };
const downloadJSON=(name,obj)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'})); a.download=name; a.click(); };

function ssoPage(){ const v=$('#view'); const cfg=loadConfig(); v.innerHTML=`
  <div class="card"><div class="toolbar"><h2>النفاذ الموحّد (SSO نفاذ)</h2><span class="tag">OIDC — تجريبي</span></div>
  <p>ISSUER: <code>${cfg.sso.issuer}</code> • AUTHZ: <code>${cfg.sso.authorize_url}</code> • TOKEN: <code>${cfg.sso.token_url}</code></p>
  <button class="btn" id="nafath">الدخول عبر نفاذ</button>
  <pre id="ssoLog" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>`;
  $('#nafath').onclick=()=>{ const mockId='USR-'+Math.random().toString(36).slice(2,8).toUpperCase();
    $('#ssoLog').textContent='→ تبادل الكود → id_token\\nUserID: '+mockId+'\\nRoles: ["clinic.staff","referral.write"]';
  };
}

let RBAC={ roles:{
  'health.practitioner':['child.read','health.write','referral.send','kpi.view'],
  'clinic.staff':['child.read','appointment.manage','referral.accept','kpi.view'],
  'education.specialist':['child.read','education.write','referral.accept','kpi.view'],
  'neighborhood.coordinator':['program.manage','booking.manage','referral.accept','kpi.view'],
  'nonprofit.worker':['child.read','service.write','referral.accept','kpi.view'],
  'admin.national':['kpi.view','kpi.define','policy.write','audit.read'],
  'family.guardian':['child.own','consent.grant','appointment.book']
}};
function rbacPage(){ const v=$('#view'); const allPerms=Array.from(new Set(Object.values(RBAC.roles).flat()));
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>صلاحيات RBAC</h2><span class="tag">تحرير وتقييم</span></div>
  <div class="grid two">
    <div><h3>الأدوار</h3>${Object.entries(RBAC.roles).map(([r,ps])=>`<div class='pill'><b>${r}</b>: ${ps.join(', ')}</div>`).join('')}
      <div class="form" style="margin-top:10px"><label>دور<input id="newRole" placeholder="entity.role"/></label>
      <label>امتيازات (بفواصل)<input id="newPerms" placeholder="appointment.manage, referral.accept"/></label>
      <button class="btn" id="addRole">حفظ</button><button class="ghost" id="exportRBAC">تصدير</button></div>
    </div>
    <div><h3>تقييم</h3><div class="form">
      <label>الدور<select id="roleSel">${Object.keys(RBAC.roles).map(r=>`<option>${r}</option>`).join('')}</select></label>
      <label>الامتياز<select id="permSel">${allPerms.map(p=>`<option>${p}</option>`).join('')}</select></label>
      <label>موافقة PDPL؟ <select id="consSel"><option value="true">نعم</option><option value="false">لا</option></select></label></div>
      <button class="btn" id="eval" style="margin-top:10px">تقييم</button>
      <pre id="rbacOut" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>
  </div></div>`;
  $('#addRole').onclick=()=>{ const r=$('#newRole').value.trim(); if(!r) return; const perms=$('#newPerms').value.split(',').map(s=>s.trim()).filter(Boolean); RBAC.roles[r]=perms; alert('تم'); location.hash='#/rbac'; };
  $('#exportRBAC').onclick=()=>downloadJSON('rbac_policy.json', RBAC);
  $('#eval').onclick=()=>{ const role=$('#roleSel').value; const perm=$('#permSel').value; const consent=$('#consSel').value==='true';
    const allowed=(RBAC.roles[role]||[]).includes(perm) && (perm!=='child.read' || consent || role==='admin.national');
    $('#rbacOut').textContent=(allowed?'✅ مسموح':'⛔ مرفوض')+'\\nالدور: '+role+'\\nالامتياز: '+perm+'\\nالموافقة: '+consent;
  };
}

function configPage(){ const v=$('#view'); const cfg=loadConfig();
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>مركز الإعدادات (Config)</h2><span class="tag">Endpoints</span></div>
  <div class="grid two form">
    <label>SSO Issuer<input id="issuer" value="${cfg.sso.issuer}"/></label>
    <label>Authorize URL<input id="authz" value="${cfg.sso.authorize_url}"/></label>
    <label>Token URL<input id="token" value="${cfg.sso.token_url}"/></label>
    <label>Client ID<input id="cid" value="${cfg.sso.client_id}"/></label>
    <label>Redirect URI<input id="redir" value="${cfg.sso.redirect_uri}"/></label>
  </div>
  <h3>مسارات داخلية (Adapters)</h3>
  <div class="grid two form">
    ${Object.entries(cfg.apis.internal).map(([k,v2])=>`<label>${k}<input data-int="${k}" value="${v2}"/></label>`).join('')}
  </div>
  <div style="margin-top:10px"><button class="btn" id="saveCfg">حفظ</button><button class="ghost" id="dlCfg">تنزيل config.json</button></div></div>`;
  $('#saveCfg').onclick=()=>{ const next={ sso:{ issuer:$('#issuer').value, authorize_url:$('#authz').value, token_url:$('#token').value, client_id:$('#cid').value, redirect_uri:$('#redir').value },
    apis:{...cfg.apis, internal:Object.fromEntries($$('[data-int]').map(i=>[i.dataset.int,i.value])) } }; saveConfig(next); };
  $('#dlCfg').onclick=()=>downloadJSON('config.json', loadConfig());
}

/* ========== 6) سياسات + مساعدة ========= */
function privacyPage(){ const v=$('#view'); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>سياسة الخصوصية وحماية البيانات (PDPL)</h2><span class="tag">نسخة تنفيذية</span></div>
  <ul><li>الموافقة الصريحة لولي الأمر</li><li>الحد الأدنى من النفاذ</li><li>تشفير وحوكمة وصول</li><li>حقوق الاطلاع/التصحيح/السحب/الحذف</li></ul>
  <button class="ghost" onclick="window.print()">طباعة</button></div>`; }
function childProtectPage(){ const v=$('#view'); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>سياسة حماية الطفل والإبلاغ</h2><span class="tag">سلامة الطفل أولًا</span></div>
  <ol><li>توثيق الواقعة</li><li>تقييم المخاطر</li><li>إحالة للجهة المختصة ومتابعة الحالة</li></ol>
  <div class="callout">قناة الإبلاغ الداخلية متاحة لحسابات الممارسين المخولين.</div>
  <button class="ghost" onclick="window.print()">طباعة النموذج</button></div>`; }
function helpCenterPage(){ const v=$('#view'); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>مركز المساعدة</h2><span class="tag">الدعم والإرشاد</span></div>
  <details open><summary><b>التبويبات كيف تعمل؟</b></summary><p>انقر اسم القسم لعرض حقوله وإرسال بياناته لمسار الواجهة البرمجية الخاص بالحساب.</p></details>
  <details><summary><b>كيف أخصص الحقول؟</b></summary><p>من "مركز الإعدادات" حدّث خرائط الحقول ومسارات الـ API ثم جرّب الإرسال من التبويب.</p></details>
</div>`; }

/* ========== 7) Export ========= */
function exportPage(){ const v=$('#view'); v.innerHTML=`
  <div class="card"><h2>تصدير</h2>
  <button class="btn" id="kjson">KPI Registry</button>
  <button class="ghost" id="rjson">RBAC</button>
  <button class="ghost" id="cfg">Config</button></div>`;
  $('#kjson').onclick=()=>downloadJSON('kpi_registry.json', KPI_REGISTRY);
  $('#rjson').onclick=()=>downloadJSON('rbac_policy.json', RBAC);
  $('#cfg').onclick=()=>downloadJSON('config.json', loadConfig());
}

/* ========== 8) Router ========= */
const routes={
  '/intro':intro,'/kpi-registry':kpiRegistryPage,'/sponsors':sponsorsPage,'/sso':ssoPage,'/rbac':rbacPage,'/config':configPage,'/export':exportPage,
  '/privacy':privacyPage,'/child-protect':childProtectPage,'/help':helpCenterPage,
  '/acc/health':()=>accountPage('health'),'/acc/clinic':()=>accountPage('clinic'),'/acc/education':()=>accountPage('education'),
  '/acc/neighborhood':()=>accountPage('neighborhood'),'/acc/nonprofit':()=>accountPage('nonprofit'),
  '/acc/hr':()=>accountPage('hr'),'/acc/csr':()=>accountPage('csr'),'/acc/family':()=>accountPage('family'),'/acc/admin':()=>accountPage('admin')
};
if(!location.hash) location.hash = '#/intro';
route();
</script>
</body>
</html>
